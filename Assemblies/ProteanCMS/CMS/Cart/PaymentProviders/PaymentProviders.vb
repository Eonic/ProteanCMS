Option Strict Off
Option Explicit On
Imports System.Xml
Imports System.Web.HttpUtility
Imports VB = Microsoft.VisualBasic

Imports Protean.xForm
Imports System.Web.Mail
Imports System.Web.Configuration
Imports System.IO
Imports System.Net
Imports System.Net.Sockets
Imports System.Text
Imports System.Text.RegularExpressions
'Imports Protx.Vsp
Imports System.Data.SqlClient
Imports System.Net.Mail

Imports System.CodeDom.Compiler
Imports Microsoft.VisualBasic
Imports System.Reflection
Imports System

Imports Newtonsoft.Json.Linq
Imports Newtonsoft.Json
Imports System.Collections.Generic

' NOTES NEED TO MAKE CHANGES TO PAYPAL CODE GENERATED BY WSRP reference.vb http://stackoverflow.com/questions/27380146/unable-to-generate-a-temporary-class-result-1-error-cs0030

'In your generated Web service file, Do a find For ()() And replace all occurrences With (). The bad guy seems To be the merchantDataField In the PaymentDetailsType.
'It seems To be a bug In the Microsoft WSDL tools When interacting With services that have "nested nodes with the maxOccurs attribute set to unbounded".

Partial Public Class Cms
    Partial Public Class Cart
        Public Class PaymentProviders
            Inherits xForm

            Protected Const mcModuleName As String = "PaymentProviders"
            Public moCartConfig As System.Collections.Specialized.NameValueCollection = WebConfigurationManager.GetWebApplicationSection("protean/cart")

            Public Shadows moPageXml As XmlDocument
            Public mcEwDataConn As String
            Public mnPaymentAmount As Double
            Public mnPaymentMaxAmount As Double = 0.0#
            Public mcPaymentType As String = "Normal"
            Public mcPaymentOrderDescription As String
            Public mcCardHolderName As String
            Public mcCardHolderAddress As String
            Public moBillingContact As XmlElement
            Public mcCardHolderPostcode As String
            Public mcCurrency As String
            Public mdFulfillmentDate As Date
            Public savedPaymentId As Long

            Public mcCurrencySymbol As String
            Public mnCartId As Integer
            Public mcOrderRef As String

            Public mcCartEmailXslt As String ' Template for sending emails
            Public mcCartEmailTextXslt As String ' Template for sending text emails
            Public mcCartEmailAddress As String ' Address to send order notifications
            Public mbSendConfirmationToDeliveryEmail As Boolean
            Public mbAddItemWithNoPrice As Boolean ' Switch to allow enquiries of items with no price
            Public mcPagePath As String ' page path to add to form submissions

            Public modbHelper As dbHelper

            Public mnProcessIdOnComplete As Cart.cartProcess = cartProcess.Complete

            Protected moPaymentCfg As XmlNode

            Shadows myWeb As Cms

            Private nTransactionMode As TransactionMode

            'Public WithEvents oePDQ As ePDQ = Nothing

            Private paypointScheduleIntervals() As String = {"yearly", "half-yearly", "quarterly", "monthly", "weekly", "daily"}


            Enum TransactionMode
                Live = 0
                Test = 1
                Fail = 2
            End Enum


            Public Sub New(ByRef aWeb As Protean.Cms)
                PerfMon.Log("PaymentProviders", "New")
                Dim cProcessInfo As String = ""
                Try
                    myWeb = aWeb
                    moPageXml = myWeb.moPageXml
                    modbHelper = myWeb.moDbHelper
                    moPaymentCfg = WebConfigurationManager.GetWebApplicationSection("protean/payment")
                    MyBase.moPageXML = myWeb.moPageXml

                Catch ex As Exception
                    returnException(mcModuleName, "Close", ex, "", cProcessInfo, gbDebug)
                End Try
            End Sub

            WriteOnly Property setPageXML() As XmlDocument
                Set(ByVal Value As XmlDocument)
                    moPageXml = Value
                End Set
            End Property


            Property SetTransactionMode As TransactionMode
                Set(ByVal Value As TransactionMode)
                    nTransactionMode = Value
                End Set
                Get
                    Return nTransactionMode
                End Get
            End Property


            'Private Sub _OnError(ByVal sender As Object, ByVal e As Protean.Tools.Errors.ErrorEventArgs) Handles oePDQ.OnError
            '    returnException(e.ModuleName, e.ProcedureName, e.Exception, "", e.AddtionalInformation, gbDebug)
            'End Sub

            Public Overridable Function getPaymentMethods(ByRef oOptXform As xForm, ByRef oSelectElmt As XmlElement, ByVal nPaymentAmount As Double, ByRef cPaymentMethod As String) As Integer
                PerfMon.Log("PaymentProviders", "getPaymentMethods")
                Dim cProcessInfo As String = "getPaymentMethods"
                Dim oElmt As XmlElement
                Dim bFirstRow As Boolean = True
                Try

                    Dim nOptCount As Integer = 0

                    For Each oElmt In moPaymentCfg.SelectNodes("provider")

                        Dim bAllowUser As Boolean = False
                        Dim bAllowCurrencies As Boolean = False
                        If oElmt.GetAttribute("validGroups") = "all" Then
                            bAllowUser = True
                        Else
                            Dim aGroups() As String = Split(oElmt.GetAttribute("validGroups"), ",")
                            Dim i As Integer
                            For i = 0 To UBound(aGroups)
                                If modbHelper.checkUserRole(aGroups(i), "Group") Then
                                    bAllowUser = True
                                End If
                            Next
                        End If

                        If oElmt.GetAttribute("invalidGroups") <> "" Then
                            Dim aInvalidGroups() As String = Split(oElmt.GetAttribute("invalidGroups"), ",")
                            Dim i2 As Integer
                            For i2 = 0 To UBound(aInvalidGroups)
                                If modbHelper.checkUserRole(aInvalidGroups(i2), "Group") Then
                                    bAllowUser = False
                                End If
                            Next
                        End If

                        If oElmt.GetAttribute("validCurrencies") = "all" Or oElmt.GetAttribute("validCurrencies") = "" Then
                            bAllowCurrencies = True
                        Else
                            Dim aCurs() As String = Split(oElmt.GetAttribute("validCurrencies"), ",")
                            Dim i As Integer
                            For i = 0 To UBound(aCurs)
                                If aCurs(i) = mcCurrency Then
                                    bAllowCurrencies = True
                                Else
                                    bAllowCurrencies = False
                                End If
                            Next
                        End If
                        If bAllowUser And bAllowCurrencies Then
                            Select Case oElmt.GetAttribute("name")
                                Case "PremiumCredit"
                                    'Get the Premium Credit Payment Options
                                    nOptCount = nOptCount + getPremiumCreditPaymentMethods(oOptXform, oSelectElmt, nPaymentAmount, cPaymentMethod)

                                Case Else
                                    If Not String.IsNullOrEmpty(cPaymentMethod) Then
                                        Dim cRequestedPaymentMethod As String = "" + myWeb.moRequest("cPaymentMethod")
                                        If Not String.IsNullOrEmpty(cRequestedPaymentMethod) Then
                                            If Not cPaymentMethod.Equals(cRequestedPaymentMethod) Then
                                                cPaymentMethod = cRequestedPaymentMethod
                                            End If
                                        End If
                                    End If
                                    Dim PaymentLabel As String = oElmt.SelectSingleNode("description/@value").InnerText
                                    'allow html in description node...
                                    Dim bXmlLabel As Boolean = False
                                    If oElmt.SelectSingleNode("description").InnerXml <> "" Then
                                        PaymentLabel = oElmt.SelectSingleNode("description").InnerXml
                                        bXmlLabel = True
                                    End If
                                    oOptXform.addOption(oSelectElmt, PaymentLabel, oElmt.GetAttribute("name"), bXmlLabel)
                                    nOptCount = nOptCount + 1
                            End Select


                            If bFirstRow Then
                                If Not oOptXform.Instance.SelectSingleNode("cPaymentMethod") Is Nothing Then
                                    oOptXform.Instance.SelectSingleNode("cPaymentMethod").InnerText = oElmt.GetAttribute("name")
                                End If
                            End If

                            bFirstRow = False

                        End If

                        Dim oSavePayment As XmlElement = oElmt.SelectSingleNode("allowSavePayment")
                        If Not oSavePayment Is Nothing Then
                            If oSavePayment.GetAttribute("value") = "on" Then
                                ReturnRepeatPayments(oElmt.GetAttribute("name"), oOptXform, oSelectElmt)
                            End If
                        End If

                    Next

                    Return nOptCount

                Catch ex As Exception
                    returnException(mcModuleName, "getPaymentMethods", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function


            Public Overridable Function getPaymentMethodButtons(ByRef oOptXform As xForm, ByRef oFrmElmt As XmlElement, ByVal nPaymentAmount As Double) As Integer
                PerfMon.Log("PaymentProviders", "getPaymentMethods")
                Dim cProcessInfo As String = "getPaymentMethods"
                Dim oElmt As XmlElement
                Dim bFirstRow As Boolean = True
                Try

                    Dim submissionValue As String = ""
                    Dim refValue As String = ""
                    'find existing submit and delete
                    Dim oSubmitBtn As XmlElement = oOptXform.RootGroup.SelectSingleNode("descendant::submit")
                    If Not oSubmitBtn Is Nothing Then
                        submissionValue = oSubmitBtn.GetAttribute("submission")
                        refValue = oSubmitBtn.GetAttribute("ref")
                        oSubmitBtn.ParentNode.RemoveChild(oSubmitBtn)
                    End If

                    Dim nOptCount As Integer = 0

                    For Each oElmt In moPaymentCfg.SelectNodes("provider")

                        Dim bAllowUser As Boolean = False
                        Dim bAllowCurrencies As Boolean = False

                        If oElmt.GetAttribute("validGroups") = "all" Then
                            bAllowUser = True
                        Else
                            Dim aGroups() As String = Split(oElmt.GetAttribute("validGroups"), ",")
                            Dim i As Integer
                            For i = 0 To UBound(aGroups)
                                If modbHelper.checkUserRole(aGroups(i), "Group") Then
                                    bAllowUser = True
                                End If
                            Next
                        End If

                        'Allow preview users to use additional payment methods
                        If CLng("0" & myWeb.moSession("nUserId")) > 0 Then
                            Dim aGroups() As String = Split(oElmt.GetAttribute("validGroups"), ",")
                            Dim aInvalidGroups() As String = Split(oElmt.GetAttribute("invalidGroups"), ",")
                            Dim i As Integer
                            Dim i2 As Integer
                            For i = 0 To UBound(aGroups)
                                If modbHelper.checkUserRole(aGroups(i), "Group", CLng(myWeb.moSession("nUserId"))) Then
                                    bAllowUser = True
                                End If
                                If modbHelper.checkUserRole(aGroups(i), "Role", CLng(myWeb.moSession("nUserId"))) Then
                                    bAllowUser = True
                                End If
                            Next
                            For i2 = 0 To UBound(aInvalidGroups)
                                If modbHelper.checkUserRole(aInvalidGroups(i2), "Group", CLng(myWeb.moSession("nUserId"))) Then
                                    bAllowUser = False
                                End If
                                If modbHelper.checkUserRole(aInvalidGroups(i2), "Role", CLng(myWeb.moSession("nUserId"))) Then
                                    bAllowUser = False
                                End If
                            Next
                        End If

                        If oElmt.GetAttribute("invalidGroups") <> "" Then
                            Dim aInvalidGroups() As String = Split(oElmt.GetAttribute("invalidGroups"), ",")
                            Dim i2 As Integer
                            For i2 = 0 To UBound(aInvalidGroups)
                                If modbHelper.checkUserRole(aInvalidGroups(i2), "Group") Then
                                    bAllowUser = False
                                End If
                            Next
                        End If

                        If oElmt.GetAttribute("validCurrencies") = "all" Or oElmt.GetAttribute("validCurrencies") = "" Then
                            bAllowCurrencies = True
                        Else
                            Dim aCurs() As String = Split(oElmt.GetAttribute("validCurrencies"), ",")
                            Dim i As Integer
                            For i = 0 To UBound(aCurs)
                                If aCurs(i) = mcCurrency Then
                                    bAllowCurrencies = True
                                Else
                                    bAllowCurrencies = False
                                End If
                            Next
                        End If

                        If bAllowUser And bAllowCurrencies Then

                            Dim PaymentLabel As String = oElmt.SelectSingleNode("description/@value").InnerText
                            'allow html in description node...
                            Dim bXmlLabel As Boolean = False

                            If oElmt.SelectSingleNode("description").InnerXml <> "" Then
                                PaymentLabel = oElmt.SelectSingleNode("description").InnerXml
                                bXmlLabel = True
                            End If

                            Dim iconclass As String = ""
                            If Not oElmt.SelectSingleNode("icon/@value") Is Nothing Then
                                iconclass = oElmt.SelectSingleNode("icon/@value").InnerText
                            End If


                            Dim oPayProv As New Providers.Payment.BaseProvider(myWeb, oElmt.GetAttribute("name"))
                            oPayProv.Activities.AddPaymentButton(oOptXform, oFrmElmt, oElmt, nPaymentAmount, submissionValue, refValue)


                            'Add new submits
                            ' oOptXform.addSubmit(oFrmElmt, submissionValue, PaymentLabel, refValue, "pay-button pay-" & oElmt.GetAttribute("name"), iconclass, oElmt.GetAttribute("name"))
                            nOptCount = nOptCount + 1

                        End If
                    Next


                    Return nOptCount

                Catch ex As Exception
                    returnException(mcModuleName, "getPaymentMethods", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySecPay(ByRef oRoot As XmlElement, ByVal sSubmitPath As String, Optional ByVal sProfile As String = "") As xForm
                PerfMon.Log("PaymentProviders", "paySecPay")
                Dim sSql As String

                Dim ccXform As xForm

                Dim Xform3dSec As xForm = Nothing

                Dim bIsValid As Boolean
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim aResponse() As String
                Dim oDictResp As Hashtable
                Dim cResponse As String

                Dim oDictOpt As Hashtable = New Hashtable

                Dim i As Integer
                Dim nPos As Integer
                Dim sOpts As String
                Dim cOrderType As String
                Dim bCv2 As Boolean = False
                Dim b3DSecure As Boolean = False
                Dim b3DAuthorised As Boolean = False
                Dim sRedirectURL As String = ""
                Dim sPaymentRef As String = ""

                Dim cProcessInfo As String = "paySecPay"

                'Get the payment options into a hashtable
                Dim oSecpayCfg As XmlNode
                Dim bSavePayment As Boolean = False
                Dim bAllowSavePayment As Boolean = False

                Try
                    If sProfile <> "" Then
                        oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecPay' and @profile='" & sProfile & "']")
                    Else
                        oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecPay']")
                    End If

                    ' Get the payment options
                    'oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecPay']")
                    oDictOpt = xmlTools.xmlToHashTable(oSecpayCfg, "value")

                    Select Case oDictOpt("opperationMode")
                        Case "true"
                            nTransactionMode = TransactionMode.Test
                        Case "false"
                            nTransactionMode = TransactionMode.Fail
                        Case "live"
                            nTransactionMode = TransactionMode.Live
                    End Select

                    ' override the currency
                    If oDictOpt.ContainsKey("currency") Then oDictOpt.Remove("currency")
                    oDictOpt.Add("currency", mcCurrency)

                    ' Set common variables
                    If oDictOpt("validateCV2") = "on" Then bCv2 = True
                    If oDictOpt("secure3d") = "on" Then b3DSecure = True

                    If oDictOpt("allowSavePayment") = "on" Then bAllowSavePayment = True

                    'Load the Xform

                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("cardsAccepted"), bCv2, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("currency") & " by Credit/Debit Card", b3DSecure, , , bAllowSavePayment)

                    If b3DSecure Then
                        'check for return from aquiring bank
                        If goRequest("MD") <> "" Then
                            b3DAuthorised = True
                        End If
                    End If

                    If ccXform.valid Or b3DAuthorised Then


                        ' Set up card options
                        sOpts = "test_status=" & oDictOpt("opperationMode")
                        sOpts = sOpts & ",dups=false,card_type=" & goRequest("creditCard/type")

                        ' Account for scheduled payments from the payment config.
                        Dim scheduleInterval As String = (oDictOpt("scheduleInterval") & "").ToLower
                        Dim scheduleMaxRepeats As String = oDictOpt("scheduleMaxRepeats") & ""
                        If Not String.IsNullOrEmpty(scheduleInterval) _
                            AndAlso Array.IndexOf(paypointScheduleIntervals, scheduleInterval) >= 0 Then


                            Dim maxRepeats As Integer
                            If Not String.IsNullOrEmpty(scheduleMaxRepeats) _
                                AndAlso IsNumeric(scheduleMaxRepeats) _
                                AndAlso Convert.ToInt16(scheduleMaxRepeats) > 0 Then
                                maxRepeats = scheduleMaxRepeats
                            Else
                                maxRepeats = -1
                            End If

                            ' We need to send through an immediate payment - ie, the actual payment
                            ' and then schedule the same payment based on the interval
                            Dim scheduleDate As Date
                            Select Case scheduleInterval

                                Case "yearly"
                                    scheduleDate = Today.AddYears(1)
                                Case "half-yearly"
                                    scheduleDate = Today.AddMonths(6)
                                Case "quarterly"
                                    scheduleDate = Today.AddMonths(3)
                                Case "monthly"
                                    scheduleDate = Today.AddMonths(1)
                                Case "weekly"
                                    scheduleDate = Today.AddDays(7)
                                Case "daily"
                                    scheduleDate = Today.AddDays(1)
                            End Select

                            sOpts &= ",repeat=" & Format(scheduleDate, "yyyyMMdd")
                            sOpts &= "/" & scheduleInterval
                            sOpts &= "/" & maxRepeats.ToString
                            sOpts &= ":" & mnPaymentAmount.ToString

                        End If


                        ' Currency - if no currency then use GBP
                        If mcCurrency <> "" Then
                            sOpts = sOpts & ",currency=" & UCase(mcCurrency)
                        Else
                            sOpts = sOpts & ",currency=GBP"
                        End If

                        ' Optional - CV2
                        If bCv2 Then
                            sOpts = sOpts & ",cv2=" & goRequest("creditCard/CV2")
                        End If
                        ' Optional - 3DSecure
                        If oDictOpt("opperationMode") = "true" And b3DSecure Then
                            sOpts = sOpts & ",test_mpi_status=true"
                        End If

                        ' If test mode, then we must turn on cv2-avs checks - mandatory Visa mandate May 2009
                        If LCase(oDictOpt("opperationMode")) = "true" Or LCase(oDictOpt("opperationMode")) = "false" Then
                            sOpts = sOpts & ",default_cv2avs=ALL MATCH"
                        End If

                        If LCase(oDictOpt("transactionType")) = "defer" Or LCase(oDictOpt("transactionType")) = "deferred" Then
                            If IsNumeric(oDictOpt("ccDeferDays")) And IsNumeric(oDictOpt("dcDeferDays")) Then
                                sOpts &= ",deferred=reuse:" & oDictOpt("ccDeferDays") & ":" & oDictOpt("dcDeferDays")
                            Else
                                sOpts &= ",deferred=true"
                            End If

                        End If
                        If oDictOpt("digest") = "on" Then
                            Dim cDigest As String = ""
                            If Not oDictOpt("accountId") = "secpay" Then
                                cDigest = CStr(mnCartId) & CStr(mnPaymentAmount) & CStr(oDictOpt("accountPassword"))
                            Else
                                cDigest = "secpay"
                            End If
                            Dim encode As New System.Text.UnicodeEncoding
                            Dim inputDigest() As Byte = encode.GetBytes(cDigest)

                            Dim hash() As Byte
                            ' get hash
                            Dim md5 As New System.Security.Cryptography.MD5CryptoServiceProvider
                            hash = md5.ComputeHash(inputDigest)

                            ' convert hash value to hex string
                            Dim sb As New System.Text.StringBuilder
                            Dim outputByte As Byte
                            For Each outputByte In hash
                                ' convert each byte to a Hexadecimal upper case string
                                sb.Append(outputByte.ToString("x2"))
                            Next outputByte

                            sOpts &= ",digest=" & sb.ToString

                        End If

                        Dim oSecVpn As Paypoint.SECVPNClient = New Paypoint.SECVPNClient

                        cOrderType = oRoot.GetAttribute("orderType")
                        If Not (cOrderType <> "" And CStr(oDictOpt("UseOrderType")) = "true") Then cOrderType = CStr(oDictOpt("accountId"))
                        If Not b3DSecure Then
                            cResponse = oSecVpn.validateCardFull(cOrderType,
                            CStr(oDictOpt("accountPassword")),
                            CStr(mnCartId),
                            goRequest.ServerVariables("REMOTE_ADDR"),
                            mcCardHolderName,
                            goRequest("creditCard/number"),
                            CStr(mnPaymentAmount),
                            fmtSecPayDate(goRequest("creditCard/expireDate")),
                            goRequest("creditCard/issueNumber"),
                            fmtSecPayDate(goRequest("creditCard/issueDate")),
                            getSecPayOrder(oRoot),
                            getSecPayAddress(oRoot, "Delivery Address"),
                            getSecPayAddress(oRoot, "Billing Address"),
                            sOpts)

                            bSavePayment = True

                        Else
                            If Not b3DAuthorised Then
                                cResponse = oSecVpn.threeDSecureEnrolmentRequest(cOrderType,
                                                    CStr(oDictOpt("accountPassword")),
                                                    CStr(mnCartId),
                                                    goRequest.ServerVariables("REMOTE_ADDR"),
                                                    mcCardHolderName,
                                                    goRequest("creditCard/number"),
                                                    CStr(mnPaymentAmount),
                                                    fmtSecPayDate(goRequest("creditCard/expireDate")),
                                                    goRequest("creditCard/issueNumber"),
                                                    fmtSecPayDate(goRequest("creditCard/issueDate")),
                                                    getSecPayOrder(oRoot),
                                                    getSecPayAddress(oRoot, "Delivery Address"),
                                                    getSecPayAddress(oRoot, "Billing Address"),
                                                    sOpts,
                                                    "0",
                                                    goRequest.ServerVariables("HTTP_ACCEPT"),
                                                    goRequest.ServerVariables("HTTP_USER_AGENT"),
                                                    "",
                                                    "",
                                                    "",
                                                    "",
                                                    "",
                                                    "")

                                bSavePayment = True

                            Else
                                'Pass the process back to Secpay
                                cResponse = oSecVpn.threeDSecureAuthorisationRequest(cOrderType,
                                CStr(oDictOpt("accountPassword")),
                                CStr(mnCartId),
                                goRequest("MD"),
                                goRequest("PaRes"),
                                sOpts)
                                'Save in the session the MD and the instance to save

                            End If
                        End If

                        ' Parse the response
                        oDictResp = New Hashtable

                        'cResponse = Replace(oXMLHttp.responseXML.selectSingleNode("//node()[local-name()='validateCardFullReturn']").Text, "+", " ")
                        Dim cAuthCode As String = ""
                        If cResponse <> "" Then

                            aResponse = Split(Right(cResponse, Len(cResponse) - 1), "&")

                            For i = 0 To UBound(aResponse)

                                Dim cPos As String = InStr(aResponse(i), "=")
                                If IsNumeric(cPos) Then
                                    nPos = CInt(cPos)
                                    oDictResp.Add(Left(aResponse(i), nPos - 1), Right(aResponse(i), Len(aResponse(i)) - nPos))
                                Else
                                    oDictResp.Add(Trim(aResponse(i)), "")
                                End If
                            Next


                            If oDictResp("valid") = "true" Then
                                If Not b3DSecure Then
                                    bIsValid = True
                                    err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                    ccXform.valid = True

                                Else
                                    Select Case oDictResp("mpi_status_code")
                                        Case "200"
                                            'we have to get the browser to redirect
                                            ' v4 change - don't explicitly redirect to /deafault.ashx - this breaks everything.
                                            ' AJG Remove defualt.ashx from RedirectUrl Compare this line to 4.1
                                            If moCartConfig("SecureURL").EndsWith("/") Then
                                                sRedirectURL = moCartConfig("SecureURL") & "?cartCmd=Redirect3ds"
                                            Else
                                                sRedirectURL = moCartConfig("SecureURL") & "/?cartCmd=Redirect3ds"
                                            End If

                                            Dim cleanACSURL As String = myWeb.goServer.UrlDecode(oDictResp("acs_url"))
                                            cleanACSURL = Replace(cleanACSURL, "&amp;", "&")

                                            bIsValid = False
                                            ccXform.valid = False
                                            err_msg = "customer redirected to:" & cleanACSURL

                                            'Save MD as paymentRef
                                            sPaymentRef = oDictResp("MD")
                                            'Save the payment instance in the session

                                            Xform3dSec = Me.xfrmSecure3D(oDictResp("acs_url"), oDictResp("MD"), oDictResp("PaReq"), sRedirectURL)

                                        Case "212"
                                            'not subscribes to 3D Secure
                                            bIsValid = True
                                            err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                            err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")
                                            ccXform.valid = True

                                        Case "237"
                                            'Payer Authenticated
                                            bIsValid = True
                                            err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                            err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")
                                            ccXform.valid = True

                                        Case "236"
                                            ' Payer Declined 3D Secure but Proceeded to confirm 
                                            ' the(authentication)
                                            bIsValid = True
                                            err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                            err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")
                                            ccXform.valid = True


                                        Case "234"
                                            ' unable to verify erolement but secpay passes
                                            bIsValid = True
                                            err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                            err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")
                                            ccXform.valid = True


                                        Case "229"
                                            'Payer Not Authenticated
                                            bIsValid = False
                                            ccXform.valid = False
                                            err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")

                                        Case Else
                                            If oDictResp("code") = "A" Then
                                                bIsValid = True
                                                err_msg = "Payment Authorised Ref: " & CStr(mnCartId)
                                                err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_message")
                                                ccXform.valid = True
                                            Else
                                                'Payer Not Authenticated
                                                bIsValid = False
                                                ccXform.valid = False
                                                err_msg = err_msg & " 3D Secure:" & oDictResp("mpi_status_code") & " - " & oDictResp("mpi_message")
                                            End If
                                    End Select
                                End If
                            Else
                                ccXform.valid = False
                                bIsValid = False
                                err_msg_log = "Payment Failed : " & oDictResp("message") & " (Code::" & oDictResp("code") & ")"

                                ' Produce nice format error messages.
                                Select Case oDictResp("code")
                                    Case "N"
                                        err_msg = "The transaction was not authorised by your payment provider."
                                    Case "C"
                                        err_msg = "There was a comunication problem. Please try resubmitting your order later."
                                    Case "P:A"
                                        err_msg = "There was a system error - the amount was not supplied or invalid.  Please call for assistance."
                                    Case "P:X"
                                        err_msg = "There was a system error - not all the mandatory parameters were supplied.  Please call for assistance."
                                    Case "P:P"
                                        err_msg = "The payment has already been processed.  This is a duplicate payment, and will not be processed."
                                    Case "P:S"
                                        err_msg = "The start date is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:E"
                                        err_msg = "The expiry date is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:I"
                                        err_msg = "The issue number is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:C"
                                        err_msg = "The card number supplied is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:T"
                                        err_msg = "The card type does not match the card number entered.  Please check that you have entered your card details correctly."
                                    Case "P:N"
                                        err_msg = "There was a system error - the customer name was not supplied.  Please call for assistance."
                                    Case "P:M"
                                        err_msg = "There was a system error - the merchant account deos not exist or has not been registered.  Please call for assistance."
                                    Case "P:B"
                                        err_msg = "There was a system error - the merchant account for this card type does not exist.  Please call for assistance."
                                    Case "P:D"
                                        err_msg = "There was a system error - the merchant account for this currency does not exist.  Please call for assistance."
                                    Case "P:V"
                                        err_msg = "The security code is invalid. Please check that you have entered your card details correctly. The security code can be found on the back of your card and is the last 3 digits of the series of digits on the back."
                                    Case "P:R"
                                        err_msg = "There was a communication problem and the transaction has timed out.  Please try resubmitting your order later."
                                    Case "P:#"
                                        err_msg = "There was a system error - no encryption key has been set up against this account.  Please call for assistance."
                                    Case Else
                                        err_msg = "There was an unspecified error. Please call for assistance.(code::" & oDictResp("code") & " | " & oDictResp("message")
                                End Select

                                err_msg = "Payment Failed : " & err_msg

                            End If
                        Else
                            bIsValid = False
                            ccXform.valid = False
                            err_msg = "Payment Failed : no response from secpay check settings and password"
                        End If


                        If bSavePayment Then
                            'We Save the payment method prior to ultimate validation because we only have access to the request object at the point it is submitted

                            'only do this for a valid payment method
                            Dim oSaveElmt As XmlElement = ccXform.Instance.SelectSingleNode("creditCard/bSavePayment")
                            Debug.WriteLine(goRequest("creditCard/expireDate"))
                            Dim oDate As New Date("20" & Right(goRequest("creditCard/expireDate"), 2), CInt(Left(goRequest("creditCard/expireDate"), 2)), 1)
                            oDate = oDate.AddMonths(1)
                            oDate = oDate.AddDays(-1)
                            Dim cMethodName As String = goRequest("creditCard/type") & ": " & MaskString(goRequest("creditCard/number"), "*", False, 4) & " Expires: " & oDate.ToShortDateString
                            cAuthCode = oDictResp("auth_code")

                            Dim oSecPayElmt As XmlElement = ccXform.Instance.OwnerDocument.CreateElement("SecPay")
                            oSecPayElmt.SetAttribute("AuthCode", cAuthCode)
                            ccXform.Instance.FirstChild.AppendChild(oSecPayElmt)

                            If Not oSaveElmt Is Nothing Then
                                If oSaveElmt.InnerText = "true" And bIsValid Then
                                    savePayment(myWeb.mnUserId, "SecPay", mnCartId, cMethodName, ccXform.Instance.FirstChild, oDate, True, mnPaymentAmount)
                                Else
                                    savePayment(myWeb.mnUserId, "SecPay", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, False, mnPaymentAmount)
                                End If
                            Else
                                savePayment(myWeb.mnUserId, "SecPay", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, False, mnPaymentAmount)
                            End If

                        End If

                        ccXform.addNote(ccXform.moXformElmt, xForm.noteTypes.Alert, err_msg)



                    Else
                        If ccXform.isSubmitted And ccXform.validationError = "" Then
                            err_msg = "Unknown Error: Please call"
                            ccXform.addNote(ccXform.moXformElmt, xForm.noteTypes.Alert, err_msg)
                        Else
                            err_msg = ccXform.validationError
                        End If
                        ccXform.valid = False
                    End If

                    If ccXform.isSubmitted Or b3DAuthorised Then
                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If bIsValid Or b3DAuthorised Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg & vbLf & "Full Response:' " & cResponse & "'"
                            Else
                                If err_msg_log = "" Then err_msg_log = err_msg
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log & vbLf & "Full Response:' " & cResponse & "'"
                            End If
                            If b3DSecure And bIsValid = False Then
                                oRow("cPaymentRef") = sPaymentRef
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")
                    End If

                    If Not Xform3dSec Is Nothing Then
                        paySecPay = Xform3dSec
                    Else
                        paySecPay = ccXform
                    End If

                Catch ex As Exception
                    returnException(mcModuleName, "paySecPay", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySecPayUkash(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "paySecPayUkash")

                Dim sSql As String
                Dim ccXform As xForm

                Dim bIsValid As Boolean
                Dim err_msg As String
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim aResponse() As String
                Dim oDictResp As Hashtable
                Dim cResponse As String

                Dim oDictOpt As New Hashtable

                Dim i As Integer
                Dim nPos As Integer
                Dim sOpts As String
                Dim cOrderType As String
                Dim bCv2 As Boolean = False

                'Test Vouchers
                '£25.00        '6337180099169015249:
                '£25.00        '6337180091114582647:
                '£25.00        '6337180099224977516:
                '£25.00        '6337180091385666418:
                '£25.00        '6337180095179084217:
                '£25.00        '6337180094605120927:
                '£25.00        '6337180096516745502:
                '£25.00        '6337180090359094102:
                '£25.00        '6337180090560691415:
                '£25.00        '6337180098258075411:
                '£25.00        '6337180097643841024:

                Dim oSecPayUkashCfg As XmlNode
                Dim oElmt As XmlElement

                Dim cProcessInfo As String = "paySecPay"
                Try

                    'Get the payment options into a hashtable
                    oSecPayUkashCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecPayUkash']")
                    For Each oElmt In oSecPayUkashCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    'Load the Xform
                    ccXform = UkashXform(oRoot, "PayForm", sSubmitPath, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("currency") & " by Ukash")

                    If ccXform.valid = True Then

                        'Validate Card
                        sOpts = "test_status=" & oDictOpt("opperationMode")
                        If mnPaymentAmount < goRequest("Ukash/VoucherValue") Then
                            sOpts = sOpts & ",sv_txn_type=PS"
                            sOpts = sOpts & ",sv_ps_number=" & goRequest("Ukash/VoucherNumber")
                            sOpts = sOpts & ",sv_ps_value=" & goRequest("Ukash/VoucherValue")
                            sOpts = sOpts & ",sv_ps_newvalue=" & FormatNumber((CDbl(goRequest("Ukash/VoucherValue")) - mnPaymentAmount), 2)
                        ElseIf mnPaymentAmount = goRequest("Ukash/VoucherValue") Then
                            sOpts = sOpts & ",sv_txn_type=RD"
                            sOpts = sOpts & ",sv_rd_number=" & goRequest("Ukash/VoucherNumber")
                            sOpts = sOpts & ",sv_rd_value=" & goRequest("Ukash/VoucherValue")
                        End If

                        Dim oSecVpn As Paypoint.SECVPNClient = New Paypoint.SECVPNClient

                        cOrderType = oRoot.GetAttribute("orderType")
                        If Not (cOrderType <> "" And CStr(oDictOpt("orderType")) = "true") Then cOrderType = CStr(oDictOpt("accountId"))

                        cResponse = oSecVpn.validateCardFull(cOrderType,
                        CStr(oDictOpt("accountPassword")),
                        CStr(mnCartId),
                        goRequest.ServerVariables("REMOTE_ADDR"),
                        mcCardHolderName,
                        "",
                        CStr(mnPaymentAmount),
                        "",
                        "",
                        "",
                        getSecPayOrder(oRoot),
                        getSecPayAddress(oRoot, "Delivery Address"),
                        getSecPayAddress(oRoot, "Billing Address"),
                        sOpts)


                        ' Parse the response
                        oDictResp = New Hashtable

                        If cResponse <> "" Then

                            aResponse = Split(Right(cResponse, Len(cResponse) - 1), "&")

                            For i = 0 To UBound(aResponse)
                                nPos = InStr(aResponse(i), "=")
                                oDictResp.Add(Left(aResponse(i), nPos - 1), Right(aResponse(i), Len(aResponse(i)) - nPos))
                            Next

                            If oDictResp("valid") = "true" Then
                                bIsValid = True
                                ccXform.valid = True

                                err_msg = "Payment Authorised Ref: " & CStr(mnCartId) & " - " & oDictResp("sv_rd_newnumber") & oDictResp("sv_ps_newnumber")

                                'add the response to the instance so we can save it against the transaction

                                addNewTextNode("NewVoucherNumber", ccXform.Instance.FirstChild, oDictResp("sv_ps_newnumber"))
                                addNewTextNode("NewVoucherValue", ccXform.Instance.FirstChild, oDictResp("sv_ps_newvalue"))
                                addNewTextNode("NewVoucherExpires", ccXform.Instance.FirstChild, oDictResp("sv_ps_expiry"))

                                savePayment(myWeb.mnUserId, "SecPayUkash", mnCartId, err_msg, ccXform.Instance.FirstChild, Now, False, mnPaymentAmount)

                            Else
                                ccXform.valid = False
                                bIsValid = False
                                err_msg_log = "Payment Failed : " & oDictResp("message") & " (Code::" & oDictResp("code") & ")"

                                ' Produce nice format error messages.
                                Select Case oDictResp("code")
                                    Case "N"
                                        err_msg = "The transaction was not authorised by your payment provider."
                                    Case "C"
                                        err_msg = "There was a comunication problem. Please try resubmitting your order later."
                                    Case "P:A"
                                        err_msg = "There was a system error - the amount was not supplied or invalid.  Please call for assistance."
                                    Case "P:X"
                                        err_msg = "There was a system error - not all the mandatory parameters were supplied.  Please call for assistance."
                                    Case "P:P"
                                        err_msg = "The payment has already been processed.  This is a duplicate payment, and will not be processed."
                                    Case "P:S"
                                        err_msg = "The start date is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:E"
                                        err_msg = "The expiry date is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:I"
                                        err_msg = "The issue number is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:C"
                                        err_msg = "The card number supplied is invalid.  Please check that you have entered your card details correctly."
                                    Case "P:T"
                                        err_msg = "The card type does not match the card number entered.  Please check that you have entered your card details correctly."
                                    Case "P:N"
                                        err_msg = "There was a system error - the customer name was not supplied.  Please call for assistance."
                                    Case "P:M"
                                        err_msg = "There was a system error - the merchant account deos not exist or has not been registered.  Please call for assistance."
                                    Case "P:B"
                                        err_msg = "There was a system error - the merchant account for this card type does not exist.  Please call for assistance."
                                    Case "P:D"
                                        err_msg = "There was a system error - the merchant account for this currency does not exist.  Please call for assistance."
                                    Case "P:V"
                                        err_msg = "The security code is invalid. Please check that you have entered your card details correctly. The security code can be found on the back of your card and is the last 3 digits of the series of digits on the back."
                                    Case "P:R"
                                        err_msg = "There was a communication problem and the transaction has timed out.  Please try resubmitting your order later."
                                    Case "P:#"
                                        err_msg = "There was a system error - no encryption key has been set up against this account.  Please call for assistance."
                                    Case "P:G"
                                        err_msg = "The Ukash voucher does not have enough funds for this transaction."
                                    Case "P:H"
                                        err_msg = "The Ukash number or value is missing or invalid.  Please check that you have entered your Ukash number and value correctly."
                                    Case "P:Q"
                                        err_msg = "The Ukash product is missing or invalid.  Please call for assistance."
                                    Case "P:U"
                                        err_msg = "The Ukash value supplied is missing or invalid.  Please check that you have entered your Ukash value correctly."
                                    Case "P:W"
                                        err_msg = "The Ukash Currency is missing invalid. Please call for assistance."
                                    Case "P:Y"
                                        err_msg = "The Ukash number supplied is invalid.  Please check that you have entered your Ukash number correctly."
                                    Case "P:Z"
                                        err_msg = "The Ukash is not enabled for this merchant. Please call for assistance."

                                    Case Else
                                        err_msg = "There was an unspecified error. Please call for assistance.(code::" & oDictResp("code") & " | " & oDictResp("message") & ")"
                                End Select

                                err_msg = "Payment Failed : " & err_msg

                            End If
                        Else
                            bIsValid = False
                            ccXform.valid = False
                            err_msg = "Payment Failed : no response from secpay check settings and password"
                        End If

                        If gbDebug Then
                            ccXform.addNote("Ukash", xForm.noteTypes.Alert, err_msg_log)
                        Else
                            ccXform.addNote("Ukash", xForm.noteTypes.Alert, err_msg)
                        End If


                        'Update Seller Notes:

                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId

                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If bIsValid Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        If bIsValid Then

                            'let see if we have any ukash specific email settings.
                            Dim uKashMerchantEmail As String = moCartConfig("MerchantEmail")
                            If oDictOpt("altMerchantEmail") <> "" Then uKashMerchantEmail = oDictOpt("altMerchantEmail")

                            Dim uKashMerchantName As String = moCartConfig("MerchantName")
                            If oDictOpt("altMerchantName") <> "" Then uKashMerchantName = oDictOpt("altMerchantName")

                            Dim uKashEmailTemplatePath As String = moCartConfig("MerchantEmailTemplatePath")
                            If oDictOpt("altMerchantSubject") <> "" Then uKashEmailTemplatePath = oDictOpt("altMerchantSubject")

                        End If

                    End If

                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "paySecPayUkash", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySagePay(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm

                PerfMon.Log("PaymentProviders", "payProTx")

                Dim oRequest As HttpWebRequest
                Dim oResponse As HttpWebResponse
                Dim oStream As System.IO.Stream
                Dim oStreamReader As StreamReader

                Dim nResult As Long

                Dim cResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim sSql As String

                Dim cMessage As String

                Dim ccXform As xForm

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim oDictOpt As New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3dSecure As Boolean = False
                Dim oResponseDict As Hashtable = Nothing
                Dim oCartAdd As XmlNode
                Dim b3dAuthorised As Boolean = False

                Dim oElmt As XmlElement

                Dim oProTxCfg As XmlNode
                Dim cIPAddress As String = goRequest.ServerVariables("REMOTE_ADDR")

                Dim cProcessInfo As String = "payProTx"
                Dim sAPIVer As String = ""
                Dim sVSPUrl As String = ""
                Dim sVSP3DSUrl As String = ""
                Dim nAttemptCount As Long

                Dim cSellerNotes As String = ""

                Try

                    If Not goSession("attemptCount") Is Nothing Then
                        nAttemptCount = goSession("attemptCount")
                        nAttemptCount = nAttemptCount + 1
                    Else
                        nAttemptCount = 1
                    End If

                    'Get the payment options into a hashtable
                    oProTxCfg = moPaymentCfg.SelectSingleNode("provider[@name='ProTx' or @name='SagePay']")
                    For Each oElmt In oProTxCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='Billing Address']")

                    If oDictOpt("validateCV2") = "on" Then bCv2 = True
                    If oDictOpt("secure3d") = "on" Then
                        b3dSecure = True
                        ' Check the IP Addresses for a block
                        If Not (oDictOpt("secure3dIpBlock") Is Nothing) Then
                            Dim oRE As Regex = New Regex("(,|^)" & Replace(cIPAddress, ".", "\.") & "(,|$)")
                            If oRE.IsMatch(oDictOpt("secure3dIpBlock")) Then b3dSecure = False
                        End If
                    End If

                    sAPIVer = "2.22"
                    ' sAPIVer = "3.00"

                    Select Case oDictOpt("opperationMode")
                        Case "simulator"
                            sVSPUrl = "https://test.sagepay.com/Simulator/VSPDirectGateway.asp"
                            sVSP3DSUrl = "https://test.sagepay.com/Simulator/VSPDirectCallback.asp"
                            nTransactionMode = TransactionMode.Test
                        Case "test"
                            sVSPUrl = "https://test.sagepay.com/gateway/service/vspdirect-register.vsp"
                            sVSP3DSUrl = "https://test.sagepay.com/gateway/service/direct3dcallback.vsp"
                            nTransactionMode = TransactionMode.Test
                        Case "live"
                            sVSPUrl = "https://live.sagepay.com/gateway/service/vspdirect-register.vsp"
                            sVSP3DSUrl = "https://live.sagepay.com/gateway/service/direct3dcallback.vsp"
                            nTransactionMode = TransactionMode.Live
                    End Select


                    'Load the Xform
                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("cardsAccepted"), True, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("currency") & " by Credit/Debit Card")

                    If b3dSecure Then
                        'check for return from aquiring bank
                        If goRequest("PARes") <> "" Then
                            b3dAuthorised = True
                        End If
                    End If

                    Dim orderPrefix As String = ""

                    If oDictOpt("sendPrefix") = "true" Then
                        orderPrefix = IIf(nTransactionMode = TransactionMode.Test, "D-", "") & moCartConfig("OrderNoPrefix")
                    End If

                    If ccXform.valid = True Or b3dAuthorised Then
                        If b3dAuthorised Then
                            '3D Secure Resume
                            cRequest = "MD=" & goRequest("MD") & "&"
                            cRequest = cRequest & "PARes=" & goServer.UrlEncode(goRequest("PARes")) & "&"
                        Else
                            'standard card validation request
                            cRequest = "VPSProtocol=" & sAPIVer & "&"
                            cRequest = cRequest & "TxType=" & oDictOpt("transactionType") & "&" ' 0=omited 1=full auth 2=pre-auth only
                            cRequest = cRequest & "Vendor=" & oDictOpt("accountId") & "&" ' 0=omited 1=full auth 2=pre-auth only
                            If nAttemptCount > 1 Then
                                cRequest = cRequest & "VendorTXCode=" & goServer.UrlEncode(orderPrefix & CStr(mnCartId)) & "-" & nAttemptCount & "&"
                            Else
                                cRequest = cRequest & "VendorTXCode=" & goServer.UrlEncode(orderPrefix & CStr(mnCartId)) & "&"
                            End If
                            cRequest = cRequest & "Amount=" & goServer.UrlEncode(CStr(FullMoneyString(mnPaymentAmount))) & "&"
                            cRequest = cRequest & "Currency=" & goServer.UrlEncode(oDictOpt("currency")) & "&"
                            cRequest = cRequest & "Description=" & goServer.UrlEncode(Left(mcPaymentOrderDescription, 90)) & "&"
                            cRequest = cRequest & "CardHolder=" & goServer.UrlEncode(mcCardHolderName) & "&"
                            cRequest = cRequest & "CardNumber=" & goServer.UrlEncode(FormatCreditCardNumber(goRequest("creditCard/number"))) & "&"
                            If Not goRequest("creditCard/issueDate") = "" Then
                                cRequest = cRequest & "StartDate=" & fmtSecPayDate(goRequest("creditCard/issueDate")) & "&"
                            End If
                            cRequest = cRequest & "ExpiryDate=" & fmtSecPayDate(goRequest("creditCard/expireDate")) & "&"
                            cRequest = cRequest & "IssueNo=" & goServer.UrlEncode(goRequest("creditCard/issueNumber")) & "&"
                            cRequest = cRequest & "CV2=" & goServer.UrlEncode(CStr(goRequest("creditCard/CV2"))) & "&"
                            cRequest = cRequest & "CardType=" & goServer.UrlEncode(goRequest("creditCard/type")) & "&"
                            cRequest = cRequest & "BillingAddress=" & goServer.UrlEncode(mcCardHolderAddress) & "&"
                            cRequest = cRequest & "BillingPostcode=" & goServer.UrlEncode(mcCardHolderPostcode) & "&"
                            cRequest = cRequest & "ContactNumber=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Telephone").InnerText) & "&"
                            cRequest = cRequest & "ContactFax=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Fax").InnerText) & "&"
                            If oCartAdd.SelectSingleNode("Email").InnerText <> "" Then
                                cRequest = cRequest & "CustomerEmail=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Email").InnerText) & "&"
                            Else
                                cRequest = cRequest & "CustomerEmail=" & oDictOpt("MerchantEmail") & "&"
                            End If

                            Dim cIP As String = goRequest.ServerVariables("REMOTE_ADDR")
                            If cIP.Length < 4 Then cIP = "127.0.0.1"
                            cRequest = cRequest & "ClientIPAddress=" & cIP & "&"

                            If b3dSecure = True Then
                                cRequest = cRequest & "Apply3DSecure=0" & "&"
                            Else
                                'do not make the 3D Secure check
                                cRequest = cRequest & "Apply3DSecure=2" & "&"
                            End If

                            'goSession("attemptCount") = nAttemptCount + 1
                        End If

                        ' Convert the request to bytes
                        If cRequest.EndsWith("&") Then cRequest = cRequest.Trim("&".ToCharArray())

                        byRequest = oEncoding.GetBytes(cRequest)

                        If b3dAuthorised Then
                            oRequest = HttpWebRequest.Create(sVSP3DSUrl)
                        Else
                            oRequest = HttpWebRequest.Create(sVSPUrl)
                        End If

                        oRequest.ContentType = "application/x-www-form-urlencoded"
                        oRequest.ContentLength = byRequest.Length
                        oRequest.Method = "POST"
                        oStream = oRequest.GetRequestStream
                        oStream.Write(byRequest, 0, byRequest.Length)
                        oStream.Close()

                        oResponse = oRequest.GetResponse()
                        oStream = oResponse.GetResponseStream()
                        oStreamReader = New StreamReader(oStream, System.Text.Encoding.UTF8)
                        cResponse = oStreamReader.ReadToEnd

                        oStreamReader.Close()
                        oResponse.Close()

                        goSession("attemptCount") = nAttemptCount

                        ' Validate the response.

                        If cResponse = "" Or InStr(cResponse, "=") = 0 Then
                            err_msg = "There was a communications error."
                        Else
                            ' lets take the response and put it in a hash table
                            cProcessInfo = "Error translating response:" & cResponse
                            oResponseDict = UrlResponseToHashTable(cResponse, vbCrLf, "=", False)

                            nResult = oResponseDict("intStatus")

                            Select Case oResponseDict("Status")

                                Case "OK", "AUTHENTICATED", "REGISTERED"
                                    ' Successful Authorisation
                                    err_msg = "Payment was successful. Transaction ref: " & oResponseDict("VPSTxId")
                                    bIsValid = True

                                    goSession("attemptCount") = Nothing

                                Case "3DAUTH"

                                    'create an xform that automatically redirects to Aquiring Banks 3DS portal.
                                    'Save MD as paymentRef
                                    goSession("VPSTxId") = oResponseDict("VPSTxId")
                                    goSession("SecurityKey") = oResponseDict("SecurityKey")

                                    Dim sRedirectURL As String
                                    If moCartConfig("SecureURL").EndsWith("/") Then
                                        sRedirectURL = moCartConfig("SecureURL") & "?cartCmd=SubmitPaymentDetails"
                                    Else
                                        sRedirectURL = moCartConfig("SecureURL") & "/?cartCmd=SubmitPaymentDetails"
                                    End If

                                    bIsValid = False
                                    ccXform.valid = False

                                    err_msg_log = "ACS URL:" & oResponseDict("ACSURL") & " ACS URLDecoded:" & goServer.UrlDecode(oResponseDict("ACSURL")) & " MD:" & oResponseDict("MD") & " PAReq:" & oResponseDict("PAReq")
                                    err_msg = "This card has subscribed to 3D Secure. You will now be re-directed to your banks website for further verification."

                                    ccXform = Me.xfrmSecure3D(goServer.UrlDecode(oResponseDict("ACSURL")), oResponseDict("MD"), oResponseDict("PAReq"), sRedirectURL)

                                Case "MALFORMED", "INVALID", "NOTAUTHED", "REJECTED", "ERROR"
                                    ' Failed / Error Authorisation

                                    cMessage = oResponseDict("StatusDetail")

                                    If InStr(cMessage, "card number") > 0 Then ccXform.addNote("creditCard/number", xForm.noteTypes.Alert, "The card number given is not valid.")
                                    If InStr(cMessage, "IssueNumber") > 0 Then ccXform.addNote("creditCard/issueNumber", xForm.noteTypes.Alert, "The issue number is not valid - it may not be required for non-Switch/Solo cards.")
                                    If InStr(cMessage, "StartDate") > 0 Or InStr(cMessage, "Start Date") > 0 Then ccXform.addNote("creditCard/issueDate", xForm.noteTypes.Alert, "The issue date is not valid - it may not be required for Switch or Solo cards.")
                                    If InStr(cMessage, "ExpiryDate") > 0 Or InStr(cMessage, "Expiry Date") > 0 Then ccXform.addNote("creditCard/expireDate", xForm.noteTypes.Alert, "The expiry date is not valid.")

                                    err_msg_log = cMessage

                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg = "There was an error processing this payment.<br/>  No payment has been made.<br/>  Please check the details you entered and try again, or call for assistance.<br/><br/>  The error returned fron the bank was :<br/><br/> " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If

                                    ' goSession("attemptCount") = Nothing
                                Case Else
                                    'Response not recognised.
                                    cMessage = oResponseDict("StatusDetail")

                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg_log = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                        err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If

                                    goSession("attemptCount") = Nothing
                            End Select

                        End If

                        ccXform.addNote("creditCard", xForm.noteTypes.Alert, err_msg, True)

                        If bIsValid Then
                            cSellerNotes = Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "Transaction Ref:" & oResponseDict("VPSTxId") & vbLf & "comment: " & err_msg
                        Else
                            If err_msg_log = "" And err_msg <> "" Then
                                err_msg_log = err_msg
                            End If
                            cSellerNotes = Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log
                        End If

                        ccXform.valid = bIsValid
                        'Save Payment
                        Dim oSaveElmt As XmlElement = ccXform.Instance.SelectSingleNode("creditCard/bSavePayment")

                        ' Set up the save payment.
                        ' Note from Ali - not really sure what's involved here and this falls over if 3d Secure is involved,
                        ' so need to have other options if coming back from 3d secure

                        If Not (b3dAuthorised) Then
                            Dim oDate As New Date("20" & Right(goRequest("creditCard/expireDate"), 2), CInt(Left(goRequest("creditCard/expireDate"), 2)), 1)
                            oDate = oDate.AddMonths(1)
                            oDate = oDate.AddDays(-1)
                            Dim cMethodName As String = goRequest("creditCard/type") & ": " & MaskString(goRequest("creditCard/number"), "*", False, 4) & " Expires: " & oDate.ToShortDateString

                            Dim oCustomElmt As XmlElement = ccXform.Instance.OwnerDocument.CreateElement("ProTx")

                            oCustomElmt.SetAttribute("VPSTxId", oResponseDict("VPSTxId"))
                            oCustomElmt.SetAttribute("SecurityKey", oResponseDict("SecurityKey"))
                            oCustomElmt.SetAttribute("TxAuthNo", oResponseDict("TxAuthNo"))
                            ccXform.Instance.FirstChild.AppendChild(oCustomElmt)

                            If Not oSaveElmt Is Nothing Then
                                If oSaveElmt.InnerText = "true" And bIsValid Then
                                    savePayment(myWeb.mnUserId, "ProTx", mnCartId, cMethodName, ccXform.Instance.FirstChild, oDate, True, mnPaymentAmount)
                                Else
                                    savePayment(myWeb.mnUserId, "ProTx", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, False, mnPaymentAmount)
                                End If
                            Else
                                savePayment(myWeb.mnUserId, "ProTx", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, False, mnPaymentAmount)
                            End If
                        End If

                    Else
                        If ccXform.isSubmitted Then
                            cSellerNotes = Today & " " & TimeOfDay & ": changed to: (Payment Form EonicWeb Validation Failed) " & vbLf & "comment: " & ccXform.validationError
                        Else
                            cSellerNotes = Today & " " & TimeOfDay & ": changed to: (Payment Form Presented) " & vbLf & "comment: " & err_msg_log
                        End If
                        ccXform.valid = False
                    End If

                    'Update Seller Notes:
                    sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                    Dim oDs As DataSet
                    Dim oRow As DataRow
                    oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                    For Each oRow In oDs.Tables("Order").Rows
                        oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & cSellerNotes
                    Next
                    modbHelper.updateDataset(oDs, "Order")

                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "paySagePay", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySecureTrading(ByRef oRoot As XmlElement, ByVal sSubmitPath As String, Optional ByRef cReturnMethod As String = "", Optional ByRef cReturnTransRef As String = "") As xForm

                ' cReturnMethod - If the request is ST3DCARDQUERY and there is no enrollment, then we need to go straight on to submitting a AUTH or 3DSTAUTH request, hence the return method.

                PerfMon.Log("PaymentProviders", "paySecureTrading")

                Dim oRequestBlockXml As XmlElement
                Dim oRequestXml As XmlElement
                Dim oCustXml As XmlElement
                Dim oPostXml As XmlElement
                Dim oPaymentXml As XmlElement
                Dim oParent As XmlElement
                Dim oElmt As XmlElement

                Dim oAddress As XmlElement

                Dim oXpayRequest As HttpWebRequest
                Dim oXpayResponse As HttpWebResponse
                Dim oXpayStream As System.IO.Stream
                Dim oXpayStreamReader As StreamReader

                Dim oXmlResponse As XmlElement
                Dim nResult As Long

                Dim cXpayResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim sSql As String

                Dim cMessage As String

                Dim ccXform As xForm

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim oDictOpt As Hashtable

                Dim b3DAuthorised As Boolean = False
                Dim b3DSecure As Boolean = False
                Dim bCv2 As Boolean = False
                Dim cMD As String = ""
                Dim cRedirectURL As String = ""
                Dim cInstanceFromCallback As String = ""

                Dim bIsCallback As Boolean = False

                Dim cTokenAmp As String = "&"
                Dim cTokenEqual As String = "="
                Dim cSubmitCommand As String = "cartCmd=SecureTradingReturn" & cTokenAmp

                Dim oPaymentCfg As XmlNode


                Dim cProcessInfo As String = "paySecureTrading"
                Try

                    ' Get the payment options
                    oPaymentCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecureTrading']")

                    If oPaymentCfg Is Nothing Then
                        Err.Raise(1005, "paySecureTrading", "The Secure Trading provider section is yet to be added to the Protean.Config")
                    End If

                    oDictOpt = xmlTools.xmlToHashTable(oPaymentCfg, "value")

                    ' override the currency
                    If oDictOpt.ContainsKey("currency") Then oDictOpt.Remove("currency")
                    oDictOpt.Add("currency", mcCurrency)

                    ' Set common variables
                    If oDictOpt("validateCV2") = "on" Then bCv2 = True
                    If oDictOpt("secure3d") = "on" Then b3DSecure = True

                    ' Check if we are getting a callback from Secure Trading - if so get the encrypted instance.
                    If Left(myWeb.moRequest("cartCmd"), 19) = "SecureTradingReturn" Then

                        sSql = "select cPayMthdDetailXml from tblCartPaymentMethod INNER JOIN tblCartOrder ON nPayMthdId = nPayMthdKey where nCartOrderkey=" & mnCartId
                        Dim oInstance As String = myWeb.moDbHelper.GetDataValue(sSql, , , "")
                        If oInstance <> "" Then
                            Dim oElmt2 As XmlElement = moPageXml.CreateElement("elmt")
                            oElmt2.InnerXml = oInstance
                            cInstanceFromCallback = DecryptString(oElmt2.FirstChild.InnerText, False)
                        End If
                        bIsCallback = True
                    End If

                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("cardsAccepted"), True, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("currency") & " by Credit/Debit Card", , cInstanceFromCallback, bIsCallback)

                    If oDictOpt("disableAmpersandsInCallbackURL") = "on" Then
                        ' Change the URL to be tokenised because Secure Trading can't handle 
                        ' ampersands in their callback URLs.  Gits. 
                        cTokenAmp = "xAMPx"
                        cTokenEqual = "xEQUx"
                        cSubmitCommand = "cartCmd=SecureTradingReturn" & cTokenAmp
                    End If

                    If b3DSecure Then
                        'check for return from aquiring bank
                        If myWeb.moRequest("MD") <> "" Or cReturnMethod <> "" Then
                            b3DAuthorised = True
                            'If cReturnMethod <> "" Then
                            cMD = myWeb.moRequest("MD")
                            'End If
                        End If
                        cRedirectURL = moCartConfig("SecureURL") & "default.ashx?" & cSubmitCommand
                    End If

                    If ccXform.valid = True Or b3DAuthorised Then

                        ' Determine the request type
                        Dim cRequestType As String
                        If cReturnMethod <> "" Then
                            cRequestType = cReturnMethod
                        Else
                            If Not (b3DSecure) Then
                                cRequestType = "AUTH"
                            ElseIf b3DAuthorised Then
                                cRequestType = "ST3DAUTH"
                            Else
                                cRequestType = "ST3DCARDQUERY"
                            End If
                        End If

                        ' Build the RequestBlock XML
                        oRequestBlockXml = moPageXml.CreateElement("RequestBlock")
                        oRequestBlockXml.SetAttribute("Version", oDictOpt("appVersion"))

                        ' RequestBlock - Add the Request
                        oRequestXml = addElement(oRequestBlockXml, "Request")
                        oRequestXml.SetAttribute("Type", cRequestType)

                        ' Request - Add the Operation
                        oParent = addElement(oRequestXml, "Operation")
                        oElmt = addElement(oParent, "Amount", CStr(mnPaymentAmount * 100)) ' Note - need to convert to base unit. e.g. pence/cents etc.
                        oElmt = addElement(oParent, "SiteReference", oDictOpt("siteReference"))
                        ' Add the Currency if available
                        If oDictOpt("currency") <> "" And Len(Trim(CStr(oDictOpt("currency")))) = 3 Then
                            oElmt = addElement(oParent, "Currency", oDictOpt("currency"))
                        End If
                        ' Request specific elements
                        Select Case cRequestType
                            Case "ST3DCARDQUERY"
                                oElmt = addElement(oParent, "MerchantName", Left(moCartConfig("MerchantName"), 25))
                                oElmt = addElement(oParent, "TermUrl", cRedirectURL)
                            Case Else
                                oElmt = addElement(oParent, "SettlementDay", oDictOpt("settlementDay"))
                        End Select


                        ' Request - Add the CustomerInfo
                        oCustXml = addElement(oRequestXml, "CustomerInfo")

                        Select Case cRequestType
                            Case "ST3DCARDQUERY"
                                oElmt = addElement(oCustXml, "Accept", myWeb.moRequest.ServerVariables("HTTP_ACCEPT"))
                                oElmt = addElement(oCustXml, "UserAgent", myWeb.moRequest.ServerVariables("HTTP_USER_AGENT"))
                            Case Else
                                ' CustomerInfo - Add Billing Info
                                oAddress = oRoot.SelectSingleNode("Contact[@type='Billing Address']")
                                oPostXml = addElement(oCustXml, "Postal")
                                oElmt = addElement(oPostXml, "Company", , , , oAddress.SelectSingleNode("Company"))
                                oElmt = addElement(oPostXml, "Street", , , , oAddress.SelectSingleNode("Street"))
                                oElmt = addElement(oPostXml, "City", , , , oAddress.SelectSingleNode("City"))
                                oElmt = addElement(oPostXml, "StateProv", , , , oAddress.SelectSingleNode("State"))
                                oElmt = addElement(oPostXml, "PostalCode", , , , oAddress.SelectSingleNode("PostalCode"))
                                oElmt = addElement(oPostXml, "CountryCode", getCountryISO2Code(oAddress.SelectSingleNode("Country").InnerText))

                                ' CustomerInfo - Add Name
                                oParent = addElement(oPostXml, "Name", , , True)
                                oElmt = addElement(oParent, "FirstName", , , , oAddress.SelectSingleNode("GivenName"))
                                oElmt = addElement(oParent, "LastName")
                                oElmt = addElement(oParent, "NamePrefix")
                                oElmt = addElement(oParent, "MiddleName")
                                oElmt = addElement(oParent, "NameSuffix")

                                ' CustomerInfo - Add Telecoms
                                oParent = addElement(oCustXml, "Telecom")
                                oElmt = addElement(oParent, "Phone", , , , oAddress.SelectSingleNode("Telephone"))

                                ' CustomerInfo - Add Email
                                oParent = addElement(oCustXml, "Online")
                                oElmt = addElement(oParent, "Email", , , , oAddress.SelectSingleNode("Email"))
                        End Select



                        ' Request - Add the Payment Method
                        oPaymentXml = addElement(oRequestXml, "PaymentMethod")
                        oParent = addElement(oPaymentXml, "CreditCard")
                        oElmt = addElement(oParent, "Type", ccXform.Instance.SelectSingleNode("creditCard/type").InnerText)
                        oElmt = addElement(oParent, "Number", FormatCreditCardNumber(ccXform.Instance.SelectSingleNode("creditCard/number").InnerText))
                        oElmt = addElement(oParent, "Issue", ccXform.Instance.SelectSingleNode("creditCard/issueNumber").InnerText)
                        oElmt = addElement(oParent, "StartDate", fmtSecureTradingDate(ccXform.Instance.SelectSingleNode("creditCard/issueDate").InnerText))
                        oElmt = addElement(oParent, "ExpiryDate", fmtSecureTradingDate(ccXform.Instance.SelectSingleNode("creditCard/expireDate").InnerText))
                        oElmt = addElement(oParent, "SecurityCode", ccXform.Instance.SelectSingleNode("creditCard/CV2").InnerText)

                        ' Payment - Process 3D Secure additional params
                        If cRequestType = "ST3DAUTH" Then
                            Dim cReqEnrolled As String, cReqPTR As String
                            ' Add ref to the credit card
                            If cReturnMethod <> "" Then
                                cReqEnrolled = "N"
                                cReqPTR = cReturnTransRef
                            ElseIf oDictOpt("disableAmpersandsInCallbackURL") = "on" Then
                                cReqEnrolled = SimpleRegexFind(myWeb.moRequest.QueryString("cartCmd"), cTokenAmp & "Enrolled" & cTokenEqual & "([^(" & cTokenAmp & ")]+)" & cTokenAmp, 1, RegexOptions.IgnoreCase)
                                cReqPTR = SimpleRegexFind(myWeb.moRequest.QueryString("cartCmd"), cTokenAmp & "PTR" & cTokenEqual & "([^(" & cTokenAmp & ")]+)" & cTokenAmp, 1, RegexOptions.IgnoreCase)
                            Else
                                cReqEnrolled = myWeb.moRequest("Enrolled")
                                cReqPTR = myWeb.moRequest("PTR")
                            End If
                            oElmt = addElement(oParent, "ParentTransactionReference", cReqPTR)

                            ' Add a 3d Secure element
                            oParent = addElement(oPaymentXml, "ThreeDSecure")
                            oElmt = addElement(oParent, "Enrolled", cReqEnrolled)
                            oElmt = addElement(oParent, "PaRes", myWeb.moRequest("PaRes"))
                            oElmt = addElement(oParent, "MD", cMD)
                        End If


                        ' Request - Add the Order Information
                        oParent = addElement(oRequestXml, "Order")
                        oElmt = addElement(oParent, "OrderInformation", getWorldPayOrder(oRoot))
                        oElmt = addElement(oParent, "OrderReference", CStr(mnCartId))

                        ' Get Certificate from file.  Not a wholly secure means as not encrypted but good for now.
                        Dim oStreamreader As StreamReader = New StreamReader(CStr(oDictOpt("certificatePath")))

                        ' RequestBlock - Add the Certificate
                        oParent = addElement(oRequestBlockXml, "Certificate", vbCrLf & oStreamreader.ReadToEnd)
                        oStreamreader.Close()

                        ' Convert the request to bytes
                        cRequest = oRequestBlockXml.OuterXml
                        byRequest = oEncoding.GetBytes(cRequest)

                        oXpayRequest = HttpWebRequest.Create("http://127.0.0.1:" & oDictOpt("appPort"))
                        oXpayRequest.ContentType = "application/x-www-form-urlencoded"
                        oXpayRequest.ContentLength = cRequest.Length
                        oXpayRequest.Method = "POST"
                        oXpayStream = oXpayRequest.GetRequestStream
                        oXpayStream.Write(byRequest, 0, byRequest.Length)
                        oXpayStream.Close()

                        oXpayResponse = oXpayRequest.GetResponse()
                        oXpayStream = oXpayResponse.GetResponseStream()
                        oXpayStreamReader = New StreamReader(oXpayStream, System.Text.Encoding.UTF8)
                        cXpayResponse = oXpayStreamReader.ReadToEnd

                        oXmlResponse = moPageXml.CreateElement("oXmlResponse")
                        oXmlResponse.InnerXml = cXpayResponse

                        oXpayStreamReader.Close()
                        oXpayResponse.Close()

                        ' Validate the response.
                        Dim oOpResponse As XmlElement
                        Dim oResponseType As String
                        oOpResponse = oXmlResponse.SelectSingleNode("/ResponseBlock/Response/OperationResponse")
                        If oOpResponse Is Nothing Then
                            err_msg = "There was a communications error."
                        Else
                            nResult = oOpResponse.SelectSingleNode("Result").InnerText
                            oResponseType = oOpResponse.ParentNode.Attributes("Type").InnerText
                            ' Process the repsonse by Type
                            Select Case oResponseType

                                Case "ST3DCARDQUERY"

                                    Select Case nResult
                                        Case 0
                                            cMessage = ""
                                            ' ST3DCARDQUERY Should be retried
                                            Try
                                                cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                                err_msg_log = cMessage
                                                cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                            Catch ex2 As Exception
                                                ' Do Nothing
                                            End Try

                                            err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance. " & cMessage

                                        Case 1
                                            ' Successful Authorisation - Process the response into a 3D Secure form
                                            Dim cACS As String, cPaReq As String, cEnrolled As String
                                            Dim oXml As XmlDocument = New XmlDocument

                                            cMessage = ""
                                            ' Is the user enrolled
                                            cEnrolled = oOpResponse.SelectSingleNode("Enrolled").InnerText

                                            Select Case cEnrolled

                                                Case "Y"

                                                    ' Encrypt the cc details form for retrieval by Sec Trading later.
                                                    Dim cCCInstance As String = EncryptString(ccXform.Instance.InnerXml, False)
                                                    Dim oEncryptedPayment As XmlElement = ccXform.moPageXML.CreateElement("encryptedPayment")
                                                    oEncryptedPayment.InnerText = cCCInstance
                                                    savePayment(myWeb.mnUserId, "ProTx", mnCartId, "SecureTrading", oEncryptedPayment, Now, False, mnPaymentAmount)

                                                    Try


                                                        ' Get the HTML and load it in

                                                        ' Try to parse the HTML
                                                        ' The following method looks convoluted, but it is probably the best way to get through this shocking excuse for HTML.
                                                        ' tidyXhtmlFrag doesn't work because it does something strange to the actual values we are trying to retrieve.

                                                        Dim cHtml As String = oOpResponse.SelectSingleNode("Html").InnerText
                                                        'Dim oRe As Regex, oFind As Match

                                                        ' Get Action
                                                        cACS = SimpleRegexFind(cHtml, "ACTION='([^']+)'", 1, RegexOptions.IgnoreCase)

                                                        ' Get PaReq
                                                        cPaReq = SimpleRegexFind(cHtml, "name='PaReq' value='([^']+)'", 1, RegexOptions.IgnoreCase)

                                                        ' Get MD
                                                        cMD = SimpleRegexFind(cHtml, "name='MD' value='([^']+)'", 1, RegexOptions.IgnoreCase)

                                                        cRedirectURL = cRedirectURL & "Enrolled" & cTokenEqual & cEnrolled & cTokenAmp
                                                        cRedirectURL = cRedirectURL & "PTR" & cTokenEqual & oOpResponse.SelectSingleNode("TransactionReference").InnerText & cTokenAmp
                                                        cRedirectURL = cRedirectURL & "cartId" & cTokenEqual & Me.mnCartId & cTokenAmp
                                                        ccXform = Me.xfrmSecure3D(cACS, cMD, cPaReq, cRedirectURL)




                                                    Catch ex As Exception
                                                        If cMessage <> "" Then cMessage = "3D Secure : Could not process the response. (Technical Info: CardQuery Html)"
                                                        err_msg_log = cMessage
                                                    End Try

                                                Case Else
                                                    ' User not enrolled, so we need to proceed to the 3DAUTHRequest
                                                    cReturnTransRef = oOpResponse.SelectSingleNode("TransactionReference").InnerText
                                                    cReturnMethod = "ST3DAUTH"
                                                    err_msg_log = "ST3DCARDQUERY Returned " & nResult & " + Enrolled of " & cEnrolled
                                            End Select

                                            If cMessage <> "" Then err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance. " & cMessage
                                        Case 2
                                            ' Note - Must perform nomral AUTH request - how to do this in this form.
                                            cReturnMethod = "AUTH"
                                            err_msg_log = "ST3DCARDQUERY Returned " & nResult
                                    End Select


                                Case "AUTH", "ST3DAUTH"
                                    Select Case nResult
                                        Case 0
                                            cMessage = ""
                                            ' Failed / Error Authorisation
                                            Try
                                                cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                                If InStr(cMessage, "CreditCardNumber") > 0 Then ccXform.addNote("creditCard/number", xForm.noteTypes.Alert, "The card number is not valid.")
                                                If InStr(cMessage, "IssueNumber") > 0 Then ccXform.addNote("creditCard/issueNumber", xForm.noteTypes.Alert, "The issue number is not valid - it may not be required for non-Switch/Solo cards.")
                                                If InStr(cMessage, "StartDate") > 0 Then ccXform.addNote("creditCard/issueDate", xForm.noteTypes.Alert, "The issue date is not valid - it may not be required for Switch or Solo cards.")
                                                If InStr(cMessage, "ExpiryDate") > 0 Then ccXform.addNote("creditCard/expireDate", xForm.noteTypes.Alert, "The expiry date is not valid.")

                                                err_msg_log = cMessage
                                                cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                            Catch ex2 As Exception
                                                ' Do Nothing
                                            End Try

                                            err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance. " & cMessage

                                        Case 1
                                            ' Successful Authorisation
                                            err_msg = "Payment was successful. Transaction ref: " & oOpResponse.SelectSingleNode("TransactionReference").InnerText
                                            bIsValid = True
                                        Case 2
                                            cMessage = ""
                                            Try
                                                ' Declined Authorisation
                                                If oOpResponse.SelectSingleNode("Message") Is Nothing Then
                                                    cMessage = ""
                                                Else
                                                    cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                                    cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                                End If
                                            Catch ex2 As Exception
                                                ' Do Nothing
                                            End Try

                                            err_msg_log = cMessage
                                            err_msg = "The authorisation for your payment was declined.  No payment has been made.  Please check the details you entered and try again, or call for assistance." & cMessage
                                    End Select
                                Case Else

                                    Select Case nResult
                                        Case 0
                                            cMessage = ""
                                            ' ST3DCARDQUERY Should be retried
                                            Try
                                                cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                                err_msg_log = cMessage
                                                cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                            Catch ex2 As Exception
                                                ' Do Nothing
                                            End Try

                                            err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance. " & cMessage
                                    End Select

                            End Select
                        End If

                        'Update Seller Notes:
                        ccXform.addNote("creditCard", xForm.noteTypes.Alert, err_msg)


                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If bIsValid Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg & vbLf & "Full Response:' " & cXpayResponse & "'"
                            Else
                                If err_msg_log = "" Then err_msg_log = err_msg
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log & vbLf & "Full Response:' " & cXpayResponse & "'"
                            End If

                        Next
                        modbHelper.updateDataset(oDs, "Order")


                        ccXform.valid = bIsValid
                    Else
                        ccXform.valid = False
                    End If

                    paySecureTrading = ccXform

                Catch ex As Exception

                    returnException(mcModuleName, "paySecureTrading", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySecureTradingOld(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "paySecureTrading")
                Dim oRequestBlockXml As XmlElement
                Dim oRequestXml As XmlElement
                Dim oCustXml As XmlElement
                Dim oPostXml As XmlElement
                Dim oPaymentXml As XmlElement
                Dim oParent As XmlElement
                Dim oElmt As XmlElement

                Dim oAddress As XmlElement

                Dim oXpayRequest As HttpWebRequest
                Dim oXpayResponse As HttpWebResponse
                Dim oXpayStream As System.IO.Stream
                Dim oXpayStreamReader As StreamReader

                Dim oXmlResponse As XmlElement
                Dim nResult As Long

                Dim cXpayResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim sSql As String

                Dim cMessage As String

                Dim ccXform As xForm

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim oDictOpt As Hashtable

                Dim bCv2 As Boolean = False

                Dim cProcessInfo As String = "paySecureTrading"
                Try

                    'Get the payment options into a hashtable
                    sSql = "select * from tbl_ewc_paymentSettings where cPymtStgTypeRef Like 'Secure Trading' or cPymtStgTypeRef Like 'General Settings' or cPymtStgTypeRef Like 'Advanced Settings' "

                    oDictOpt = modbHelper.getHashTable(sSql, "cPymtStgName", "cPymtStgValue")

                    'Load the Xform
                    If oDictOpt("CV2") = "1" Then bCv2 = True

                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("CardsAccepted"), True, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("Currency") & " by Credit/Debit Card")

                    If ccXform.valid = True Then

                        ' Build the RequestBlock XML
                        oRequestBlockXml = moPageXml.CreateElement("RequestBlock")
                        oRequestBlockXml.SetAttribute("Version", oDictOpt("STAppVersion"))

                        ' RequestBlock - Add the Request
                        oRequestXml = addElement(oRequestBlockXml, "Request")
                        oRequestXml.SetAttribute("Type", "AUTH")

                        ' Request - Add the Operation
                        oParent = addElement(oRequestXml, "Operation")
                        oElmt = addElement(oParent, "Amount", CStr(mnPaymentAmount * 100)) ' Note - need to convert to base unit. e.g. pence/cents etc.
                        oElmt = addElement(oParent, "SiteReference", oDictOpt("SiteReference"))
                        oElmt = addElement(oParent, "SettlementDay", oDictOpt("SettlementDay"))
                        ' Add the Currency if available
                        If oDictOpt("Currency") <> "" And Len(Trim(CStr(oDictOpt("Currency")))) = 3 Then
                            oElmt = addElement(oParent, "Currency", oDictOpt("Currency"))
                        End If

                        ' Request - Add the CustomerInfo
                        oCustXml = addElement(oRequestXml, "CustomerInfo")

                        ' CustomerInfo - Add Billing Info
                        oAddress = oRoot.SelectSingleNode("Contact[@type='Billing Address']")
                        oPostXml = addElement(oCustXml, "Postal")
                        oElmt = addElement(oPostXml, "Company", , , , oAddress.SelectSingleNode("Company"))
                        oElmt = addElement(oPostXml, "Street", , , , oAddress.SelectSingleNode("Address/Street"))
                        oElmt = addElement(oPostXml, "City", , , , oAddress.SelectSingleNode("Address/City"))
                        oElmt = addElement(oPostXml, "StateProv", , , , oAddress.SelectSingleNode("Address/State"))
                        oElmt = addElement(oPostXml, "PostalCode", , , , oAddress.SelectSingleNode("Address/PostalCode"))
                        oElmt = addElement(oPostXml, "CountryCode", getCountryISO2Code(oAddress.SelectSingleNode("Address/Country").InnerText))

                        ' CustomerInfo - Add Name
                        oParent = addElement(oPostXml, "Name", , , True)
                        oElmt = addElement(oParent, "FirstName", , , , oAddress.SelectSingleNode("GivenName"))
                        oElmt = addElement(oParent, "LastName")
                        oElmt = addElement(oParent, "NamePrefix")
                        oElmt = addElement(oParent, "MiddleName")
                        oElmt = addElement(oParent, "NameSuffix")

                        ' CustomerInfo - Add Telecoms
                        oParent = addElement(oCustXml, "Telecom")
                        oElmt = addElement(oParent, "Phone", , , , oAddress.SelectSingleNode("Telephone"))

                        ' CustomerInfo - Add Email
                        oParent = addElement(oCustXml, "Online")
                        oElmt = addElement(oParent, "Email", , , , oAddress.SelectSingleNode("Email"))

                        ' Request - Add the Payment Method
                        oPaymentXml = addElement(oRequestXml, "PaymentMethod")
                        oParent = addElement(oPaymentXml, "CreditCard")
                        oElmt = addElement(oParent, "Type", goRequest("creditCard/type"))
                        oElmt = addElement(oParent, "Number", FormatCreditCardNumber(goRequest("creditCard/number")))
                        oElmt = addElement(oParent, "Issue", goRequest("creditCard/issueNumber"))
                        oElmt = addElement(oParent, "StartDate", fmtSecureTradingDate(goRequest("creditCard/issueDate")))
                        oElmt = addElement(oParent, "ExpiryDate", fmtSecureTradingDate(goRequest("creditCard/expireDate")))
                        oElmt = addElement(oParent, "SecurityCode", goRequest("creditCard/CV2"))

                        ' Request - Add the Order Information
                        oParent = addElement(oRequestXml, "Order")
                        oElmt = addElement(oParent, "OrderInformation", getWorldPayOrder(oRoot))
                        oElmt = addElement(oParent, "OrderReference", CStr(mnCartId))

                        ' Get Certificate from file.  Not a wholly secure means as not encrypted but good for now.
                        Dim oStreamreader As StreamReader = New StreamReader(CStr(oDictOpt("CertificatePath")))

                        ' RequestBlock - Add the Certificate
                        oParent = addElement(oRequestBlockXml, "Certificate", vbCrLf & oStreamreader.ReadToEnd)
                        oStreamreader.Close()

                        ' Convert the request to bytes
                        cRequest = oRequestBlockXml.OuterXml
                        byRequest = oEncoding.GetBytes(cRequest)

                        oXpayRequest = HttpWebRequest.Create("http://127.0.0.1:5000")
                        oXpayRequest.ContentType = "application/x-www-form-urlencoded"
                        oXpayRequest.ContentLength = cRequest.Length
                        oXpayRequest.Method = "POST"
                        oXpayStream = oXpayRequest.GetRequestStream
                        oXpayStream.Write(byRequest, 0, byRequest.Length)
                        oXpayStream.Close()

                        oXpayResponse = oXpayRequest.GetResponse()
                        oXpayStream = oXpayResponse.GetResponseStream()
                        oXpayStreamReader = New StreamReader(oXpayStream, System.Text.Encoding.UTF8)
                        cXpayResponse = oXpayStreamReader.ReadToEnd

                        oXmlResponse = moPageXml.CreateElement("oXmlResponse")
                        oXmlResponse.InnerXml = cXpayResponse

                        oXpayStreamReader.Close()
                        oXpayResponse.Close()

                        ' Validate the response.
                        Dim oOpResponse As XmlElement
                        oOpResponse = oXmlResponse.SelectSingleNode("/ResponseBlock/Response/OperationResponse")
                        If oOpResponse Is Nothing Then
                            err_msg = "There was a communications error."
                        Else
                            nResult = oOpResponse.SelectSingleNode("Result").InnerText
                            Select Case nResult
                                Case 0
                                    cMessage = ""
                                    ' Failed / Error Authorisation
                                    Try
                                        cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                        If InStr(cMessage, "CreditCardNumber") > 0 Then ccXform.addNote("creditCard/number", xForm.noteTypes.Alert, "The card number is not valid.")
                                        If InStr(cMessage, "IssueNumber") > 0 Then ccXform.addNote("creditCard/issueNumber", xForm.noteTypes.Alert, "The issue number is not valid - it may not be required for non-Switch/Solo cards.")
                                        If InStr(cMessage, "StartDate") > 0 Then ccXform.addNote("creditCard/issueDate", xForm.noteTypes.Alert, "The issue date is not valid - it may not be required for Switch or Solo cards.")
                                        If InStr(cMessage, "ExpiryDate") > 0 Then ccXform.addNote("creditCard/expireDate", xForm.noteTypes.Alert, "The expiry date is not valid.")

                                        err_msg_log = cMessage
                                        cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                    Catch ex2 As Exception
                                        ' Do Nothing
                                    End Try

                                    err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance. " & cMessage

                                Case 1
                                    ' Successful Authorisation
                                    err_msg = "Payment was successful. Transaction ref: " & oOpResponse.SelectSingleNode("TransactionReference").InnerText
                                    bIsValid = True
                                Case 2
                                    cMessage = ""
                                    Try
                                        ' Declined Authorisation
                                        If oOpResponse.SelectSingleNode("Message") Is Nothing Then
                                            cMessage = ""
                                        Else
                                            cMessage = oOpResponse.SelectSingleNode("Message").InnerText
                                            cMessage = "  The error detail was : " & Mid(cMessage, InStr(cMessage, ")") + 1)
                                        End If
                                    Catch ex2 As Exception
                                        ' Do Nothing
                                    End Try

                                    err_msg_log = cMessage
                                    err_msg = "The authorisation for your payment was declined.  No payment has been made.  Please check the details you entered and try again, or call for assistance." & cMessage
                            End Select
                        End If

                        'Update Seller Notes:
                        ccXform.addNote("creditCard", xForm.noteTypes.Alert, err_msg)

                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Cart").Rows
                            If bIsValid Then
                                oRow("cSellerNotes").Value = oRow("cSellerNotes").Value & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes").Value = oRow("cSellerNotes").Value & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        ccXform.valid = bIsValid
                    Else
                        ccXform.valid = False
                    End If

                    Return ccXform

                Catch ex As Exception

                    returnException(mcModuleName, "paySecureTrading", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payMetaCharge(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payMetaCharge")
                Dim oMChgRequest As HttpWebRequest
                Dim oMChgResponse As HttpWebResponse
                Dim oMChgStream As System.IO.Stream
                Dim oMChgStreamReader As StreamReader

                Dim nResult As Long

                Dim cMChgResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim sSql As String

                Dim cMessage As String

                Dim ccXform As xForm

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim oDictOpt As New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3dSecure As Boolean = False
                Dim oResponseDict As Hashtable
                Dim oCartAdd As XmlNode
                Dim b3dAuthorised As Boolean = False

                Dim oElmt As XmlElement

                Dim oMetaChargeCfg As XmlNode
                Dim cIPAddress As String = goRequest.ServerVariables("REMOTE_ADDR")

                Dim cProcessInfo As String = "payMetaCharge"
                Dim sAPIVer As String = ""

                Try

                    'Get the payment options into a hashtable
                    oMetaChargeCfg = moPaymentCfg.SelectSingleNode("provider[@name='MetaCharge']")
                    For Each oElmt In oMetaChargeCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='Billing Address']")

                    If oDictOpt("validateCV2") = "on" Then bCv2 = True
                    If oDictOpt("secure3d") = "on" Then
                        b3dSecure = True
                        ' Check the IP Addresses for a block
                        If Not (oDictOpt("secure3dIpBlock") Is Nothing) Then
                            Dim oRE As Regex = New Regex("(,|^)" & Replace(cIPAddress, ".", "\.") & "(,|$)")
                            If oRE.IsMatch(oDictOpt("secure3dIpBlock")) Then b3dSecure = False
                        End If
                    End If

                    If b3dSecure Then
                        sAPIVer = "1.4"
                    Else
                        sAPIVer = "1.3"
                    End If

                    'Load the Xform
                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("cardsAccepted"), True, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & oDictOpt("currency") & " by Credit/Debit Card")

                    If b3dSecure Then
                        'check for return from aquiring bank
                        If goRequest("MD") <> "" Then
                            b3dAuthorised = True
                        End If
                    End If

                    If ccXform.valid = True Or b3dAuthorised Then
                        If b3dAuthorised Then
                            '3D Secure Resume
                            cRequest = "intInstID=" & goServer.UrlEncode(oDictOpt("installationId")) & "&"
                            cRequest = cRequest & "fltAPIVersion=" & sAPIVer & "&"
                            cRequest = cRequest & "intTestMode=" & oDictOpt("testMode") & "&"
                            cRequest = cRequest & "intTransID=" & goSession("intTransID") & "&"
                            cRequest = cRequest & "strSecurityToken=" & goSession("strSecurityToken") & "&"
                            cRequest = cRequest & "strTransType=S3DAUTH&"
                            cRequest = cRequest & "strS3DTransID=" & goSession("strS3DTransID") & "&"
                            cRequest = cRequest & "strS3DResponse=" & goServer.UrlEncode(goRequest("PaRes")) & "&"
                            cRequest = cRequest & "strS3DMerchantData=" & goServer.UrlEncode(goRequest("MD"))

                        Else
                            'standard card validation request
                            cRequest = "intInstID=" & goServer.UrlEncode(oDictOpt("installationId")) & "&"
                            cRequest = cRequest & "strCartID=" & goServer.UrlEncode(CStr(mnCartId)) & "&"
                            cRequest = cRequest & "strDesc=" & goServer.UrlEncode(mcPaymentOrderDescription) & "&"
                            cRequest = cRequest & "fltAmount=" & goServer.UrlEncode(CStr(mnPaymentAmount)) & "&"
                            cRequest = cRequest & "strCurrency=" & goServer.UrlEncode(oDictOpt("currency")) & "&"
                            cRequest = cRequest & "intAuthMode=" & oDictOpt("authMode") & "&" ' 0=omited 1=full auth 2=pre-auth only
                            cRequest = cRequest & "intTestMode=" & oDictOpt("testMode") & "&" ' 0=omited 1=allsuccess auth 2=all failed
                            cRequest = cRequest & "strCardHolder=" & goServer.UrlEncode(mcCardHolderName) & "&"
                            cRequest = cRequest & "strAddress=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Street").InnerText) & "&"
                            cRequest = cRequest & "strCity=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("City").InnerText) & "&"
                            cRequest = cRequest & "strState=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("State").InnerText) & "&"
                            cRequest = cRequest & "strPostcode=" & goServer.UrlEncode(mcCardHolderPostcode) & "&"
                            cRequest = cRequest & "strCountry=" & getCountryISO2Code((oCartAdd.SelectSingleNode("Country").InnerText)) & "&"  '2 letter ISO code
                            cRequest = cRequest & "strTel=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Telephone").InnerText) & "&"
                            cRequest = cRequest & "strFax=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Fax").InnerText) & "&"

                            If oCartAdd.SelectSingleNode("Email").InnerText <> "" Then
                                cRequest = cRequest & "strEmail=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Email").InnerText) & "&"
                            Else
                                cRequest = cRequest & "strEmail=" & oDictOpt("MerchantEmail") & "&"
                            End If

                            cRequest = cRequest & "strCardNumber=" & goServer.UrlEncode(FormatCreditCardNumber(goRequest("creditCard/number"))) & "&"
                            If Not goRequest("creditCard/issueDate") = "" Then
                                cRequest = cRequest & "strStartDate=" & fmtSecPayDate(goRequest("creditCard/issueDate")) & "&"
                            End If
                            cRequest = cRequest & "strExpiryDate=" & fmtSecPayDate(goRequest("creditCard/expireDate")) & "&"
                            cRequest = cRequest & "intCV2=" & goServer.UrlEncode(CStr(goRequest("creditCard/CV2"))) & "&"
                            cRequest = cRequest & "strIssueNo=" & goServer.UrlEncode(goRequest("creditCard/issueNumber")) & "&"
                            cRequest = cRequest & "strCardType=" & goServer.UrlEncode(goRequest("creditCard/type")) & "&"
                            cRequest = cRequest & "strUserIP=" & goRequest.ServerVariables("REMOTE_ADDR") & "&"
                            cRequest = cRequest & "fltAPIVersion=" & sAPIVer & "&"
                            If mdFulfillmentDate = Nothing Then
                                cRequest = cRequest & "datFulfillment=" & FormatDateTime(Now(), DateFormat.ShortDate) & "&"
                            Else
                                cRequest = cRequest & "datFulfillment=" & FormatDateTime(mdFulfillmentDate, DateFormat.ShortDate) & "&"
                            End If
                            cRequest = cRequest & "strTransType=PAYMENT&"
                        End If


                        ' Convert the request to bytes

                        byRequest = oEncoding.GetBytes(cRequest)

                        oMChgRequest = HttpWebRequest.Create("https://secure.metacharge.com/mcpe/corporate")
                        oMChgRequest.ContentType = "application/x-www-form-urlencoded"
                        oMChgRequest.ContentLength = byRequest.Length
                        oMChgRequest.Method = "POST"
                        oMChgStream = oMChgRequest.GetRequestStream
                        oMChgStream.Write(byRequest, 0, byRequest.Length)
                        oMChgStream.Close()

                        oMChgResponse = oMChgRequest.GetResponse()
                        oMChgStream = oMChgResponse.GetResponseStream()
                        oMChgStreamReader = New StreamReader(oMChgStream, System.Text.Encoding.UTF8)
                        cMChgResponse = oMChgStreamReader.ReadToEnd

                        oMChgStreamReader.Close()
                        oMChgResponse.Close()

                        ' Validate the response.

                        If cMChgResponse = "" Or InStr(cMChgResponse, "=") = 0 Then
                            err_msg = "There was a communications error."
                        Else
                            ' lets take the response and put it in a hash table
                            cProcessInfo = "error tranlating response:" & cMChgResponse
                            oResponseDict = UrlResponseToHashTable(cMChgResponse)

                            nResult = oResponseDict("intStatus")

                            If oResponseDict("strTransType") = "S3DVALIDATE" Then

                                'create an xform that automatically redirects to Aquiring Banks 3DS portal.
                                'Save MD as paymentRef
                                goSession("intTransID") = oResponseDict("intTransID")
                                goSession("strSecurityToken") = oResponseDict("strSecurityToken")
                                goSession("strS3DTransID") = oResponseDict("strS3DTransID")

                                Dim sRedirectURL As String
                                sRedirectURL = moCartConfig("SecureURL") & "?cartCmd=SubmitPaymentDetails" & "&"

                                bIsValid = False
                                ccXform.valid = False
                                err_msg = "This card has subscribed to 3D Secure. You will now be re-directed to your banks website for further verification."

                                ccXform = Me.xfrmSecure3D(oResponseDict("strS3DURL"), oResponseDict("strS3DMerchantData"), oResponseDict("strS3DRequest"), sRedirectURL)

                            Else

                                'Standard Process for not 3DS transactions
                                Select Case nResult
                                    Case 0
                                        ' Failed / Error Authorisation
                                        cMessage = oResponseDict("strMessage")

                                        If InStr(cMessage, "card number") > 0 Then ccXform.addNote("creditCard/number", xForm.noteTypes.Alert, "The card number given is not valid.")
                                        If InStr(cMessage, "IssueNumber") > 0 Then ccXform.addNote("creditCard/issueNumber", xForm.noteTypes.Alert, "The issue number is not valid - it may not be required for non-Switch/Solo cards.")
                                        If InStr(cMessage, "StartDate") > 0 Or InStr(cMessage, "Start Date") > 0 Then ccXform.addNote("creditCard/issueDate", xForm.noteTypes.Alert, "The issue date is not valid - it may not be required for Switch or Solo cards.")
                                        If InStr(cMessage, "ExpiryDate") > 0 Or InStr(cMessage, "Expiry Date") > 0 Then ccXform.addNote("creditCard/expireDate", xForm.noteTypes.Alert, "The expiry date is not valid.")

                                        err_msg_log = cMessage

                                        If gbDebug Then
                                            err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cMChgResponse))
                                        Else
                                            err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                        End If

                                    Case 1
                                        ' Successful Authorisation
                                        err_msg = "Payment was successful. Transaction ref: " & oResponseDict("strSecurityToken")
                                        bIsValid = True
                                End Select

                            End If

                        End If

                        'Update Seller Notes:
                        ccXform.addNote("creditCard", xForm.noteTypes.Alert, err_msg)

                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If bIsValid Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        ccXform.valid = bIsValid
                    Else
                        ccXform.valid = False
                    End If

                    payMetaCharge = ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payMetaCharge", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payAuthorizeNet(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payMetaCharge")
                Dim oRequest As HttpWebRequest
                Dim oResponse As HttpWebResponse
                Dim oStream As System.IO.Stream
                Dim oStreamReader As StreamReader

                Dim cResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim sSql As String

                Dim cMessage As String = ""

                Dim ccXform As xForm

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim oDictOpt As New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3dSecure As Boolean = False
                Dim oResponseDict As Hashtable = Nothing
                Dim oCartAdd As XmlNode
                Dim b3dAuthorised As Boolean = False

                Dim oElmt As XmlElement

                Dim oPPCfg As XmlNode
                Dim cIPAddress As String = goRequest.ServerVariables("REMOTE_ADDR")

                Dim cProcessInfo As String = "payAuthorizeNet"
                Dim sAPIVer As String = "3.1"
                Dim sAPIURL As String = ""
                Dim bTest As Boolean = True
                Try

                    'Get the payment options into a hashtable
                    oPPCfg = moPaymentCfg.SelectSingleNode("provider[@name='AuthorizeNet']")
                    For Each oElmt In oPPCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='Billing Address']")

                    If oDictOpt("validateCV2") = "on" Then bCv2 = True

                    'Load the Xform
                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, oDictOpt("cardsAccepted"), True, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & mcCurrency & " by Credit/Debit Card")

                    Select Case oDictOpt("opperationMode")
                        Case "live"
                            sAPIURL = "https://secure.authorize.net/gateway/transact.dll"
                            bTest = False
                        Case "true"
                            sAPIURL = "https://test.authorize.net/gateway/transact.dll"
                        Case "false"
                            sAPIURL = "https://test.authorize.net/gateway/transact.dll"

                    End Select

                    If ccXform.valid = True Or b3dAuthorised Then

                        'standard card validation request
                        cRequest = "x_version=" & sAPIVer & "&"
                        cRequest = cRequest & "x_delim_data=True&"
                        cRequest = cRequest & "x_relay_response=False&"
                        cRequest = cRequest & "x_login=" & goServer.UrlEncode(oDictOpt("accountId")) & "&"
                        cRequest = cRequest & "x_tran_key=" & goServer.UrlEncode(oDictOpt("transactionKey")) & "&"
                        If bTest Then
                            cRequest = cRequest & "x_test_request=TRUE&"
                        End If
                        cRequest = cRequest & "x_amount=" & goServer.UrlEncode(CStr(mnPaymentAmount)) & "&"
                        cRequest = cRequest & "x_currency_code=" & mcCurrency & "&"
                        cRequest = cRequest & "x_method=CC&"
                        cRequest = cRequest & "x_type=" & oDictOpt("transactionType") & "&"
                        cRequest = cRequest & "x_card_num=" & goServer.UrlEncode(FormatCreditCardNumber(goRequest("creditCard/number"))) & "&"
                        cRequest = cRequest & "x_exp_date=" & fmtSecPayDate(goRequest("creditCard/expireDate")) & "&"
                        If bCv2 Then
                            cRequest = cRequest & "x_card_code=" & goServer.UrlEncode(CStr(goRequest("creditCard/CV2"))) & "&"
                        End If

                        cRequest = cRequest & "x_invoice_num=" & goServer.UrlEncode(CStr(mnCartId)) & "&"
                        cRequest = cRequest & "x_description=" & goServer.UrlEncode(mcPaymentOrderDescription) & "&"
                        cRequest = cRequest & getAutorizeNetOrder(oRoot)
                        cRequest = cRequest & "x_customer_ip=" & goRequest.ServerVariables("REMOTE_ADDR") & "&"

                        cRequest = cRequest & "x_last_name=" & goServer.UrlEncode(mcCardHolderName) & "&"
                        cRequest = cRequest & "x_address=" & goServer.UrlEncode(mcCardHolderAddress) & "&"
                        cRequest = cRequest & "x_city=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("City").InnerText) & "&"
                        'cRequest = cRequest & "strState=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("State").InnerText) & "&"
                        cRequest = cRequest & "x_zip=" & goServer.UrlEncode(mcCardHolderPostcode) & "&"
                        cRequest = cRequest & "x_country=" & getCountryISO2Code((oCartAdd.SelectSingleNode("Country").InnerText)) & "&"  '2 letter ISO code
                        cRequest = cRequest & "x_phone=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Telephone").InnerText) & "&"
                        cRequest = cRequest & "x_fax=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Fax").InnerText) & "&"

                        If oCartAdd.SelectSingleNode("Email").InnerText <> "" Then
                            cRequest = cRequest & "x_email=" & goServer.UrlEncode(oCartAdd.SelectSingleNode("Email").InnerText) & "&"
                            cRequest = cRequest & "x_email_customer=" & goServer.UrlEncode(oDictOpt("emailCustomer")) & "&"
                        End If

                        'If Not goRequest("creditCard/issueDate") = "" Then
                        '    cRequest = cRequest & "strStartDate=" & fmtSecPayDate(goRequest("creditCard/issueDate")) & "&"
                        'End If
                        'cRequest = cRequest & "intCV2=" & goServer.UrlEncode(CStr(goRequest("creditCard/CV2"))) & "&"
                        'cRequest = cRequest & "strIssueNo=" & goServer.UrlEncode(goRequest("creditCard/issueNumber")) & "&"
                        'cRequest = cRequest & "strCardType=" & goServer.UrlEncode(goRequest("creditCard/type")) & "
                        ' 
                        ' Convert the request to bytes

                        byRequest = oEncoding.GetBytes(cRequest)

                        oRequest = HttpWebRequest.Create(sAPIURL)
                        oRequest.ContentType = "application/x-www-form-urlencoded"
                        oRequest.ContentLength = byRequest.Length
                        oRequest.Method = "POST"
                        oStream = oRequest.GetRequestStream
                        oStream.Write(byRequest, 0, byRequest.Length)
                        oStream.Close()

                        oResponse = oRequest.GetResponse()
                        oStream = oResponse.GetResponseStream()
                        oStreamReader = New StreamReader(oStream, System.Text.Encoding.UTF8)
                        cResponse = oStreamReader.ReadToEnd

                        oStreamReader.Close()
                        oResponse.Close()

                        ' Validate the response.

                        If cResponse = "" Then
                            err_msg = "There was a communications error."
                        Else
                            ' lets take the response and put it in a hash table
                            cProcessInfo = "error tranlating response:" & cResponse
                            Dim aResponse As Array = Split(" |" & cResponse, "|")

                            Select Case aResponse(1)
                                Case "3"
                                    ' Error 
                                    err_msg_log = aResponse(3) & " desc:" & aResponse(4)

                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If

                                Case "2"
                                    ' Failed / Error Authorisation
                                    cMessage = oResponseDict("strMessage")

                                    If InStr(cMessage, "card number") > 0 Then ccXform.addNote("creditCard/number", xForm.noteTypes.Alert, "The card number given is not valid.")
                                    If InStr(cMessage, "IssueNumber") > 0 Then ccXform.addNote("creditCard/issueNumber", xForm.noteTypes.Alert, "The issue number is not valid - it may not be required for non-Switch/Solo cards.")
                                    If InStr(cMessage, "StartDate") > 0 Or InStr(cMessage, "Start Date") > 0 Then ccXform.addNote("creditCard/issueDate", xForm.noteTypes.Alert, "The issue date is not valid - it may not be required for Switch or Solo cards.")
                                    If InStr(cMessage, "ExpiryDate") > 0 Or InStr(cMessage, "Expiry Date") > 0 Then ccXform.addNote("creditCard/expireDate", xForm.noteTypes.Alert, "The expiry date is not valid.")

                                    err_msg_log = cMessage

                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If

                                Case "1"
                                    ' Successful Authorisation
                                    err_msg = "Payment was successful. Transaction ref: " & aResponse(5)
                                    bIsValid = True
                                    Dim oDate As New Date("20" & Right(goRequest("creditCard/expireDate"), 2), CInt(Left(goRequest("creditCard/expireDate"), 2)), 1)
                                    oDate = oDate.AddMonths(1)
                                    oDate = oDate.AddDays(-1)
                                    Dim cMethodName As String = goRequest("creditCard/type") & ": " & MaskString(goRequest("creditCard/number"), "*", False, 4) & " Expires: " & oDate.ToShortDateString
                                    savePayment(myWeb.mnUserId, "AuthoizeNet", mnCartId, cMethodName, ccXform.Instance.FirstChild, oDate, True, mnPaymentAmount)
                                Case Else


                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & aResponse(1)
                                    Else
                                        err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If
                            End Select

                        End If

                        'Update Seller Notes:
                        ccXform.addNote("creditCard", xForm.noteTypes.Alert, err_msg)

                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If bIsValid Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg_log
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        ccXform.valid = bIsValid
                    Else
                        ccXform.valid = False
                    End If

                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payAuthorizeNet", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Private Function getAutorizeNetOrder(ByRef oRoot As XmlElement) As String

                PerfMon.Log("PaymentProviders", "getSecPayOrder")
                Dim sOrder As String
                Dim cProcessInfo As String = "getSecPayOrder"
                Dim oItem As XmlElement
                Dim nCount As Long = 1
                Dim cIsTaxable As String = "N"
                Try
                    If CInt("0" & oRoot.SelectSingleNode("@vatAmt").InnerText) > 0 Then
                        cIsTaxable = "Y"
                    End If
                    sOrder = ""
                    For Each oItem In oRoot.SelectNodes("Item")
                        If nCount < 30 Then
                            'we can only add 30 lines here
                            sOrder = sOrder & "x_line_item=item" & nCount & "<|>" & Replace(oItem.SelectSingleNode("Name").InnerText, " ", "_")
                            sOrder = sOrder & "<|><|>" & oItem.SelectSingleNode("@quantity").InnerText & "<|>" & oItem.SelectSingleNode("@price").InnerText & "<|>" & cIsTaxable & "&"
                        End If
                        nCount = nCount + 1
                    Next
                    'add the shipping
                    If CInt("0" & oRoot.SelectSingleNode("@shippingCost").InnerText) > 0 Then
                        sOrder = sOrder & "x_freight=" & oRoot.SelectSingleNode("@shippingCost").InnerText & "&"
                    End If
                    'add the tax
                    If CInt("0" & oRoot.SelectSingleNode("@vatAmt").InnerText) > 0 Then
                        sOrder = sOrder & "x_tax=" & oRoot.SelectSingleNode("@vatAmt").InnerText & "&"
                    End If

                    Return sOrder

                Catch ex As Exception
                    returnException(mcModuleName, "getAutorizeNetOrder", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payWorldPay(ByRef oRoot As XmlElement, ByVal sSubmitPath As String, ByVal nPageId As Long) As xForm
                PerfMon.Log("PaymentProviders", "payWorldPay")

                Dim sSql As String

                Dim oCartAdd As XmlNode
                Dim sAddress As String = ""
                Dim cCurrentURL As String = "http"
                Dim wpXform As xForm = New xForm
                Dim sProcessInfo As String = ""
                Dim oElmt As XmlElement
                Dim oPPCfg As XmlNode
                Dim oDictOpt As New Hashtable
                Dim bCv2 As Boolean = False
                Dim cProcessInfo As String = "payWorldPay"
                Try

                    'Get the payment options into a hashtable
                    oPPCfg = moPaymentCfg.SelectSingleNode("provider[@name='WorldPay']")
                    For Each oElmt In oPPCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    ' Get the Billing Address node and details
                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='Billing Address']")
                    If Not oCartAdd.SelectSingleNode("Street") Is Nothing Then
                        sAddress = sAddress & oCartAdd.SelectSingleNode("Street").InnerText & "&#10;"
                    End If

                    If Not oCartAdd.SelectSingleNode("City") Is Nothing Then
                        sAddress = sAddress & oCartAdd.SelectSingleNode("City").InnerText & "&#10;"
                    End If

                    If Not oCartAdd.SelectSingleNode("State") Is Nothing Then
                        sAddress = sAddress & oCartAdd.SelectSingleNode("State").InnerText & "&#10;"
                    End If

                    ' Create a new xform
                    wpXform.moPageXML = moPageXml
                    wpXform.NewFrm("PayForm")
                    wpXform.Instance.InnerXml = "<instId/><cartId/><amount/><currency/><desc/><testMode/><accId1/><name/><address/><postcode/><country/><tel/><email/><MC_callback/><MC_pgid/><onLoad/>"
                    wpXform.valid = False

                    ' Add the values
                    wpXform.Instance.SelectSingleNode("instId").InnerText = oDictOpt("InstallationID")
                    wpXform.Instance.SelectSingleNode("cartId").InnerText = CStr(mnCartId)
                    wpXform.Instance.SelectSingleNode("amount").InnerText = CStr(mnPaymentAmount)
                    wpXform.Instance.SelectSingleNode("currency").InnerText = oDictOpt("Currency")
                    wpXform.Instance.SelectSingleNode("desc").InnerText = getWorldPayOrder(oRoot)
                    wpXform.Instance.SelectSingleNode("accId1").InnerText = oDictOpt("AccountID")
                    Select Case oDictOpt("TestMode")
                        Case "0"
                            wpXform.Instance.SelectSingleNode("testMode").InnerText = oDictOpt("TestMode")
                            wpXform.Instance.SelectSingleNode("name").InnerText = mcCardHolderName
                        Case Else
                            wpXform.Instance.SelectSingleNode("testMode").InnerText = "100"
                            wpXform.Instance.SelectSingleNode("name").InnerText = oDictOpt("TestMode")
                    End Select
                    wpXform.Instance.SelectSingleNode("address").InnerText = sAddress
                    wpXform.Instance.SelectSingleNode("postcode").InnerText = oCartAdd.SelectSingleNode("PostalCode").InnerText
                    wpXform.Instance.SelectSingleNode("country").InnerText = getCountryISO2Code((oCartAdd.SelectSingleNode("Country").InnerText))
                    wpXform.Instance.SelectSingleNode("tel").InnerText = oCartAdd.SelectSingleNode("Telephone").InnerText
                    wpXform.Instance.SelectSingleNode("email").InnerText = oCartAdd.SelectSingleNode("Email").InnerText
                    wpXform.Instance.SelectSingleNode("MC_pgid").InnerText = nPageId

                    If IsDBNull(oDictOpt("CallbackURL")) Or oDictOpt("CallbackURL") = "" Then
                        ' No callback URL, let's get the current page.
                        If goRequest.ServerVariables("HTTPS") = "on" Then cCurrentURL = cCurrentURL & "s"
                        cCurrentURL = cCurrentURL & "://" & goRequest.ServerVariables("SERVER_NAME") & goRequest.ServerVariables("PATH_INFO")
                        wpXform.Instance.SelectSingleNode("MC_callback").InnerText = cCurrentURL
                    Else
                        '/ewcommon/tools/cartCallback.ashx?provider=WorldPay
                        wpXform.Instance.SelectSingleNode("MC_callback").InnerText = oDictOpt("CallbackURL")
                    End If

                    'TS possbily this should be the logic
                    'If goRequest.ServerVariables("HTTPS") = "on" Then cCurrentURL = cCurrentURL & "s"
                    'cCurrentURL = cCurrentURL & "://" & goRequest.ServerVariables("SERVER_NAME") & "/ewcommon/tools/cartCallback.ashx?provider=WorldPay"
                    'wpXform.Instance.SelectSingleNode("MC_callback").InnerText = cCurrentURL

                    ' Create the group
                    Dim formGroup As XmlElement = wpXform.addGroup(wpXform.moXformElmt, "creditCard", , "Proceed with Payment")
                    wpXform.addInput(formGroup, "instId", False, "", "hidden")
                    wpXform.addInput(formGroup, "cartId", False, "", "hidden")
                    wpXform.addInput(formGroup, "amount", False, "", "hidden")
                    wpXform.addInput(formGroup, "currency", False, "", "hidden")
                    wpXform.addInput(formGroup, "desc", False, "", "hidden")
                    wpXform.addInput(formGroup, "testMode", False, "", "hidden")
                    wpXform.addInput(formGroup, "accId1", False, "", "hidden")
                    wpXform.addInput(formGroup, "name", False, "", "hidden")
                    wpXform.addInput(formGroup, "address", False, "", "hidden")
                    wpXform.addInput(formGroup, "postcode", False, "", "hidden")
                    wpXform.addInput(formGroup, "country", False, "", "hidden")
                    wpXform.addInput(formGroup, "tel", False, "", "hidden")
                    wpXform.addInput(formGroup, "email", False, "", "hidden")
                    wpXform.addInput(formGroup, "MC_callback", False, "", "hidden")
                    wpXform.addInput(formGroup, "MC_pgid", False, "", "hidden")

                    ' Only add the onLoad event if we are not coming back from WorldPay.
                    If goRequest("transStatus") Is Nothing Then
                        wpXform.Instance.SelectSingleNode("onLoad").InnerText = "document.getElementById('submitpayform').submit();"
                        wpXform.addInput(formGroup, "onLoad", False, "", "hidden")
                    End If

                    ' Sort out the submission
                    Select Case oDictOpt("TestMode")
                        Case "0"
                            wpXform.submission("submitpayform", "https://select.worldpay.com/wcc/purchase", "POST", )
                        Case Else
                            wpXform.submission("submitpayform", "https://select-test.worldpay.com/wcc/purchase", "POST", )
                    End Select
                    Dim buttonGroup As XmlElement = wpXform.addGroup(wpXform.moXformElmt, "buttons", , "")
                    wpXform.addSubmit(buttonGroup, "submitpayform", "Proceed with Payment", "submitpayform", "principle")

                    ' Add hint
                    wpXform.addNote("creditCard", xForm.noteTypes.Help, "Click ""Proceed with Payment"" to enter your payment details. You will then be transferred to the secure WorldPay server.")

                    If Not (goRequest("transStatus") Is Nothing) Then

                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId

                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Cart").Rows
                            If goRequest("transStatus") = "Y" Then
                                oRow("cSellerNotes").Value = oRow("cSellerNotes").Value & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf
                                wpXform.valid = True
                            Else
                                oRow("cSellerNotes").Value = oRow("cSellerNotes").Value & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf
                                wpXform.addNote("creditCard", xForm.noteTypes.Alert, "The payment was not processed.  Either there was an issue processing the payment or you cancelled the payment stage.  Click ""Proceed with Payment"" if you wish to try again.")
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                    End If

                    wpXform.addValues()
                    payWorldPay = wpXform

                Catch ex As Exception
                    returnException(mcModuleName, "paySecPay", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payNetBanx(ByRef oRoot As XmlElement, ByVal sSubmitPath As String, ByVal nPageId As Long) As xForm
                PerfMon.Log("PaymentProviders", "payNetBanx")

                Dim sSql As String

                Dim oCartAdd As XmlNode
                Dim sAddress As String = ""

                Dim wpXform As xForm = New xForm
                Dim sProcessInfo As String = ""
                Dim oDictOpt As Hashtable
                Dim bCv2 As Boolean = False
                Dim cProcessInfo As String = "payNetBanx"
                Dim oNetBanxCfg As XmlNode
                Dim cCurrentDomain As String = "http"
                Dim cCurrentURL As String
                Try

                    If goRequest.ServerVariables("HTTPS") = "on" Then cCurrentDomain = cCurrentDomain & "s"
                    cCurrentDomain = cCurrentDomain & "://" & goRequest.ServerVariables("SERVER_NAME")
                    cCurrentURL = cCurrentDomain & goRequest.ServerVariables("PATH_INFO")

                    oNetBanxCfg = moPaymentCfg.SelectSingleNode("provider[@name='NetBanx']")
                    oDictOpt = xmlTools.xmlToHashTable(oNetBanxCfg, "value")


                    ' Get the Billing Address node and details
                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='Billing Address']")
                    If Not oCartAdd.SelectSingleNode("Street") Is Nothing Then
                        sAddress = sAddress & oCartAdd.SelectSingleNode("Street").InnerText & "&#10;"
                    End If
                    'If Not oCartAdd.SelectSingleNode("Address/City") Is Nothing Then
                    '    sAddress = sAddress & oCartAdd.SelectSingleNode("City").InnerText & "&#10;"
                    'End If
                    'If Not oCartAdd.SelectSingleNode("Address/State") Is Nothing Then
                    '    sAddress = sAddress & oCartAdd.SelectSingleNode("State").InnerText & "&#10;"
                    'End If

                    ' Create a new xform
                    wpXform.moPageXML = moPageXml
                    wpXform.NewFrm("PayForm")
                    wpXform.Instance.InnerXml = "<nbx_payment_amount/><nbx_currency_code/><nbx_merchant_reference/><nbx_checksum/><nbx_language/><nbx_payment_type/><nbx_success_url/><nbx_failure_url/><nbx_success_redirect_url/><nbx_failure_redirect_url/><nbx_email/><nbx_cardholder_name/><nbx_houseno/><nbx_postcode/><nbx_success_show_content/><nbx_failure_show_content/>"
                    wpXform.valid = False

                    ' Add the values
                    wpXform.Instance.SelectSingleNode("nbx_payment_amount").InnerText = Replace(CStr(FormatNumber(mnPaymentAmount, 2)), ".", "")
                    wpXform.Instance.SelectSingleNode("nbx_currency_code").InnerText = oDictOpt("currency")
                    wpXform.Instance.SelectSingleNode("nbx_merchant_reference").InnerText = CStr(mnCartId)
                    Dim cHash As String = Replace(CStr(FormatNumber(mnPaymentAmount, 2)), ".", "") & oDictOpt("currency") & CStr(mnCartId) & oDictOpt("secretkey")
                    wpXform.Instance.SelectSingleNode("nbx_checksum").InnerText = Protean.Tools.Encryption.HashString(cHash, "SHA1", True)
                    wpXform.Instance.SelectSingleNode("nbx_language").InnerText = oDictOpt("language")
                    wpXform.Instance.SelectSingleNode("nbx_payment_type").InnerText = oDictOpt("paymentType")
                    wpXform.Instance.SelectSingleNode("nbx_success_url").InnerText = cCurrentDomain & "/ewcommon/tools/cartcallback.ashx?provider=NetBanx"
                    wpXform.Instance.SelectSingleNode("nbx_failure_url").InnerText = cCurrentDomain & "/ewcommon/tools/cartcallback.ashx?provider=NetBanx"
                    wpXform.Instance.SelectSingleNode("nbx_success_redirect_url").InnerText = cCurrentURL & "?cartCmd=SubmitPaymentDetails&nbx=success"
                    wpXform.Instance.SelectSingleNode("nbx_failure_redirect_url").InnerText = cCurrentURL & "?cartCmd=SubmitPaymentDetails&nbx=failure"

                    wpXform.Instance.SelectSingleNode("nbx_email").InnerText = oCartAdd.SelectSingleNode("Email").InnerText
                    wpXform.Instance.SelectSingleNode("nbx_cardholder_name").InnerText = mcCardHolderName
                    wpXform.Instance.SelectSingleNode("nbx_houseno").InnerText = sAddress
                    wpXform.Instance.SelectSingleNode("nbx_postcode").InnerText = oCartAdd.SelectSingleNode("PostalCode").InnerText
                    wpXform.Instance.SelectSingleNode("nbx_success_show_content").InnerText = "1"
                    wpXform.Instance.SelectSingleNode("nbx_failure_show_content").InnerText = "1"

                    ' Create the group
                    wpXform.addGroup(wpXform.moXformElmt, "NetBanx", , "Proceed to NetBanx")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_payment_amount", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_currency_code", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_merchant_reference", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_checksum", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_language", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_payment_type", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_success_url", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_failure_url", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_success_redirect_url", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_failure_redirect_url", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_email", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_cardholder_name", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_houseno", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_postcode", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_success_show_content", False, "", "hidden")
                    wpXform.addInput(wpXform.moXformElmt, "nbx_failure_show_content", False, "", "hidden")

                    Dim submitUrl As String = "https://pay.netbanx.com/" & oDictOpt("accountId")
                    If oDictOpt("mode") = LCase("test") Then
                        submitUrl = "https://pay.test.netbanx.com/" & oDictOpt("accountId")
                    End If
                    ' Sort out the submission
                    wpXform.submission("submitpayform", submitUrl, "POST", )
                    wpXform.addSubmit(wpXform.moXformElmt, "submitpayform", "Proceed with Payment", "submitpayform", "principle")

                    ' Add hint
                    wpXform.addNote("NetBanx", xForm.noteTypes.Help, "Click ""Proceed with Payment"" You will then be transferred to the secure NetBanx server.")

                    If goRequest("nbx") <> "" Then
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables(0).Rows
                            Select Case goRequest("nbx")
                                Case "success"
                                    'Update Seller Notes:
                                    oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Customer Redirect Success) " & vbLf
                                    wpXform.valid = True
                                Case "failure"
                                    oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Customer Redirect Failure) " & vbLf
                                    wpXform.addNote("NetBanx", xForm.noteTypes.Help, "<span id=""Trans-104"">The payment was not processed.  Either there was an issue processing the payment or you cancelled the payment stage.  Click ""Proceed with Payment"" if you wish to try again.</span>")
                            End Select
                        Next
                        modbHelper.updateDataset(oDs, "Order")
                    End If
                    wpXform.addValues()
                    Return wpXform

                Catch ex As Exception
                    returnException(mcModuleName, "payNetBanx", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function paySecureEmail(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "paySecureEmail")
                Dim sSql As String
                Dim ccXform As xForm
                Dim sProcessInfo As String = ""
                Dim sCardAccepted As String = ""


                Dim bCv2 As Boolean = False
                Dim bEncrypt As Boolean = False
                Dim oSecEmailCfg As XmlNode

                Dim cProcessInfo As String = "paySecureEmail"
                Try

                    oSecEmailCfg = moPaymentCfg.SelectSingleNode("provider[@name='Secure Email']")

                    If oSecEmailCfg Is Nothing Then
                        Err.Raise(1005, "paySecureEmail", "The Secure Email provider section is yet to be added to the Protean.Config")
                    End If

                    Dim cGnuDirectory As String = oSecEmailCfg.SelectSingleNode("GnuDirectory/@value").InnerText
                    Dim cGnuOriginator As String = oSecEmailCfg.SelectSingleNode("GnuOriginator/@value").InnerText
                    Dim cGnuPassphrase As String = oSecEmailCfg.SelectSingleNode("GnuPassphrase/@value").InnerText

                    mcCartEmailTextXslt = oSecEmailCfg.SelectSingleNode("textEmailTemplate/@value").InnerText
                    sCardAccepted = oSecEmailCfg.SelectSingleNode("cardsAccepted/@value").InnerText
                    If oSecEmailCfg.SelectSingleNode("validateCV2/@value").InnerText = "on" Then bCv2 = True

                    ccXform = creditCardXform(oRoot, "PayForm", sSubmitPath, sCardAccepted, bCv2, "Make Payment of " & FormatNumber(mnPaymentAmount, 2) & " " & mcCurrency & " by Credit/Debit Card")

                    If ccXform.valid = True Then

                        'Validate Card
                        If cGnuDirectory <> "" Then
                            bEncrypt = True
                        Else
                            bEncrypt = False
                        End If

                        ' Add the card details to the cart
                        oRoot.SetAttribute("CardNumber", goRequest("creditCard/number"))
                        oRoot.SetAttribute("IssueDate", goRequest("creditCard/issueDate"))
                        oRoot.SetAttribute("ExpiryDate", goRequest("creditCard/expireDate"))
                        oRoot.SetAttribute("CardType", goRequest("creditCard/type"))
                        oRoot.SetAttribute("IssueNumber", goRequest("creditCard/issueNumber"))
                        oRoot.SetAttribute("CV2", goRequest("creditCard/CV2"))

                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId

                        'Send the card details via Secure Email
                        Dim oMsg As Messaging = New Messaging
                        oMsg.mbEncrypt = True
                        oMsg.msGnuDirectory = cGnuDirectory
                        oMsg.msGnuOriginator = cGnuOriginator
                        oMsg.msGnuPassphrase = cGnuPassphrase
                        Dim sResponse As String
                        sResponse = oMsg.emailer(oRoot, mcCartEmailTextXslt, "SecureEmail", "secure@eonic.co.uk", mcCartEmailAddress, "Secure Payment Details")
                        oMsg = Nothing

                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            If sResponse = "Message Sent" Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Secure Email Sent) " & vbLf
                            Else
                                ccXform.valid = False
                                ccXform.addNote(ccXform.moXformElmt, xForm.noteTypes.Alert, sResponse)
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Secure Email Failed:" & sResponse & ") " & vbLf
                            End If
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        'If Not (mcCartEmailTextXslt <> "") Then mcCartEmailTextXslt = "/ewcommon/xsl/Cart/mailcarttextV3_0.xsl"

                    Else
                        ccXform.valid = False
                    End If

                    paySecureEmail = ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "paySecureEmail", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payDirectDebitSecureEmail(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payDirectDebitSecureEmail")
                Dim sSql As String
                Dim ddXform As New xForm
                Dim sProcessInfo As String = ""
                Dim sCardAccepted As String = ""
                Dim cXFormPath As String = ""
                Dim oFrmGroup As XmlElement

                Dim action As String = sSubmitPath
                Dim bCv2 As Boolean = False
                Dim bEncrypt As Boolean = False
                Dim oSecEmailCfg As XmlNode
                Dim formname As String = "payDirectDebitSecureEmail"
                Dim cProcessInfo As String = "payDirectDebitSecureEmail"
                Try

                    oSecEmailCfg = moPaymentCfg.SelectSingleNode("provider[@name='DirectDebitSecureEmail']")

                    If oSecEmailCfg Is Nothing Then
                        Err.Raise(1005, "payDirectDebitSecureEmail", "The DirectDebitSecureEmail provider section is yet to be added to the Protean.Config")
                    End If

                    Dim cGnuDirectory As String = oSecEmailCfg.SelectSingleNode("GnuDirectory/@value").InnerText
                    Dim cGnuOriginator As String = oSecEmailCfg.SelectSingleNode("GnuOriginator/@value").InnerText
                    Dim cGnuPassphrase As String = oSecEmailCfg.SelectSingleNode("GnuPassphrase/@value").InnerText
                    mcCartEmailAddress = oSecEmailCfg.SelectSingleNode("merchantEmail/@value").InnerText


                    mcCartEmailTextXslt = oSecEmailCfg.SelectSingleNode("textEmailTemplate/@value").InnerText

                    If Not oSecEmailCfg.SelectSingleNode("xform/@value") Is Nothing Then
                        cXFormPath = oSecEmailCfg.SelectSingleNode("xform/@value").InnerText()
                    End If

                    'Reference together the root Xml from objects
                    ddXform.moPageXML = Me.moPageXml

                    If cXFormPath <> "" Then
                        If Not ddXform.load(cXFormPath) Then
                            ddXform.NewFrm(formname)
                            oFrmGroup = ddXform.addGroup(ddXform.moXformElmt, "notes", , "Missing File: " & cXFormPath)
                        Else
                            'add missing submission or submit buttons
                            If ddXform.moXformElmt.SelectSingleNode("model/instance/submission") Is Nothing Then
                                ddXform.submission(formname, action, "POST", "return form_check(this);")
                            End If
                            If ddXform.moXformElmt.SelectSingleNode("descendant-or-self::submit") Is Nothing Then
                                ddXform.addSubmit(ddXform.moXformElmt, formname, "Place Order", "placeOrder")
                            End If
                        End If
                    Else
                        Err.Raise(1005, "payDirectDebitSecureEmail", "The DirectDebitSecureEmail xform location no specified.")
                    End If

                    If ddXform.isSubmitted Then
                        ddXform.updateInstanceFromRequest()
                        ddXform.validate()

                        If ddXform.valid = True Then

                            ' Check for validating services.
                            Dim postCodeAnywhereBankingKeyElement As XmlElement = Nothing
                            Dim postCodeAnywhereBankingKey As String = ""
                            Dim accountNumber As String = ""
                            Dim sortCode As String = ""
                            If Tools.Xml.NodeState(oSecEmailCfg, "PostCodeAnywhereBankingKey", , , , postCodeAnywhereBankingKeyElement) <> Tools.Xml.XmlNodeState.NotInstantiated _
                                AndAlso postCodeAnywhereBankingKeyElement.GetAttribute("value") <> "" Then
                                If Tools.Xml.NodeState(ddXform.Instance, "DirectDebit/BankAccountNumber", , , , , , accountNumber) = Tools.Xml.XmlNodeState.HasContents _
                                    AndAlso Tools.Xml.NodeState(ddXform.Instance, "DirectDebit/BankSortCode", , , , , , sortCode) = Tools.Xml.XmlNodeState.HasContents Then

                                    postCodeAnywhereBankingKey = postCodeAnywhereBankingKeyElement.GetAttribute("value")

                                    Try

                                        Dim paService As Protean.uk.co.postcodeanywhere.services.PostcodeAnywhere = New Protean.uk.co.postcodeanywhere.services.PostcodeAnywhere()

                                        Dim paResponses() As Protean.uk.co.postcodeanywhere.services.BankAccountValidation_Interactive_Validate_v2_00_Results = paService.BankAccountValidation_Interactive_Validate_v2_00(postCodeAnywhereBankingKey, accountNumber, sortCode)


                                        If paResponses.Length > 0 Then
                                            For Each paResponse As Protean.uk.co.postcodeanywhere.services.BankAccountValidation_Interactive_Validate_v2_00_Results In paResponses

                                                If Not paResponse.IsCorrect Then
                                                    ddXform.valid = False
                                                    addNote(ddXform.RootGroup, noteTypes.Alert, "<span class=""msg-20001"">Your sort code and account number could not be validated for Direct Debit.  Please check you have entered the correct information and retry.</span>")

                                                ElseIf Not paResponse.IsDirectDebitCapable Then
                                                    ddXform.valid = False
                                                    addNote(ddXform.RootGroup, noteTypes.Alert, "<span class=""msg-20002"">The account number and sort code provided do not have Direct Debit enabled.  Please check you have entered the correct information and retry.</span>")

                                                End If

                                            Next
                                        Else
                                            ddXform.valid = False
                                            addNote(ddXform.RootGroup, noteTypes.Alert, "<span class=""msg-20003"">Your sort code and account number could not be validated for Direct Debit.  Please check you have entered the correct information and retry.</span>")
                                        End If


                                    Catch paException As System.Web.Services.Protocols.SoapException
                                        ' If the web service returns an error - it will be here.
                                        ddXform.valid = False

                                        ' Try to determine the cause, format should be 100N: Message
                                        Dim messageMatch As Match = Regex.Match(paException.Message, "^(\d+):\s(.*)$")

                                        If messageMatch.Success Then
                                            Select Case messageMatch.Groups(1).ToString
                                                Case "1002", "1001"
                                                    ddXform.addNote("BankSortCode", noteTypes.Alert, "<span class=""msg-20004"">You must supply a valid sort code</span>")

                                                Case "1004", "1003"
                                                    ddXform.addNote("AcctNumber", noteTypes.Alert, "<span class=""msg-20005"">You must supply a valid account number</span>")

                                                Case Else
                                                    ddXform.addNote(ddXform.RootGroup, noteTypes.Alert, "<span class=""msg-20006"">Your direct debit details could not be validated. " & paException.Message & "</span>")
                                            End Select
                                        Else
                                            Throw paException
                                        End If


                                    Catch otherException As Exception
                                        ddXform.valid = False
                                        Throw otherException

                                    End Try
                                End If
                            End If
                        End If

                        If ddXform.valid = True Then

                            'Validate Card
                            If cGnuDirectory <> "" Then
                                bEncrypt = True
                            Else
                                bEncrypt = False
                            End If

                            'Update Seller Notes:
                            sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId

                            'Send the card details via Secure Email
                            Dim oMsg As Messaging = New Messaging
                            oMsg.mbIsBodyHtml = False

                            If cGnuDirectory <> "" Then
                                oMsg.mbEncrypt = True
                                oMsg.msGnuDirectory = cGnuDirectory
                                oMsg.msGnuOriginator = cGnuOriginator
                                oMsg.msGnuPassphrase = cGnuPassphrase
                            End If

                            oRoot.AppendChild(ddXform.Instance.FirstChild.CloneNode(True))


                            savePayment(myWeb.mnUserId, "DirectDebitSecureEmail", mnCartId, "", ddXform.Instance.FirstChild, Now, False, mnPaymentAmount)

                            Dim sResponse As String
                            sResponse = oMsg.emailer(oRoot, mcCartEmailTextXslt, "SecureEmail", "secure@eonic.co.uk", mcCartEmailAddress, "Secure Payment Details")
                            oMsg = Nothing

                            Dim oDs As DataSet
                            Dim oRow As DataRow
                            oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                            For Each oRow In oDs.Tables("Order").Rows
                                If sResponse = "Message Sent" Then
                                    oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Secure Email Sent) " & vbLf
                                Else
                                    ddXform.valid = False
                                    ddXform.addNote(ddXform.moXformElmt, xForm.noteTypes.Alert, sResponse)
                                    oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Secure Email Failed:" & sResponse & ") " & vbLf
                                End If
                            Next
                            modbHelper.updateDataset(oDs, "Order")
                        End If

                        ddXform.addValues()

                        'validate the Xform if it has been submitted.



                        'If Not (mcCartEmailTextXslt <> "") Then mcCartEmailTextXslt = "/ewcommon/xsl/Cart/mailcarttextV3_0.xsl"

                    Else
                        ddXform.valid = False
                    End If

                    Return ddXform

                Catch ex As Exception
                    returnException(mcModuleName, "payDirectDebitSecureEmail", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Public Overridable Function payOnAccount(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payOnAccount")
                Dim sSql As String
                Dim ccXform As Protean.Cms.xForm = New xForm(myWeb)
                Dim sProcessInfo As String = ""
                Dim bCv2 As Boolean = False
                Dim bEncrypt As Boolean = False

                Dim formname As String = "PayForm"
                Dim action As String = sSubmitPath
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement

                Dim cPaymentDetails As String = ""
                Dim oElmt As XmlElement

                Dim mcAccountXForm As String = ""

                'Get the payment options into a hashtable
                Dim oAccountCfg As XmlNode
                Dim oDs As DataSet
                Dim oRow As DataRow

                Dim cProcessInfo As String = "payOnAccount"
                Try
                    'Get the payment options into a hashtable
                    oAccountCfg = moPaymentCfg.SelectSingleNode("provider[@name='Pay On Account' or @name='PayOnAccount']")
                    If oAccountCfg Is Nothing Then
                        Err.Raise(1003, "payOnAccount", "The Pay On Account provider section is yet to be added to the Protean.Config")
                    End If
                    If Not oAccountCfg.SelectSingleNode("AccountXform/@value") Is Nothing Then
                        mcAccountXForm = oAccountCfg.SelectSingleNode("AccountXform/@value").InnerText()
                    End If

                    'Reference together the root Xml from objects
                    ccXform.moPageXML = Me.moPageXml

                    If mcAccountXForm <> "" Then
                        If Not ccXform.load(mcAccountXForm) Then
                            ccXform.NewFrm(formname)
                            oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "notes", , "Missing File: " & mcAccountXForm)
                        Else
                            'add missing submission or submit buttons
                            If ccXform.moXformElmt.SelectSingleNode("model/instance/submission") Is Nothing Then
                                ccXform.submission(formname, action, "POST", "return form_check(this);")
                            End If
                            If ccXform.moXformElmt.SelectSingleNode("descendant-or-self::submit") Is Nothing Then
                                ccXform.addSubmit(ccXform.moXformElmt, formname, "Place Order", "placeOrder")
                            End If
                        End If
                    Else
                        'First Define the xform
                        ccXform.NewFrm(formname)
                        ccXform.submission(formname, action, "POST", "")
                        'ccXform.submission(formname, action, "POST", "return form_check(this);")
                        'create the instance
                        oFrmInstance = ccXform.moPageXML.CreateElement("PaymentDetails")
                        ccXform.Instance.AppendChild(oFrmInstance)
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("accountID"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("accountComments"))
                        ' create the UI
                        oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "creditCard", "creditCard", "Pay On Account - Enter Your Details")
                        ccXform.addInput(oFrmGroup, "PaymentDetails/accountID", False, "Account ID", "textbox required")
                        ccXform.addNote("PaymentDetails/accountID", noteTypes.Hint, "If you do not have an Account, please call for assistance.")
                        ccXform.addTextArea(oFrmGroup, "PaymentDetails/accountComments", False, "Comments:", "", 6, 30)
                        ccXform.addSubmit(oFrmGroup, formname, "Submit", "placeOrder")
                    End If

                    'validate the Xform if it has been submitted.

                    If ccXform.getSubmitted = "placeOrder" Then
                        ccXform.updateInstanceFromRequest()
                        ccXform.validate()
                        If mcAccountXForm = "" Then
                            If ccXform.Instance.SelectSingleNode("PaymentDetails/accountID").InnerText = "" Then
                                ccXform.addNote("PaymentDetails/accountID", noteTypes.Alert, "You must enter an Account ID")
                                ccXform.valid = False
                            End If
                        End If
                    End If

                    ccXform.addValues()

                    If ccXform.valid = True Then

                        bEncrypt = False

                        ' Temporarily add the payment details to the cart so we can email them and show them
                        Dim oPayElmt As XmlElement
                        oPayElmt = moPageXml.CreateElement("PaymentDetails")
                        oPayElmt.InnerXml = ccXform.Instance.SelectSingleNode("PaymentDetails").InnerXml
                        For Each oElmt In ccXform.Instance.SelectNodes("PaymentDetails/*")
                            cPaymentDetails = cPaymentDetails & oElmt.Name & ": " & oElmt.InnerText
                        Next

                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today _
                            & " " & TimeOfDay & ": changed to: (Order Placed)" & vbLf _
                            & vbLf & cPaymentDetails
                        Next
                        modbHelper.updateDataset(oDs, "Order")

                        savedPaymentId = savePayment(myWeb.mnUserId, "Pay On Account", mnCartId, "Pay on Account", oPayElmt, Now, False, 0) '0 amount paid as yet
                    Else
                        ccXform.valid = False
                    End If

                    payOnAccount = ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payOnAccount", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payByCash(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payByCash")
                Dim sSql As String
                Dim ccXform As xForm = New xForm
                Dim sProcessInfo As String = ""
                Dim bCv2 As Boolean = False
                Dim bEncrypt As Boolean = False

                Dim formname As String = "PayForm"
                Dim action As String = sSubmitPath
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement

                Dim cPaymentDetails As String = ""

                Dim mcAccountXForm As String = ""

                'Get the payment options into a hashtable
                Dim oAccountCfg As XmlNode
                Dim oDs As DataSet
                Dim oRow As DataRow
                Dim cProviderName As String = "payByCash"

                Dim cProcessInfo As String = "payByCash"
                Try
                    'Get the payment options into a hashtable
                    oAccountCfg = moPaymentCfg.SelectSingleNode("provider[@name='PayByCash']")
                    If oAccountCfg Is Nothing Then
                        Err.Raise(1003, "payByCash", "The Pay By Cash provider section is yet to be added to the Protean.Config")
                    End If
                    If Not oAccountCfg.SelectSingleNode("AccountXform/@value") Is Nothing Then
                        mcAccountXForm = oAccountCfg.SelectSingleNode("AccountXform/@value").InnerText()
                    End If

                    'Reference together the root Xml from objects
                    ccXform.moPageXML = Me.moPageXml

                    If mcAccountXForm <> "" Then
                        If Not ccXform.load(mcAccountXForm) Then
                            ccXform.NewFrm(formname)
                            oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "notes", , "Missing File: " & mcAccountXForm)
                        Else
                            'add missing submission or submit buttons
                            If ccXform.moXformElmt.SelectSingleNode("model/instance/submission") Is Nothing Then
                                ccXform.submission(formname, action, "POST", "return form_check(this);")
                            End If
                            If ccXform.moXformElmt.SelectSingleNode("descendant-or-self::submit") Is Nothing Then
                                ccXform.addSubmit(ccXform.moXformElmt, formname, "Place Order", "placeOrder")
                            End If
                        End If
                    Else
                        'First Define the xform
                        ccXform.NewFrm(formname)
                        ccXform.submission(formname, action, "POST", "")
                        'ccXform.submission(formname, action, "POST", "return form_check(this);")
                        'create the instance
                        oFrmInstance = ccXform.moPageXML.CreateElement("BankDetails")
                        ccXform.Instance.AppendChild(oFrmInstance)
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("OrderRef"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("BankName"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("AcctNumber"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("SortCode"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("PaymentComments"))

                        ' create the UI
                        oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "BankDetails", "BankDetails", "Pay By Cash or Bank Transfer")
                        ccXform.addInput(oFrmGroup, "BankDetails/OrderRef", False, "Order Ref", "readonly")
                        ccXform.addInput(oFrmGroup, "BankDetails/BankName", False, "Bank Name", "readonly")
                        ccXform.addInput(oFrmGroup, "BankDetails/AcctNumber", False, "Account Number", "readonly")
                        ccXform.addInput(oFrmGroup, "BankDetails/SortCode", False, "Sort Code", "readonly")
                        ccXform.addTextArea(oFrmGroup, "BankDetails/PaymentComments", False, "Comments", "", 6, 30)
                        ccXform.addSubmit(oFrmGroup, formname, "Confirm Order", "placeOrder")

                    End If
                    'add values to Xform
                    ccXform.Instance.SelectSingleNode("BankDetails/OrderRef").InnerText = mcOrderRef
                    ccXform.Instance.SelectSingleNode("BankDetails/BankName").InnerText = oAccountCfg.SelectSingleNode("BankName/@value").InnerText
                    ccXform.Instance.SelectSingleNode("BankDetails/AcctNumber").InnerText = oAccountCfg.SelectSingleNode("AcctNumber/@value").InnerText
                    ccXform.Instance.SelectSingleNode("BankDetails/SortCode").InnerText = oAccountCfg.SelectSingleNode("SortCode/@value").InnerText

                    'validate the Xform if it has been submitted.

                    If ccXform.getSubmitted = "placeOrder" Then
                        ccXform.updateInstanceFromRequest()
                        ccXform.validate()
                    End If

                    ccXform.addValues()

                    If ccXform.valid = True Then

                        bEncrypt = False

                        savedPaymentId = savePayment(myWeb.mnUserId, cProviderName, mnCartId, oAccountCfg.SelectSingleNode("AcctNumber/@value").InnerText, ccXform.Instance.FirstChild, Now(), False, 0) '0 amount paid as yet

                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today _
                            & " " & TimeOfDay & ": changed to: (Order Placed)" & vbLf _
                            & vbLf & cPaymentDetails
                        Next
                        modbHelper.updateDataset(oDs, "Order")
                        mnProcessIdOnComplete = cartProcess.AwaitingPayment

                    Else
                        ccXform.valid = False
                    End If

                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payByCash", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function


            Public Overridable Function saveOrder(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "SaveOrder")
                Dim sSql As String
                Dim ccXform As Protean.Cms.xForm = New xForm(myWeb)
                Dim sProcessInfo As String = ""
                Dim bCv2 As Boolean = False
                Dim bEncrypt As Boolean = False

                Dim formname As String = "PayForm"
                Dim action As String = sSubmitPath
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement

                Dim cPaymentDetails As String = ""
                Dim oElmt As XmlElement

                Dim mcAccountXForm As String = ""

                'Get the payment options into a hashtable
                Dim oAccountCfg As XmlNode
                Dim oDs As DataSet
                Dim oRow As DataRow

                Dim cProcessInfo As String = "SaveOrder"
                Try
                    'Get the payment options into a hashtable
                    oAccountCfg = moPaymentCfg.SelectSingleNode("provider[@name='Save Order' or @name='SaveOrder']")
                    If oAccountCfg Is Nothing Then
                        Err.Raise(1003, "saveOrder", "The Save Order provider section is yet to be added to the Protean.Config")
                    End If
                    If Not oAccountCfg.SelectSingleNode("AccountXform/@value") Is Nothing Then
                        mcAccountXForm = oAccountCfg.SelectSingleNode("AccountXform/@value").InnerText()
                    End If

                    'Reference together the root Xml from objects
                    ccXform.moPageXML = Me.moPageXml

                    If mcAccountXForm <> "" Then
                        If Not ccXform.load(mcAccountXForm) Then
                            ccXform.NewFrm(formname)
                            oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "notes", , "Missing File: " & mcAccountXForm)
                        Else
                            'add missing submission or submit buttons
                            If ccXform.moXformElmt.SelectSingleNode("model/instance/submission") Is Nothing Then
                                ccXform.submission(formname, action, "POST", "return form_check(this);")
                            End If
                            If ccXform.moXformElmt.SelectSingleNode("descendant-or-self::submit") Is Nothing Then
                                ccXform.addSubmit(ccXform.moXformElmt, formname, "Place Order", "placeOrder")
                            End If
                        End If
                    Else
                        'First Define the xform
                        ccXform.NewFrm(formname)
                        ccXform.submission(formname, action, "POST", "")
                        'ccXform.submission(formname, action, "POST", "return form_check(this);")
                        'create the instance
                        oFrmInstance = ccXform.moPageXML.CreateElement("PaymentDetails")
                        ccXform.Instance.AppendChild(oFrmInstance)
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("accountID"))
                        ccXform.Instance.FirstChild.AppendChild(ccXform.moPageXML.CreateElement("accountComments"))
                        ' create the UI
                        oFrmGroup = ccXform.addGroup(ccXform.moXformElmt, "creditCard", "creditCard", "Pay On Account - Enter Your Details")
                        ccXform.addInput(oFrmGroup, "PaymentDetails/accountID", False, "Account ID", "textbox required")
                        ccXform.addNote("PaymentDetails/accountID", noteTypes.Hint, "If you do not have an Account, please call for assistance.")
                        ccXform.addTextArea(oFrmGroup, "PaymentDetails/accountComments", False, "Comments:", "", 6, 30)
                        ccXform.addSubmit(oFrmGroup, formname, "Submit", "placeOrder")
                    End If

                    'validate the Xform if it has been submitted.

                    If ccXform.getSubmitted = "Submit" Then
                        ccXform.updateInstanceFromRequest()
                        ccXform.validate()
                        If mcAccountXForm = "" Then
                            If ccXform.Instance.SelectSingleNode("PaymentDetails/accountID").InnerText = "" Then
                                ccXform.addNote("PaymentDetails/accountID", noteTypes.Alert, "You must enter an Account ID")
                                ccXform.valid = False
                            End If
                        End If
                    End If

                    ccXform.addValues()

                    If ccXform.valid = True Then

                        bEncrypt = False

                        ' Temporarily add the payment details to the cart so we can email them and show them
                        Dim oPayElmt As XmlElement
                        oPayElmt = moPageXml.CreateElement("PaymentDetails")
                        oPayElmt.InnerXml = ccXform.Instance.SelectSingleNode("PaymentDetails").InnerXml
                        For Each oElmt In ccXform.Instance.SelectNodes("PaymentDetails/*")
                            cPaymentDetails = cPaymentDetails & oElmt.Name & ": " & oElmt.InnerText
                        Next

                        'Update Seller Notes:
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today _
                            & " " & TimeOfDay & ": changed to: (Order Saved)" & vbLf _
                            & vbLf & cPaymentDetails
                            oRow("nCartStatus") = cartProcess.AwaitingPayment
                        Next
                        modbHelper.updateDataset(oDs, "Order")
                        ' savedPaymentId = savePayment(myWeb.mnUserId, "Pay On Account", mnCartId, "Pay on Account", oPayElmt, Now, False, 0) '0 amount paid as yet
                    Else
                        ccXform.valid = False
                    End If

                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payOnAccount", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function payPayPalExpress(ByRef oOrderElmt As XmlElement, ByVal sSubmitPath As String, Optional ByVal sProfile As String = "") As xForm
                PerfMon.Log("PaymentProviders", "payPayPalExpress")
                Dim sSql As String

                Dim ppXform As xForm = New xForm

                Dim Xform3dSec As xForm = Nothing

                Dim bIsValid As Boolean
                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""
                Dim cResponse As String = ""

                Dim oDictOpt As Hashtable = New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3DSecure As Boolean = False
                Dim b3DAuthorised As Boolean = False
                Dim sRedirectURL As String = ""
                Dim sPaymentRef As String = ""

                Dim cProcessInfo As String = "payPayPalExpress"

                'Get the payment options into a hashtable
                Dim oSecpayCfg As XmlNode
                Dim bSavePayment As Boolean = False
                Dim bAllowSavePayment As Boolean = False
                Dim oItemElmt As XmlElement
                Dim oOptElmt As XmlElement
                Dim host As String = "www.paypal.com"

                Try



                    System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12

                    If sProfile <> "" Then
                        oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='PayPalExpress' and @profile='" & sProfile & "']")
                    Else
                        oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='PayPalExpress']")
                    End If

                    ' Get the payment options
                    'oSecpayCfg = moPaymentCfg.SelectSingleNode("provider[@name='SecPay']")
                    oDictOpt = xmlTools.xmlToHashTable(oSecpayCfg, "value")

                    Select Case oDictOpt("opperationMode")
                        Case "true"
                            nTransactionMode = TransactionMode.Test
                        Case "false"
                            nTransactionMode = TransactionMode.Fail
                        Case "live"
                            nTransactionMode = TransactionMode.Live
                    End Select

                    ' override the currency
                    If oDictOpt.ContainsKey("currency") Then
                        If oDictOpt("currency") <> "" Then
                            mcCurrency = oDictOpt("currency")
                        End If
                    End If

                    'Dim ppRequest As New Protean.PayPalAPI.GetExpressCheckoutDetailsRequestType()
                    'ppRequest.Version = "63.0"

                    Dim ppProfile As New PayPalAPI.CustomSecurityHeaderType
                    ppProfile.Credentials = New PayPalAPI.UserIdPasswordType
                    ppProfile.Credentials.Username = CStr(oDictOpt("accountId"))
                    ppProfile.Credentials.Password = CStr(oDictOpt("accountPassword"))
                    ppProfile.Credentials.Signature = CStr(oDictOpt("accountSignature"))

                    Dim ppProfile2 As New PayPalAPI.CustomSecurityHeaderType
                    ppProfile2.Credentials = New PayPalAPI.UserIdPasswordType
                    ppProfile2.Credentials.Username = CStr(oDictOpt("accountId"))
                    ppProfile2.Credentials.Password = CStr(oDictOpt("accountPassword"))
                    ppProfile2.Credentials.Signature = CStr(oDictOpt("accountSignature"))

                    Dim endpointAddress As String = "https://api-aa-3t.paypal.com/2.0/"
                    If nTransactionMode = TransactionMode.Test Then
                        endpointAddress = "https://api-aa-3t.sandbox.paypal.com/2.0/"
                        host = "www.sandbox.paypal.com"
                    End If
                    Dim ppEndpointAddress As New System.ServiceModel.EndpointAddress(endpointAddress)

                    Dim ppBinding As New System.ServiceModel.BasicHttpBinding(System.ServiceModel.BasicHttpSecurityMode.Transport)
                    ppBinding.MaxBufferSize = 65536
                    ppBinding.CloseTimeout = New System.TimeSpan(0, 2, 0)
                    ppBinding.OpenTimeout = New System.TimeSpan(0, 2, 0)
                    ppBinding.ReceiveTimeout = New System.TimeSpan(0, 10, 0)
                    ppBinding.SendTimeout = New System.TimeSpan(0, 2, 0)
                    ppBinding.AllowCookies = False
                    ppBinding.BypassProxyOnLocal = False
                    ppBinding.HostNameComparisonMode = ServiceModel.HostNameComparisonMode.StrongWildcard
                    ppBinding.MaxBufferSize = 65536
                    ppBinding.MaxBufferPoolSize = 524288
                    ppBinding.MaxReceivedMessageSize = 65536
                    ppBinding.MessageEncoding = ServiceModel.WSMessageEncoding.Text
                    ppBinding.TextEncoding = System.Text.Encoding.UTF8
                    ppBinding.TransferMode = ServiceModel.TransferMode.Buffered
                    ppBinding.UseDefaultWebProxy = True

                    ppBinding.ReaderQuotas.MaxDepth = 32
                    ppBinding.ReaderQuotas.MaxStringContentLength = 8192
                    ppBinding.ReaderQuotas.MaxArrayLength = 16384
                    ppBinding.ReaderQuotas.MaxBytesPerRead = 4096
                    ppBinding.ReaderQuotas.MaxNameTableCharCount = 65536

                    Dim ppIface As New PayPalAPI.PayPalAPIAAInterfaceClient(ppBinding, ppEndpointAddress)

                    'Load the Xform

                    Select Case myWeb.moRequest("ppCmd")
                        Case "callback", "return"

                            'Case for Successful payment return
                            Dim oGetExpChk As Protean.PayPalAPI.GetExpressCheckoutDetailsRequestType = New Protean.PayPalAPI.GetExpressCheckoutDetailsRequestType()
                            oGetExpChk.Token = myWeb.moRequest("token")
                            oGetExpChk.Version = "63.0"

                            Dim oGetExpChkReq As New Protean.PayPalAPI.GetExpressCheckoutDetailsReq()
                            oGetExpChkReq.GetExpressCheckoutDetailsRequest = oGetExpChk

                            'Get the Transaction Details back
                            Dim oExpChkResponse As Protean.PayPalAPI.GetExpressCheckoutDetailsResponseType = New Protean.PayPalAPI.GetExpressCheckoutDetailsResponseType
                            oExpChkResponse = ppIface.GetExpressCheckoutDetails(ppProfile, oGetExpChkReq)

                            'Confirm the Sale
                            Dim oDoExpChkReqType As Protean.PayPalAPI.DoExpressCheckoutPaymentRequestType = New Protean.PayPalAPI.DoExpressCheckoutPaymentRequestType
                            oDoExpChkReqType.Version = "63.0"

                            Dim oDoExpChkReq As Protean.PayPalAPI.DoExpressCheckoutPaymentReq = New Protean.PayPalAPI.DoExpressCheckoutPaymentReq
                            oDoExpChkReq.DoExpressCheckoutPaymentRequest = oDoExpChkReqType

                            Dim oDoExpChkDetails As Protean.PayPalAPI.DoExpressCheckoutPaymentRequestDetailsType = New Protean.PayPalAPI.DoExpressCheckoutPaymentRequestDetailsType
                            oDoExpChkReqType.DoExpressCheckoutPaymentRequestDetails = oDoExpChkDetails
                            oDoExpChkDetails.Token = myWeb.moRequest("token")

                            oDoExpChkDetails.PayerID = oExpChkResponse.GetExpressCheckoutDetailsResponseDetails.PayerInfo.PayerID
                            oDoExpChkDetails.PaymentAction = getPPPaymentActionFromCode(oDictOpt("PaymentAction"))
                            oDoExpChkDetails.PaymentDetails = oExpChkResponse.GetExpressCheckoutDetailsResponseDetails.PaymentDetails

                            Dim oDoExpChkResponse As Protean.PayPalAPI.DoExpressCheckoutPaymentResponseType = New Protean.PayPalAPI.DoExpressCheckoutPaymentResponseType

                            'TS added following up on this http://stackoverflow.com/questions/15817839/you-do-not-have-permissions-to-make-this-api-call-using-soap-for-dodirectpayment
                            'ppProfile.Credentials.Subject = Replace(oDictOpt("accountId"), "_api1", "@")

                            Try

                                oDoExpChkResponse = ppIface.DoExpressCheckoutPayment(ppProfile2, oDoExpChkReq)

                                Select Case oDoExpChkResponse.Ack
                                    Case Protean.PayPalAPI.AckCodeType.Success
                                        bIsValid = True

                                        err_msg = "Paypal Payment Completed - Ref: " & CStr(mnCartId)
                                        ppXform.moPageXML = moPageXml
                                        ppXform.NewFrm("PayForm")
                                        ppXform.valid = bIsValid

                                        Dim cPaymentRef As String = Convert.ToString(oDoExpChkResponse.DoExpressCheckoutPaymentResponseDetails.PaymentInfo(0).TransactionID) 'PayPal transaction id
                                        Dim cPayerId As String = Convert.ToString(oExpChkResponse.GetExpressCheckoutDetailsResponseDetails.PayerInfo.PayerID) 'PayPal Us

                                        '   Dim cPaymentRef As String = oExpChkResponse.GetExpressCheckoutDetailsResponseDetails.PaymentInfo. 'PayPal User


                                        Dim oInstanceElmt As XmlElement = ppXform.Instance.OwnerDocument.CreateElement("instance")
                                        Dim oPayPalElmt As XmlElement = ppXform.Instance.OwnerDocument.CreateElement("PayPalExpress")
                                        oInstanceElmt.AppendChild(oPayPalElmt)
                                        'Add stuff we want to save here...
                                        oPayPalElmt.SetAttribute("payerId", cPayerId)

                                        ppXform.Instance = oInstanceElmt

                                        'update delivery address

                                        'update notes ??
                                        err_msg = "Notes:" & oExpChkResponse.GetExpressCheckoutDetailsResponseDetails.Note


                                        savedPaymentId = savePayment(myWeb.mnUserId, "PayPalExpress", cPaymentRef, CStr(oDictOpt("accountId")), ppXform.Instance.FirstChild, Now, False, mnPaymentAmount)
                                    Case Else
                                        Dim ppError As Protean.PayPalAPI.ErrorType
                                        For Each ppError In oDoExpChkResponse.Errors
                                            err_msg = err_msg & " Error:" & ppError.ErrorCode
                                            err_msg = err_msg & " Msg:" & ppError.LongMessage
                                        Next
                                        ppXform.moPageXML = moPageXml
                                        ppXform.NewFrm("PayForm")
                                        ppXform.valid = False
                                        ppXform.addNote(ppXform.moXformElmt, xForm.noteTypes.Alert, err_msg)

                                End Select

                            Catch ex As Exception
                                err_msg = err_msg & "Could not Connect to PayPal at this time please use an alternative payment method."
                                err_msg = err_msg & " Error:" & ex.Message

                                ppXform.moPageXML = moPageXml
                                ppXform.NewFrm("PayForm")
                                ppXform.valid = False
                                ppXform.addNote(ppXform.moXformElmt, xForm.noteTypes.Alert, "Could not Connect to PayPal at this time please use an alternative payment method.")

                            End Try

                        Case Else

                            Dim oSetExpChk As Protean.PayPalAPI.SetExpressCheckoutRequestType = New Protean.PayPalAPI.SetExpressCheckoutRequestType()
                            oSetExpChk.Version = "63.0"

                            Dim oSetExpChkDetails As Protean.PayPalAPI.SetExpressCheckoutRequestDetailsType = New Protean.PayPalAPI.SetExpressCheckoutRequestDetailsType()
                            oSetExpChk.SetExpressCheckoutRequestDetails = oSetExpChkDetails

                            Dim cCurrentURL As String = sSubmitPath
                            oSetExpChkDetails.ReturnURL = cCurrentURL & "&ppCmd=return" 'Return to pay selector page 
                            oSetExpChkDetails.CancelURL = cCurrentURL & "&ppCmd=cancel" 'Return to pay selector 
                            ' oSetExpChkDetails.CallbackURL = cCurrentURL & "&ppCmd=callback" 'Return to pay selector 

                            oSetExpChkDetails.ReqConfirmShipping = IIf(CInt(oDictOpt("ReqConfirmShipping")) = 0, "0", "1")
                            oSetExpChkDetails.NoShipping = IIf(CInt(oDictOpt("NoShipping")) = 0, "0", "1")
                            If LCase(moCartConfig("NoDeliveryAddress")) = "on" Then
                                oSetExpChkDetails.NoShipping = "1"
                            End If
                            oSetExpChkDetails.AllowNote = IIf(CInt(oDictOpt("AllowNote")) = 0, "0", "1")
                            oSetExpChkDetails.AddressOverride = IIf(CInt(oDictOpt("AddressOverride")) = 0, "0", "1")
                            oSetExpChkDetails.LocaleCode = oDictOpt("LocaleCode")
                            If oDictOpt("PageStyle") <> "" Then
                                oSetExpChkDetails.PageStyle = oDictOpt("PageStyle")
                            End If
                            If oDictOpt("cpp-header-image") <> "" Then
                                oSetExpChkDetails.cppheaderimage = oDictOpt("cpp-header-image")
                            End If
                            'deprecated TMS 05/09/18
                            'oSetExpChkDetails.cppheaderbordercolor = Replace(oDictOpt("cpp-header-border-color"), "#", "")
                            'oSetExpChkDetails.cppheaderbackcolor = Replace(oDictOpt("cpp-header-back-color"), "#", "")
                            'oSetExpChkDetails.cpppayflowcolor = Replace(oDictOpt("cpp-payflow-color"), "#", "")
                            oSetExpChkDetails.PaymentAction = getPPPaymentActionFromCode(oDictOpt("PaymentAction"))
                            Dim sType As String = "Billing Address"
                            Dim oCartAdd As XmlElement = oOrderElmt.SelectSingleNode("Contact[@type='" & sType & "']")
                            oSetExpChkDetails.BuyerEmail = oCartAdd.SelectSingleNode("Email").InnerText
                            oSetExpChkDetails.SolutionType = Protean.PayPalAPI.SolutionTypeType.Mark
                            oSetExpChkDetails.LandingPage = Protean.PayPalAPI.LandingPageType.Login
                            oSetExpChkDetails.ChannelType = Protean.PayPalAPI.ChannelType.Merchant

                            If moCartConfig("MerchantName") <> "" Then
                                oSetExpChkDetails.BrandName = Left(moCartConfig("MerchantName"), 127)
                            End If

                            oSetExpChkDetails.CallbackTimeout = 3

                            Dim ppPaymentDetails(1) As Protean.PayPalAPI.PaymentDetailsType
                            oSetExpChkDetails.PaymentDetails = ppPaymentDetails
                            oSetExpChkDetails.PaymentDetails(0) = New Protean.PayPalAPI.PaymentDetailsType

                            'OrderTotal
                            Dim oTotalAmount As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                            oTotalAmount.currencyID = getPPCurencyFromCode(mcCurrency)
                            oTotalAmount.Value = mnPaymentAmount
                            oSetExpChkDetails.PaymentDetails(0).OrderTotal = oTotalAmount

                            Dim oMaxAmount As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                            oMaxAmount.currencyID = getPPCurencyFromCode(mcCurrency)
                            oMaxAmount.Value = mnPaymentAmount * 2
                            oSetExpChkDetails.MaxAmount = oMaxAmount

                            Dim nShippingCost As Decimal = oOrderElmt.GetAttribute("shippingCost")
                            Dim nVatCost As Decimal = Round(oOrderElmt.GetAttribute("vatAmt"), , , True)

                            If oOrderElmt.GetAttribute("vatRate") > 0 And LCase(oDictOpt("VATonShipping")) = "on" Then
                                Dim nShippingVat As Decimal = Round(nShippingCost * (oOrderElmt.GetAttribute("vatRate") / 100), , , True)
                                nVatCost = nVatCost - nShippingVat
                                nShippingCost = nShippingCost + nShippingVat
                            End If

                            'Item Total
                            Dim oItemTotal As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                            oItemTotal.currencyID = getPPCurencyFromCode(mcCurrency)
                            oItemTotal.Value = FormatNumber(mnPaymentAmount - nVatCost - nShippingCost, 2)
                            oSetExpChkDetails.PaymentDetails(0).ItemTotal = oItemTotal
                            'Tax Total
                            Dim oTaxTotal As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                            oTaxTotal.currencyID = getPPCurencyFromCode(mcCurrency)
                            oTaxTotal.Value = nVatCost
                            oSetExpChkDetails.PaymentDetails(0).TaxTotal = oTaxTotal
                            'Shipping Total
                            Dim oShippingTotal As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                            oShippingTotal.currencyID = getPPCurencyFromCode(mcCurrency)
                            oShippingTotal.Value = nShippingCost
                            oSetExpChkDetails.PaymentDetails(0).ShippingTotal = oShippingTotal

                            Dim oShippingOptions(0) As Protean.PayPalAPI.ShippingOptionType
                            Dim oShippingOption As Protean.PayPalAPI.ShippingOptionType = New Protean.PayPalAPI.ShippingOptionType
                            oShippingOption.ShippingOptionIsDefault = True
                            oShippingOption.ShippingOptionName = IIf(oOrderElmt.GetAttribute("shippingDesc") = "", "Shipping Charge", oOrderElmt.GetAttribute("shippingDesc"))
                            oShippingOption.ShippingOptionAmount = oShippingTotal
                            oShippingOptions(0) = oShippingOption
                            oSetExpChkDetails.FlatRateShippingOptions = oShippingOptions

                            oSetExpChkDetails.PaymentDetails(0).InvoiceID = moCartConfig("OrderNoPrefix") & CStr(mnCartId)

                            Dim oDeliveryAddress As Protean.PayPalAPI.AddressType = New Protean.PayPalAPI.AddressType
                            sType = "Delivery Address"
                            oCartAdd = oOrderElmt.SelectSingleNode("Contact[@type='" & sType & "']")
                            oDeliveryAddress.Street1 = IIf(oCartAdd.SelectSingleNode("Company").InnerText = "", oCartAdd.SelectSingleNode("Street").InnerText, oCartAdd.SelectSingleNode("Company").InnerText)
                            If oCartAdd.SelectSingleNode("Company").InnerText = "" Then
                                oDeliveryAddress.Street2 = oCartAdd.SelectSingleNode("Street").InnerText
                            End If
                            oDeliveryAddress.CityName = oCartAdd.SelectSingleNode("City").InnerText
                            oDeliveryAddress.StateOrProvince = oCartAdd.SelectSingleNode("State").InnerText
                            oDeliveryAddress.PostalCode = oCartAdd.SelectSingleNode("PostalCode").InnerText
                            oDeliveryAddress.Country = getPPCountryFromCode(getCountryISO2Code(oCartAdd.SelectSingleNode("Country").InnerText))
                            oDeliveryAddress.CountryName = oCartAdd.SelectSingleNode("Country").InnerText
                            oDeliveryAddress.CountrySpecified = True

                            oSetExpChkDetails.PaymentDetails(0).ShipToAddress = oDeliveryAddress
                            Dim nItemCount As Integer = oOrderElmt.SelectNodes("descendant-or-self::Item").Count

                            If mcPaymentType = "deposit" Then
                                nItemCount = nItemCount + 1
                            End If

                            Dim oItemGroup(nItemCount - 1) As Protean.PayPalAPI.PaymentDetailsItemType
                            Dim i As Integer = 0

                            For Each oItemElmt In oOrderElmt.SelectNodes("Item")
                                Dim oItem As Protean.PayPalAPI.PaymentDetailsItemType = New Protean.PayPalAPI.PaymentDetailsItemType

                                oItem.Name = oItemElmt.GetAttribute("quantity") & " x " & Left(oItemElmt.SelectSingleNode("Name").InnerText, 120)
                                'oItem.Description = Left(oItemElmt.SelectSingleNode("Body").InnerText, 127)
                                'weight
                                Dim oItemWeight As Protean.PayPalAPI.MeasureType = New Protean.PayPalAPI.MeasureType
                                oItemWeight.unit = "kg"
                                oItemWeight.Value = oItemElmt.GetAttribute("weight")
                                oItem.ItemWeight = oItemWeight
                                oItem.Quantity = 1 'oItemElmt.GetAttribute("quantity")
                                'itemtax
                                Dim oItemTax As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                                oItemTax.currencyID = getPPCurencyFromCode(mcCurrency)
                                'oItemTax.Value = FormatNumber(CDbl("0" & oItemElmt.GetAttribute("itemTax")) / oItemElmt.GetAttribute("quantity"), 2)
                                oItemTax.Value = 0 'FormatNumber(CDbl("0" & oItemElmt.GetAttribute("itemTax")), 2)
                                'oItemTax.Value = FormatNumber(CDbl("0" & oItemElmt.GetAttribute("itemTax")), 2) / oItemElmt.GetAttribute("quantity")
                                oItem.Tax = oItemTax
                                'itemAmount
                                'Dim nItemPlusTax As Double = FormatNumber(oItemElmt.GetAttribute("price"), 2) + (CDbl("0" & oItemElmt.GetAttribute("itemTax")) / oItemElmt.GetAttribute("quantity"))
                                Dim oItemAmount As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                                oItemAmount.currencyID = getPPCurencyFromCode(mcCurrency)
                                Dim linetotal As Double = oItemElmt.GetAttribute("itemTotal")
                                ' If oItemTax.Value > 0 Then
                                ' linetotal = linetotal - oItemTax.Value
                                '  End If
                                oItemAmount.Value = FormatNumber(linetotal, 2)
                                oItem.Amount = oItemAmount
                                oItemGroup(i) = oItem
                                i = i + 1
                                'loop through and add any options
                                For Each oOptElmt In oItemElmt.SelectNodes("Item")
                                    Dim oOptItem As Protean.PayPalAPI.PaymentDetailsItemType = New Protean.PayPalAPI.PaymentDetailsItemType
                                    oOptItem.Quantity = oItemElmt.GetAttribute("quantity")
                                    Dim oOptItemAmount As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                                    oOptItemAmount.currencyID = getPPCurencyFromCode(mcCurrency)
                                    oOptItemAmount.Value = FormatNumber(oOptElmt.GetAttribute("price"), 2)
                                    oOptItem.Amount = oOptItemAmount
                                    oItemGroup(i) = oOptItem
                                    i = i + 1
                                Next

                            Next

                            If mcPaymentType = "deposit" Then

                                Dim oDiscountItem As Protean.PayPalAPI.PaymentDetailsItemType = New Protean.PayPalAPI.PaymentDetailsItemType
                                oDiscountItem.Name = "Final payment to be made later"
                                oDiscountItem.Quantity = "1"
                                'itemtax
                                Dim oItemTax As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                                oItemTax.currencyID = getPPCurencyFromCode(mcCurrency)
                                oItemTax.Value = "0"
                                oDiscountItem.Tax = oItemTax
                                'itemAmount
                                'Dim nItemPlusTax As Double = FormatNumber(oItemElmt.GetAttribute("price"), 2) + (CDbl("0" & oItemElmt.GetAttribute("itemTax")) / oItemElmt.GetAttribute("quantity"))
                                Dim oItemAmount As Protean.PayPalAPI.BasicAmountType = New Protean.PayPalAPI.BasicAmountType
                                oItemAmount.currencyID = getPPCurencyFromCode(mcCurrency)
                                oItemAmount.Value = FormatNumber(mnPaymentMaxAmount - mnPaymentAmount, 2) * -1
                                oDiscountItem.Amount = oItemAmount
                                oItemGroup(i) = oDiscountItem

                            End If

                            oSetExpChkDetails.PaymentDetails(0).PaymentDetailsItem = oItemGroup
                            Dim oSetExpChkReq As Protean.PayPalAPI.SetExpressCheckoutReq = New Protean.PayPalAPI.SetExpressCheckoutReq
                            oSetExpChkReq.SetExpressCheckoutRequest = oSetExpChk

                            Dim oExpChkResponse As Protean.PayPalAPI.SetExpressCheckoutResponseType
                            oExpChkResponse = ppIface.SetExpressCheckout(ppProfile, oSetExpChkReq)

                            Dim redirectUrl As String
                            redirectUrl = ("https://" & host & "/cgi-bin/webscr?cmd=_express-checkout" & "&token=") + oExpChkResponse.Token

                            ppXform.moPageXML = moPageXml
                            ppXform.NewFrm("PayForm")
                            ppXform.valid = False

                            Select Case oExpChkResponse.Ack
                                Case Protean.PayPalAPI.AckCodeType.Success, Protean.PayPalAPI.AckCodeType.SuccessWithWarning
                                    myWeb.msRedirectOnEnd = redirectUrl
                                    err_msg = "Redirect to - " & redirectUrl
                                Case Else
                                    Dim ppError As Protean.PayPalAPI.ErrorType
                                    For Each ppError In oExpChkResponse.Errors
                                        err_msg = err_msg & " Error:" & ppError.ErrorCode
                                        err_msg = err_msg & " Msg:" & ppError.LongMessage
                                    Next
                                    ppXform.addNote(ppXform.moXformElmt, xForm.noteTypes.Alert, err_msg)
                            End Select

                    End Select


                    'Update Seller Notes:

                    sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                    Dim oDs As DataSet
                    Dim oRow As DataRow
                    oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                    For Each oRow In oDs.Tables("Order").Rows
                        If bIsValid Then
                            oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "comment: " & err_msg
                        Else
                            If err_msg.StartsWith("Redirect") Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (User Redirected)" & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: " & err_msg
                            End If
                        End If
                    Next
                    modbHelper.updateDataset(oDs, "Order")

                    Return ppXform

                Catch ex As Exception
                    returnException(mcModuleName, "payPayPalExpress", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Public Function getPPCountryFromCode(ByVal CountryCode As String) As Protean.PayPalAPI.CountryCodeType

                Dim MyEnumVal As Protean.PayPalAPI.CountryCodeType

                MyEnumVal = CType(System.ComponentModel.TypeDescriptor.GetConverter(MyEnumVal).ConvertFrom(CountryCode), Protean.PayPalAPI.CountryCodeType)

                Return MyEnumVal

            End Function

            Public Function getPPCurencyFromCode(ByVal CurrencyCode As String) As Protean.PayPalAPI.CurrencyCodeType

                Dim MyEnumVal As Protean.PayPalAPI.CurrencyCodeType

                MyEnumVal = CType(System.ComponentModel.TypeDescriptor.GetConverter(MyEnumVal).ConvertFrom(CurrencyCode), Protean.PayPalAPI.CurrencyCodeType)

                Return MyEnumVal

            End Function

            Private Function getPPPaymentActionFromCode(ByVal PaymentActionCode As String) As Protean.PayPalAPI.PaymentActionCodeType

                Dim MyEnumVal As Protean.PayPalAPI.PaymentActionCodeType

                MyEnumVal = CType(System.ComponentModel.TypeDescriptor.GetConverter(MyEnumVal).ConvertFrom(PaymentActionCode), Protean.PayPalAPI.PaymentActionCodeType)

                Return MyEnumVal

            End Function

            Private Function fmtSecPayDate(ByVal sdate As String) As String
                PerfMon.Log("PaymentProviders", "fmtSecPayDate")
                Dim cProcessInfo As String = "fmtSecPayDate"
                Dim strReturn As String = ""
                Try
                    ' The dates are formatted "mm yyyy" - convert them to "mmyy"
                    If sdate <> "" Then strReturn = Left(sdate, 2) & Right(sdate, 2)
                    Return strReturn
                Catch ex As Exception
                    returnException(mcModuleName, "fmtSecPayDate", ex, "", cProcessInfo, gbDebug)
                    Return ""

                End Try
            End Function

            Private Function fmtSecureTradingDate(ByVal sdate As String) As String
                PerfMon.Log("PaymentProviders", "fmtSecureTradingDate")
                Dim cProcessInfo As String = "fmtSecureTradingDate"
                Dim strReturn As String = ""
                Try
                    ' The dates are formatted "mm yyyy" - convert them to "mm/yy"
                    If sdate <> "" Then Return (Left(sdate, 2) & "/" & Right(sdate, 2)) Else Return Nothing


                Catch ex As Exception
                    returnException(mcModuleName, "fmtSecPayDate", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Private Function getSecPayOrder(ByRef oRoot As XmlElement) As String

                PerfMon.Log("PaymentProviders", "getSecPayOrder")
                Dim sOrder As String
                Dim cProcessInfo As String = "getSecPayOrder"
                Dim oItem As XmlElement
                Try
                    sOrder = ""
                    For Each oItem In oRoot.SelectNodes("Item")
                        sOrder = sOrder & "prod=" & Replace(oItem.SelectSingleNode("Name").InnerText, " ", "_")
                        sOrder = sOrder & ", item_amount=" & oItem.SelectSingleNode("@price").InnerText & "x" & oItem.SelectSingleNode("@quantity").InnerText & ";"
                    Next
                    'add the shipping
                    If CInt("0" & oRoot.SelectSingleNode("@shippingCost").InnerText) > 0 Then
                        sOrder = sOrder & "prod=SHIPPING,item_amount=" & oRoot.SelectSingleNode("@shippingCost").InnerText & "x1;"
                    End If
                    'add the tax
                    If CInt("0" & oRoot.SelectSingleNode("@vatAmt").InnerText) > 0 Then
                        sOrder = sOrder & "prod=TAX,item_amount=" & oRoot.SelectSingleNode("@vatAmt").InnerText & "x1;"
                    End If

                    'strip the trailing semiColon
                    sOrder = Left(sOrder, Len(sOrder) - 1)
                    Return sOrder

                Catch ex As Exception
                    returnException(mcModuleName, "getSecPayOrder", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Private Function getWorldPayOrder(ByRef oRoot As XmlElement) As String
                PerfMon.Log("PaymentProviders", "getWorldPayOrder")
                Dim sOrder As String = ""
                Dim oNodeList As XmlNodeList
                Dim oNode As XmlElement

                oNodeList = oRoot.SelectNodes("Item")

                For Each oNode In oNodeList
                    sOrder = sOrder & oNode.SelectSingleNode("Name").InnerText & " x " & oNode.Attributes("quantity").InnerText & ","
                Next oNode

                Return Left(sOrder, Len(sOrder) - 1)

            End Function

            Private Function getSecPayAddress(ByRef oRoot As XmlElement, ByRef sType As String) As String
                PerfMon.Log("PaymentProviders", "getSecPayAddress")
                Dim oCartAdd As XmlElement

                Dim sAddress As String
                Dim sPrefix As String
                Dim cProcessInfo As String = "getSecPayAddress"
                Try
                    sAddress = ""

                    oCartAdd = oRoot.SelectSingleNode("Contact[@type='" & sType & "']")

                    If sType = "Delivery" Then sType = "Shipping"

                    If Not oCartAdd Is Nothing Then

                        sPrefix = LCase(Left(sType, 4)) & "_"

                        'given name
                        If Not oCartAdd.SelectSingleNode("GivenName") Is Nothing Then
                            sAddress = sAddress & sPrefix & "name=" & Replace(oCartAdd.SelectSingleNode("GivenName").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("Company") Is Nothing Then
                            sAddress = sAddress & sPrefix & "company=" & Replace(oCartAdd.SelectSingleNode("Company").InnerText, ",", "&comma;") & ","
                        End If

                        Dim cStreet() As String = Split(oCartAdd.SelectSingleNode("Street").InnerText, ",")
                        Select Case UBound(cStreet)
                            Case 0
                                If Not oCartAdd.SelectSingleNode("Street") Is Nothing Then
                                    sAddress = sAddress & sPrefix & "addr_1=" & cStreet(0) & ","
                                End If
                            Case 1
                                If Not oCartAdd.SelectSingleNode("Street") Is Nothing Then
                                    sAddress = sAddress & sPrefix & "addr_1=" & cStreet(0) & ","
                                    sAddress = sAddress & sPrefix & "addr_2=" & cStreet(1) & ","
                                End If
                            Case Else
                                If Not oCartAdd.SelectSingleNode("Street") Is Nothing Then
                                    sAddress = sAddress & sPrefix & "addr_1=" & cStreet(0) & ","
                                    'remove commas AVC doesn't like em.
                                    sAddress = sAddress & sPrefix & "addr_2=" & Replace(Replace(oCartAdd.SelectSingleNode("Street").InnerText, cStreet(0), ""), ",", " ") & ","
                                End If
                        End Select

                        If Not oCartAdd.SelectSingleNode("City") Is Nothing Then
                            sAddress = sAddress & sPrefix & "city=" & Replace(oCartAdd.SelectSingleNode("City").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("State") Is Nothing Then
                            sAddress = sAddress & sPrefix & "state=" & Replace(oCartAdd.SelectSingleNode("State").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("Country") Is Nothing Then
                            sAddress = sAddress & sPrefix & "country=" & Replace(oCartAdd.SelectSingleNode("Country").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("PostalCode") Is Nothing Then
                            sAddress = sAddress & sPrefix & "post_code=" & Replace(oCartAdd.SelectSingleNode("PostalCode").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("Telephone") Is Nothing Then
                            sAddress = sAddress & sPrefix & "tel=" & Replace(oCartAdd.SelectSingleNode("Telephone").InnerText, ",", "&comma;") & ","
                        End If

                        If Not oCartAdd.SelectSingleNode("Email") Is Nothing Then
                            sAddress = sAddress & sPrefix & "email=" & Replace(oCartAdd.SelectSingleNode("Email").InnerText, ",", "&comma;") & ","
                        End If

                        If sAddress <> "" Then sAddress = Left(sAddress, Len(sAddress) - 1)

                    End If

                    getSecPayAddress = sAddress
                Catch ex As Exception
                    returnException(mcModuleName, "getSecPayAddress", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function

            Public Function getCountryISO2Code(ByRef sCountry As String) As String
                PerfMon.Log("PaymentProviders", "getCountryISO2Code")
                Dim oDr As SqlDataReader
                Dim sSql As String
                Dim strReturn As String = ""
                Dim cProcessInfo As String = "getCountryISO2Code"
                Try

                    sSql = "select cLocationISOa2 from tblCartShippingLocations where cLocationNameFull Like '" & sCountry & "' or cLocationNameShort Like '" & sCountry & "'"
                    oDr = modbHelper.getDataReader(sSql)
                    If oDr.HasRows Then
                        While oDr.Read
                            strReturn = oDr("cLocationISOa2")
                        End While
                    Else
                        strReturn = ""
                    End If

                    oDr.Close()
                    oDr = Nothing
                    Return strReturn
                Catch ex As Exception
                    returnException(mcModuleName, "getCountryISO2Code", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Public Function getCountryISO3Code(ByRef sCountry As String) As String
                PerfMon.Log("PaymentProviders", "getCountryISO2Code")
                Dim oDr As SqlDataReader
                Dim sSql As String
                Dim strReturn As String = ""
                Dim cProcessInfo As String = "getCountryISO2Code"
                Try

                    sSql = "select cLocationISOa3 from tblCartShippingLocations where cLocationNameFull Like '" & sCountry & "' or cLocationNameShort Like '" & sCountry & "'"
                    oDr = modbHelper.getDataReader(sSql)
                    If oDr.HasRows Then
                        While oDr.Read
                            strReturn = oDr("cLocationISOa3")
                        End While
                    Else
                        strReturn = ""
                    End If

                    oDr.Close()
                    oDr = Nothing
                    Return strReturn
                Catch ex As Exception
                    returnException(mcModuleName, "getCountryISO3Code", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Public Function FormatCreditCardNumber(ByVal sCCNumber As String) As Long
                PerfMon.Log("PaymentProviders", "FormatCreditCardNumber")
                Dim cResult As String = ""
                Dim oRE As Regex = New Regex("\D")
                cResult = oRE.Replace(sCCNumber, "")
                cResult = Replace(cResult, " ", "") 'also strip out spaces
                If cResult = "" Then cResult = 0
                Return cResult
            End Function

            Function xfrmSecure3D(ByVal acs_url As String, ByVal MD As String, ByVal pa_req As String, ByVal callbackUrl As String) As xForm
                PerfMon.Log("PaymentProviders", "xfrmSecure3D")
                Dim oXform As xForm = New xForm
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement

                Dim cProcessInfo As String = "xfrmSecure3D"
                Try
                    oXform.moPageXML = Me.moPageXml

                    'create the instance
                    oXform.NewFrm("Secure3D")

                    'New addition to fix acs_url being url decoded - 23/06/2014
                    Dim cleanACSURL As String = myWeb.goServer.UrlDecode(acs_url)
                    cleanACSURL = Replace(cleanACSURL, "&amp;", "&")

                    'hack because server 5 is flukey !
                    'acs_url = acs_url.Replace("secure5.arcot", "secure4.arcot")

                    oXform.submission("Secure3D", cleanACSURL, "POST", "return form_check(this);")
                    oFrmInstance = oXform.moPageXML.CreateElement("Secure3D")

                    addNewTextNode("PaReq", oFrmInstance, pa_req)

                    addNewTextNode("TermUrl", oFrmInstance, Replace(callbackUrl, "&amp;", "&"))
                    addNewTextNode("MD", oFrmInstance, MD)
                    oXform.Instance.AppendChild(oFrmInstance)

                    oFrmGroup = oXform.addGroup(oXform.moXformElmt, "creditCard", "creditCard", "Redirect to 3D Secure")

                    'build the form and the binds

                    oXform.addInput(oFrmGroup, "PaReq", True, "", "hidden")
                    oXform.addBind("PaReq", "Secure3D/PaReq")

                    oXform.addInput(oFrmGroup, "TermUrl", True, "", "hidden")
                    oXform.addBind("TermUrl", "Secure3D/TermUrl")
                    oXform.addInput(oFrmGroup, "MD", True, "", "hidden")
                    oXform.addBind("MD", "Secure3D/MD")
                    oXform.addDiv(oFrmGroup, "<SCRIPT LANGUAGE=""Javascript"">function onXformLoad(){document.Secure3D.submit();};appendLoader(onXformLoad);</SCRIPT>")
                    oXform.addSubmit(oFrmGroup, "Secure3D", "Re-direct to 3D Secure", "ewSubmit")
                    oXform.addValues()
                    Return oXform

                Catch ex As Exception
                    returnException(mcModuleName, "xfrmSecure3D", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function

            Function xfrmSecure3Dv2(ByVal acs_url As String, ByVal jwt As String, ByVal SongbirdURL As String, ByVal callbackUrl As String) As xForm
                PerfMon.Log("PaymentProviders", "xfrmSecure3Dv2")
                Dim oXform As xForm = New xForm
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement

                Dim cProcessInfo As String = "xfrmSecure3Dv2"
                Try
                    oXform.moPageXML = Me.moPageXml

                    'create the instance
                    oXform.NewFrm("Secure3Dv2")

                    oXform.submission("Secure3Dv2", "", "POST", "return form_check(this);")
                    oFrmInstance = oXform.moPageXML.CreateElement("Secure3Dv2")

                    addNewTextNode("JWT", oFrmInstance, jwt)
                    addNewTextNode("SongbirdURL", oFrmInstance, SongbirdURL)
                    addNewTextNode("CallbackUrl", oFrmInstance, Replace(callbackUrl, "&amp;", "&"))

                    oXform.Instance.AppendChild(oFrmInstance)

                    oFrmGroup = oXform.addGroup(oXform.moXformElmt, "creditCard", "creditCard", "Redirect to 3D Secure")

                    'build the form and the binds

                    oXform.addInput(oFrmGroup, "JWT", True, "", "hidden")
                    oXform.addBind("JWT", "Secure3Dv2/JWT")

                    oXform.addInput(oFrmGroup, "TermUrl", True, "", "hidden")
                    oXform.addBind("SongbirdURL", "Secure3Dv2/SongbirdURL")
                    oXform.addSubmit(oFrmGroup, "Secure3D", "Re-direct to 3D Secure", "ewSubmit")
                    oXform.addValues()
                    Return oXform

                Catch ex As Exception
                    returnException(mcModuleName, "xfrmSecure3D", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function


            Function GetRedirect3dsForm(ByRef myWeb As Protean.Cms) As xForm
                PerfMon.Log("EPDQ", "xfrmSecure3DReturn")
                Dim oXform As xForm = New Protean.Cms.xForm
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement
                Dim RedirectURL As String

                Dim cProcessInfo As String = "xfrmSecure3D"
                Try
                    oXform.moPageXML = myWeb.moPageXml

                    If moCartConfig("SecureURL").EndsWith("/") Then
                        RedirectURL = moCartConfig("SecureURL") & "?cartCmd=SubmitPaymentDetails&paymentMethod=" & myWeb.moCart.mcPaymentMethod
                    Else
                        RedirectURL = moCartConfig("SecureURL") & "/?cartCmd=SubmitPaymentDetails&paymentMethod=" & myWeb.moCart.mcPaymentMethod
                    End If

                    'create the instance
                    oXform.NewFrm("Secure3DReturn")
                    oXform.submission("Secure3DReturn", goServer.UrlDecode(RedirectURL), "POST", "return form_check(this);")
                    oFrmInstance = oXform.moPageXML.CreateElement("Secure3DReturn")
                    oXform.Instance.AppendChild(oFrmInstance)
                    oFrmGroup = oXform.addGroup(oXform.moXformElmt, "Secure3DReturn1", "Secure3DReturn1", "Redirecting...")
                    Dim item As Object

                    For Each item In myWeb.moRequest.Form
                        Dim newInput As XmlNode = oXform.addInput(oFrmGroup, CStr(item), False, CStr(item), "hidden")
                        oXform.addValue(newInput, myWeb.moRequest.Form(CStr(item)))
                    Next

                    'build the form and the binds
                    'oXform.addDiv(oFrmGroup, "<SCRIPT LANGUAGE=""Javascript"">function onXformLoad(){document.Secure3DReturn.submit();};appendLoader(onXformLoad);</SCRIPT>")
                    oXform.addSubmit(oFrmGroup, "Secure3DReturn", "Continue", "ewSubmit")
                    oXform.addValues()
                    Return oXform

                Catch ex As Exception
                    returnException(mcModuleName, "xfrmSecure3D", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function


            Function creditCardXform(ByRef oRoot As XmlElement, Optional ByVal formName As String = "creditCard", Optional ByVal action As String = "", Optional ByVal cardTypes As String = "MasterCard:Master Card,VISA:Visa,Delta:Delta,Solo:Solo,Switch:Switch", Optional ByVal bCV2 As Boolean = True, Optional ByVal sFormTitle As String = "Your Credit Card Details", Optional ByVal b3dSecure As Boolean = False, Optional ByVal cInstance As String = "", Optional ByVal bOverrideValidity As Boolean = False, Optional ByVal bSavePayment As Boolean = False) As xForm
                PerfMon.Log("PaymentProviders", "creditCardXform")
                Dim oXform As xForm = New xForm
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement
                Dim sSql As String
                Dim odr As SqlDataReader
                Dim bIsValid As Boolean = False
                Dim aCardTypes() As String
                Dim aCardTypes2() As String
                Dim i As Integer
                Dim nPayableAmount As Double
                Dim cUniqueLink As String = ""
                Dim nLinkNumber As Long
                Dim oRandom As Random = New Random

                Dim sProcess As String
                Dim cProcessInfo As String = "creditCardXform"
                Try

                    If (myWeb.mnUserId > 0 And moCartConfig("SavePayments") = "on") Then
                        bSavePayment = True
                    End If

                    'Reference together the root Xml from objects
                    oXform.moPageXML = Me.moPageXml

                    'First Define the xform
                    oXform.NewFrm(formName)
                    oXform.submission(formName, action, "POST", "return form_check(this);")
                    'create the instance

                    If cInstance <> "" Then
                        oXform.Instance.InnerXml = cInstance
                    Else
                        oFrmInstance = oXform.moPageXML.CreateElement("creditCard")
                        oXform.Instance.AppendChild(oFrmInstance)

                        ' If payment type is deposit then the payment amount can be adjusted
                        If mcPaymentType = "deposit" Then
                            oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("amount"))
                            oXform.Instance.FirstChild.LastChild.InnerText = CStr(mnPaymentAmount)
                        End If

                        ' Optionally set cardholder name over billing address
                        If moCartConfig("CardholderName") = "on" Then
                            oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("cardholder"))
                        End If


                        oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("number"))
                        oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("type"))
                        oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("expireDate"))
                        oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("issueNumber"))
                        oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("issueDate"))
                        If bCV2 Then
                            oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("CV2"))
                        End If
                    End If

                    ' create the UI
                    oFrmGroup = oXform.addGroup(oXform.moXformElmt, "creditCard", "creditCard", sFormTitle)

                    Select Case nTransactionMode
                        Case TransactionMode.Test
                            oXform.addNote(oFrmGroup, noteTypes.Alert, "This payment method is in TEST mode, no actual payment will be collected")
                        Case TransactionMode.Fail
                            oXform.addNote(oFrmGroup, noteTypes.Alert, "This payment method is in FAIL mode, the transaction will always fail")
                    End Select

                    ' Adjust the title
                    Select Case mcPaymentType
                        Case "deposit" : oFrmGroup.SelectSingleNode("label").InnerText = "Make Deposit Payment"
                        Case "settlement" : oFrmGroup.SelectSingleNode("label").InnerText = Replace(sFormTitle, "Payment", "Settlement Payment")
                    End Select

                    ' If payment type is deposit then the payment amount can be adjusted
                    If mcPaymentType = "deposit" Then
                        Dim cCurrencyLabel As String = ""
                        If mcCurrency <> "" Then cCurrencyLabel = " (" & mcCurrency & ")"
                        oXform.addInput(oFrmGroup, "creditCard/amount", False, "Amount to be paid" & cCurrencyLabel, "textbox required")
                        oXform.addNote("creditCard/amount", noteTypes.Hint, "<span class=""hint-trans-dpamount"">Deposit (Must be a minimum of <span class=""dpmin"">" & mcCurrency & Me.mnPaymentAmount & "</span> up to a total value of <span class=""dpmax"">" & mcCurrency & Me.mnPaymentMaxAmount & "</span>)</span>")
                    End If

                    ' Optionally set cardholder name over billing address
                    If moCartConfig("CardholderName") = "on" Then
                        oXform.addInput(oFrmGroup, "creditCard/cardholder", False, "Name of cardholder", "textbox required")
                        oXform.addNote("creditCard/cardholder", noteTypes.Hint, "<span class=""hint-trans-cardholder"">Enter name exactly as it appears on the card</span>")

                    End If

                    oXform.addSelect1(oFrmGroup, "creditCard/type", False, "Card Type", "required", Protean.xForm.ApperanceTypes.Full)
                    aCardTypes = Split(cardTypes, ",")
                    For i = 0 To UBound(aCardTypes)
                        aCardTypes2 = Split(aCardTypes(i), ":")
                        oXform.addOption(oFrmGroup.LastChild, aCardTypes2(0), aCardTypes2(1))
                    Next
                    Dim oGroup As XmlElement
                    Select Case myWeb.moConfig("cssFramework")
                        Case "bs3"
                            oXform.addInput(oFrmGroup, "creditCard/number", False, "Card Number", "textbox required")
                            '  oGroup = oXform.addGroup(oFrmGroup, "cardDetails", "inline cardDetails")
                            oXform.addInput(oFrmGroup, "creditCard/expireDate", False, "Expire Date", "ccExpire required")
                            oXform.addInput(oFrmGroup, "creditCard/CV2", False, "Security Code (CV2)", "Cv2 textbox singleword required")
                            oXform.addNote("creditCard/CV2", noteTypes.Hint, "Please enter the last 3 digits printed on the signature strip on the back of your card.", False, "cv2hint")
                            oXform.addInput(oFrmGroup, "creditCard/issueDate", False, "Issue Date", "ccIssue")
                            'oXform.addNote("creditCard/issueDate", noteTypes.Hint, "If required")
                            oXform.addInput(oFrmGroup, "creditCard/issueNumber", False, "Issue Number", "issueNumber textbox singleword")
                            oXform.addNote("creditCard/issueNumber", noteTypes.Hint, "Required for some Maestro and Solo cards.")
                            'oXform.addDiv(oFrmGroup, "<div class=""CV2Info""><h3>Card verification number</h3><p>The card verification number is the last 3 digits on the signature strip on the back of your payment card.</p><img src=""/ewCommon/images/icons/cc/CVN.jpg""/></div>", "CV2Info")

                        Case Else
                            oXform.addInput(oFrmGroup, "creditCard/number", False, "Card Number", "textbox required")
                            oGroup = oXform.addGroup(oFrmGroup, "cardDetails", "cardDetails")
                            oXform.addInput(oGroup, "creditCard/expireDate", False, "Expire Date", "ccExpire required")
                            oXform.addInput(oGroup, "creditCard/CV2", False, "Card Verification No.", "Cv2 textbox singleword required")
                            'oXform.addNote("creditCard/CV2", noteTypes.Hint, "The last 3 digits printed on the signature strip on the back of the card.", False, "cv2hint")
                            oXform.addInput(oGroup, "creditCard/issueDate", False, "Issue Date", "ccIssue")
                            oXform.addNote("creditCard/issueDate", noteTypes.Hint, "If required")
                            oXform.addInput(oGroup, "creditCard/issueNumber", False, "Issue Number", "issueNumber textbox singleword")
                            oXform.addNote("creditCard/issueNumber", noteTypes.Hint, "Required for some Maestro and Solo cards.")
                            oXform.addDiv(oFrmGroup, "<div class=""CV2Info""><h3>Card verification number</h3><p>The card verification number is the last 3 digits on the signature strip on the back of your payment card.</p><img src=""/ewCommon/images/icons/cc/CVN.jpg""/></div>", "CV2Info")

                    End Select

                    Dim oSubs As New Subscriptions(myWeb)

                    'move this to logic to the payment provider not required if payment provider handles repeat payments such as paypal.
                    Dim bHasSub As Boolean = False 'oSubs.CheckCartForSubscriptions(Me.mnCartId, myWeb.mnUserId)

                    If bSavePayment Or bHasSub Then
                        Dim oInstElmt As XmlElement = oXform.moPageXML.CreateElement("bSavePayment")
                        If bHasSub Then oInstElmt.InnerText = "true"
                        oXform.Instance.FirstChild.AppendChild(oInstElmt)
                        Dim oSelElmt As XmlElement = oXform.addSelect(oFrmGroup, "creditCard/bSavePayment", False, " &#160;", "", ApperanceTypes.Full)
                        oXform.addOption(oSelElmt, "Save Payment Method?", "true")
                        oXform.addNote("creditCard/bSavePayment", noteTypes.Hint, "Important! If you want repeat billing to occur, this must be ticked.")
                        oXform.addBind("bSavePayment", "creditCard/bSavePayment")
                    End If

                    If b3dSecure Then
                        oXform.addNote(oFrmGroup, noteTypes.Hint, "<span class=""note-trans-fraud"">You may get re-directed to your own bank for further authentication. This additional step helps protect you from online fraud.</span>")
                    End If

                    oXform.addSubmit(oFrmGroup, formName, "Make Payment", "SubmitPayment")

                    'validate the Xform
                    If Not goRequest("creditCard/number") = Nothing Then
                        If cInstance = "" Then
                            oXform.updateInstanceFromRequest()
                        End If
                        oXform.valid = True

                        If mcPaymentType <> "Normal" Then
                            ' If we're in deposit mode, we need to validate the payment amount

                            ' If we're in deposit mode, check if the values submitted are valid
                            If mcPaymentType = "deposit" Then
                                If Not (IsNumeric(oXform.Instance.SelectSingleNode("creditCard/amount").InnerText)) Then
                                    oXform.addNote("creditCard/amount", noteTypes.Alert, "<span class=""note-trans-dpnan"">The amount entered was not a number.  Please ensure that you do not enter any symbols, such as currency symbols.</span>")
                                    oXform.AddValidationError("The amount entered was not a number.")
                                    oXform.valid = False
                                ElseIf (CDbl(oXform.Instance.SelectSingleNode("creditCard/amount").InnerText) < Me.mnPaymentAmount Or CDbl(oXform.Instance.SelectSingleNode("creditCard/amount").InnerText) > Me.mnPaymentMaxAmount) Then
                                    oXform.addNote("creditCard/amount", noteTypes.Alert, "<span class=""note-trans-dpamount"">The amount entered was not valid, please ensure that the amount is between <span class=""dpmin"">" & mcCurrency & Me.mnPaymentAmount & "</span> and <span class=""dpmax"">" & mcCurrency & Me.mnPaymentMaxAmount & "</span></span>")
                                    oXform.AddValidationError("The amount entered was not valid.")
                                    oXform.valid = False
                                End If
                            End If
                        End If

                        ' Check Expire / Issue Dates
                        Dim oObjCheck As XmlElement
                        Dim oRe As Regex = New Regex("^(\d{2}) (\d{4})$")
                        Dim oMatch As Match

                        Dim bDateState As Boolean = False
                        Dim cDateMessage As String = "The expiry date is not valid.  Please check the date on your card."
                        If Tools.Xml.NodeState(oXform.Instance, "creditCard/expireDate", , , , oObjCheck, , , True) = Tools.Xml.XmlNodeState.HasContents Then
                            ' Expiry Date is formatted as "04 2004"
                            ' Let's match the pattern

                            oMatch = oRe.Match(oXform.Instance.SelectSingleNode("creditCard/expireDate").InnerText)
                            If oMatch.Success Then
                                If oMatch.Groups.Count = 3 Then
                                    If String.Concat(oMatch.Groups(2).Value, oMatch.Groups(1).Value) < Date.Today.ToString("yyyyMM") Then
                                        cDateMessage = "The expiry date is in the past. Please check the date on your card."
                                    Else
                                        bDateState = True
                                    End If
                                End If
                            End If
                        Else
                            cDateMessage = "The expiry date is required."
                        End If

                        ' Expiry Date validation failed
                        If Not (bDateState) Then
                            oXform.addNote("creditCard/expireDate", noteTypes.Alert, "<span class=""note-trans-expdate"">" & cDateMessage & "</span>")
                            oXform.AddValidationError(cDateMessage)
                            oXform.valid = False
                        End If

                        bDateState = False
                        cDateMessage = "The issue date is not valid.  Please check the date on your card."
                        If Tools.Xml.NodeState(oXform.Instance, "creditCard/issueDate", , , , oObjCheck, , , True) = Tools.Xml.XmlNodeState.HasContents Then
                            ' Issue Date is formatted as "04 2004"
                            ' Let's match the pattern
                            oMatch = oRe.Match(oXform.Instance.SelectSingleNode("creditCard/issueDate").InnerText)
                            If oMatch.Success Then
                                If oMatch.Groups.Count = 3 Then
                                    If String.Concat(oMatch.Groups(2).Value, oMatch.Groups(1).Value) > Date.Today.ToString("yyyyMM") Then
                                        cDateMessage = "The issue date is in the past. Please check the date on your card."
                                    Else
                                        bDateState = True
                                    End If
                                End If
                            End If
                        Else
                            ' Not required
                            bDateState = True
                        End If

                        ' Issue Date validation failed
                        If Not (bDateState) Then
                            oXform.addNote("creditCard/issueDate", noteTypes.Alert, "<span class=""note-trans-isdate"">" & cDateMessage & "</span>")
                            oXform.AddValidationError(cDateMessage)
                            oXform.valid = False
                        End If


                        If bCV2 Then
                            If Not IsNumeric(oXform.Instance.SelectSingleNode("creditCard/CV2").InnerText) And Len(oXform.Instance.SelectSingleNode("creditCard/CV2").InnerText) <> 3 Then
                                oXform.addNote("creditCard/CV2", noteTypes.Alert, "Please provide the last 3 digits on the signature strip.")
                                oXform.AddValidationError("Please provide the last 3 digits on the signature strip.")
                                oXform.valid = False
                            End If
                        End If

                    Else
                        oXform.valid = bOverrideValidity
                    End If


                    ' Add processing for deposits on valid forms.
                    If mcPaymentType <> "Normal" And oXform.valid Then

                        ' Check for a bespoke payment amount
                        ' Amount is good, let's update the PaymentAmount to reflect this.
                        If mcPaymentType = "deposit" Then mnPaymentAmount = CDbl(oXform.Instance.SelectSingleNode("creditCard/amount").InnerText)

                        ' Update the Cart Element to reflect the updated figures
                        mnPaymentAmount = CDbl(FormatNumber(mnPaymentAmount, 2, TriState.True, TriState.False, TriState.False))

                        ' Work out the remaining payment needed
                        Select Case Me.mcPaymentType
                            Case "deposit"
                                nPayableAmount = mnPaymentMaxAmount - mnPaymentAmount
                            Case Else
                                nPayableAmount = 0
                        End Select

                        ' Let's update the cart element
                        oRoot.SetAttribute("paymentMade", CStr(mnPaymentAmount))
                        oRoot.SetAttribute("payableAmount", FormatNumber(nPayableAmount, 2, TriState.True, TriState.False, TriState.False))

                        ' Let's create a unique link
                        ' Make a unique link
                        Do While cUniqueLink = ""
                            nLinkNumber = CLng(System.Math.Ceiling(oRandom.NextDouble() * 89999999)) + 10000000
                            sSql = "select * from tblCartOrder where cSettlementID = '" & CStr(nLinkNumber) & "'"
                            odr = modbHelper.getDataReader(sSql)
                            If Not odr.HasRows Then cUniqueLink = CStr(nLinkNumber)
                            odr.Close()
                        Loop
                        oRoot.SetAttribute("settlementID", cUniqueLink)
                        oRoot.SetAttribute("transStatus", "Complete")
                    End If

                    If moCartConfig("CardholderName") = "on" And oXform.valid Then
                        ' Override mcCArdHoldername
                        If Not (oXform.Instance.SelectSingleNode("creditCard/cardholder") Is Nothing) Then
                            If oXform.Instance.SelectSingleNode("creditCard/cardholder").InnerText <> "" Then
                                Me.mcCardHolderName = oXform.Instance.SelectSingleNode("creditCard/cardholder").InnerText
                            End If
                        End If
                    End If

                    '   oXform.updateInstanceFromRequest()
                    oXform.addValues()

                    sProcess = oXform.moXformElmt.OuterXml()
                    sProcess = sProcess

                    creditCardXform = oXform

                Catch ex As Exception
                    returnException(mcModuleName, "creditCardXform", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function

            Function UkashXform(ByRef oRoot As XmlElement, Optional ByVal formName As String = "creditCard", Optional ByVal action As String = "", Optional ByVal sFormTitle As String = "Your Ukash Payment Details") As xForm
                PerfMon.Log("PaymentProviders", "UkashXform")
                Dim oXform As xForm = New xForm
                Dim oFrmInstance As XmlElement
                Dim oFrmGroup As XmlElement
                Dim bIsValid As Boolean = False
                Dim cUniqueLink As String = ""
                Dim oRandom As Random = New Random

                Dim sProcess As String
                Dim cProcessInfo As String = "creditCardXform"
                Try

                    'Reference together the root Xml from objects
                    oXform.moPageXML = Me.moPageXml

                    'First Define the xform
                    oXform.NewFrm(formName)
                    oXform.submission(formName, action, "POST", "return form_check(this);")
                    'create the instance
                    oFrmInstance = oXform.moPageXML.CreateElement("Ukash")
                    oXform.Instance.AppendChild(oFrmInstance)

                    oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("VoucherNumber"))
                    oXform.Instance.FirstChild.AppendChild(oXform.moPageXML.CreateElement("VoucherValue"))

                    ' create the UI
                    oFrmGroup = oXform.addGroup(oXform.moXformElmt, "Ukash", "Ukash", sFormTitle)

                    ' Adjust the title
                    Select Case mcPaymentType
                        Case "deposit" : oFrmGroup.SelectSingleNode("label").InnerText = "Make Deposit Payment"
                        Case "settlement" : oFrmGroup.SelectSingleNode("label").InnerText = Replace(sFormTitle, "Payment", "Settlement Payment")
                    End Select
                    oXform.addInput(oFrmGroup, "Ukash/VoucherNumber", False, "Ukash Voucher Number", "textbox required")
                    oXform.addInput(oFrmGroup, "Ukash/VoucherValue", False, "Ukash Voucher Value", "textbox required")

                    oXform.addSubmit(oFrmGroup, formName, "Submit")

                    'validate the Xform
                    If Not goRequest("Ukash/VoucherNumber") = Nothing Then
                        oXform.valid = True

                        If goRequest("Ukash/VoucherNumber") = "" Then
                            oXform.valid = False
                            oXform.addNote("Ukash/VoucherNumber", noteTypes.Alert, "Please enter the Ukash card number.  Please ensure that you do not enter any symbols, such as currency symbols.")
                        End If
                        If Not (IsNumeric(goRequest("Ukash/VoucherValue"))) Then
                            oXform.valid = False
                            oXform.addNote("Ukash/VoucherValue", noteTypes.Alert, "Please enter the Ukash card value.  Please ensure that you do not enter any symbols, such as currency symbols.")
                        End If
                        If goRequest("Ukash/VoucherValue") < Me.mnPaymentAmount Then
                            oXform.valid = False
                            oXform.addNote("Ukash/VoucherValue", noteTypes.Alert, "Your Ukash card value is lower than the transaction amount. To combine two Ukash cards go to www.ukash.com .")
                        End If
                        If oXform.valid = True Then
                            oXform.updateInstanceFromRequest()
                        End If
                    End If
                    oXform.addValues()

                    sProcess = oXform.moXformElmt.OuterXml()
                    sProcess = sProcess

                    UkashXform = oXform

                Catch ex As Exception
                    returnException(mcModuleName, "creditCardXform", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try

            End Function

            Function repeatSecPay(ByVal nPaymentMethodID As Integer, ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As String
                Try
                    Dim cSQL As String = " SELECT TOP 1 tblCartOrder.nCartOrderKey , tblCartPaymentMethod.*, tblAudit.dExpireDate " &
                    " FROM tblCartPaymentMethod INNER JOIN tblCartOrder ON tblCartPaymentMethod.nPayMthdKey = tblCartOrder.nPayMthdId INNER JOIN tblAudit ON tblCartPaymentMethod.nAuditId = tblAudit.nAuditKey " &
                    " WHERE (tblCartPaymentMethod.nPayMthdKey = " & nPaymentMethodID & ") " &
                    " ORDER BY tblCartOrder.nCartOrderKey"
                    Dim oSecpayCfg As XmlNode = moPaymentCfg.SelectSingleNode("provider[@name='SecPay']")
                    Dim oSecVpn As Paypoint.SECVPNClient = New Paypoint.SECVPNClient

                    Dim oDS As DataSet = myWeb.moDbHelper.GetDataSet(cSQL, "Payments")
                    Dim oRow As DataRow = oDS.Tables("Payments").Rows(0)

                    Dim cAcc As String = oSecpayCfg.SelectSingleNode("accountId/@value").InnerText
                    Dim cPW As String = oSecpayCfg.SelectSingleNode("accountPassword/@value").InnerText
                    Dim cTransId As String = oRow("ncartOrderKey")
                    Dim dExpiry As Date = CDate(oRow("dExpireDate"))
                    Dim cExpiry As String = dExpiry.Month
                    If cExpiry.Length = 1 Then cExpiry = "0" & cExpiry
                    cExpiry &= " " & dExpiry.Year
                    Dim cRemotePW As String = ""
                    If oSecpayCfg.SelectSingleNode("remotePassword/@value") Is Nothing Then
                        Throw New Exception("The configuration value 'remotePassword' has not been set for repeat payments.")
                    Else
                        cRemotePW = oSecpayCfg.SelectSingleNode("remotePassword/@value").InnerText
                    End If
                    Dim cResponse As String = oSecVpn.repeatCardFull(cAcc, cPW, cTransId, mnPaymentAmount, cRemotePW, mnCartId, fmtSecPayDate(cExpiry), getSecPayOrder(oRoot))
                    '?valid=false&trans_id=137&code=N&message=No {1} transaction found&resp_code=30
                    '?valid=false&trans_id=139&code=N&message=Invalid {1} password supplied&resp_code=30
                    '?valid=true&trans_id=140&code=A&auth_code=9999

                    Dim oDictResp As New Hashtable

                    'cResponse = Replace(oXMLHttp.responseXML.selectSingleNode("//node()[local-name()='validateCardFullReturn']").Text, "+", " ")
                    If cResponse <> "" Then
                        Dim aResponse() As String
                        aResponse = Split(Right(cResponse, Len(cResponse) - 1), "&")
                        Dim i As Integer
                        Dim nPos As Integer
                        For i = 0 To UBound(aResponse)
                            nPos = InStr(aResponse(i), "=")
                            oDictResp.Add(Left(aResponse(i), nPos - 1), Right(aResponse(i), Len(aResponse(i)) - nPos))
                        Next
                    End If
                    Debug.WriteLine(oDictResp.Count)
                    Dim bIsValid As Boolean
                    If oDictResp("valid") = "true" Then bIsValid = True

                    Dim err_msg_log As String = "Payment Failed : " & oDictResp("message") & " (Code::" & oDictResp("code") & ")"
                    Dim err_msg As String = ""
                    ' Produce nice format error messages.

                    Select Case oDictResp("code")
                        Case "N"
                            err_msg = "The transaction was not authorised by your payment provider."
                        Case "C"
                            err_msg = "There was a comunication problem. Please try resubmitting your order later."
                        Case "P:A"
                            err_msg = "There was a system error - the amount was not supplied or invalid.  Please call for assistance."
                        Case "P:X"
                            err_msg = "There was a system error - not all the mandatory parameters were supplied.  Please call for assistance."
                        Case "P:P"
                            err_msg = "The payment has already been processed.  This is a duplicate payment, and will not be processed."
                        Case "P:S"
                            err_msg = "The start date is invalid.  Please check that you have entered your card details correctly."
                        Case "P:E"
                            err_msg = "The expiry date is invalid.  Please check that you have entered your card details correctly."
                        Case "P:I"
                            err_msg = "The issue number is invalid.  Please check that you have entered your card details correctly."
                        Case "P:C"
                            err_msg = "The card number supplied is invalid.  Please check that you have entered your card details correctly."
                        Case "P:T"
                            err_msg = "The card type does not match the card number entered.  Please check that you have entered your card details correctly."
                        Case "P:N"
                            err_msg = "There was a system error - the customer name was not supplied.  Please call for assistance."
                        Case "P:M"
                            err_msg = "There was a system error - the merchant account deos not exist or has not been registered.  Please call for assistance."
                        Case "P:B"
                            err_msg = "There was a system error - the merchant account for this card type does not exist.  Please call for assistance."
                        Case "P:D"
                            err_msg = "There was a system error - the merchant account for this currency does not exist.  Please call for assistance."
                        Case "P:V"
                            err_msg = "The security code is invalid. Please check that you have entered your card details correctly. The security code can be found on the back of your card and is the last 3 digits of the series of digits on the back."
                        Case "P:R"
                            err_msg = "There was a communication problem and the transaction has timed out.  Please try resubmitting your order later."
                        Case "P:#"
                            err_msg = "There was a system error - no encryption key has been set up against this account.  Please call for assistance."
                        Case Else
                            err_msg = "There was an unspecified error. Please call for assistance.(code::" & oDictResp("code") & " | " & oDictResp("message")
                    End Select

                    err_msg = "Payment Failed : " & err_msg

                    If bIsValid Then
                        CartPaymentMethod(nPaymentMethodID)
                        Return ""
                    Else
                        Return err_msg
                    End If

                Catch ex As Exception
                    returnException(mcModuleName, "repeatSecPay", ex, "", "", gbDebug)
                    Return "An Error Occured"
                End Try
            End Function

            Function repeatProTx(ByVal nPaymentMethodID As Integer, ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As String

                PerfMon.Log("PaymentProviders", "payProTx")

                Dim cSQL As String = " SELECT TOP 1 tblCartOrder.nCartOrderKey , tblCartPaymentMethod.*, tblAudit.dExpireDate, cPayMthdDetailXml  " &
                " FROM tblCartPaymentMethod INNER JOIN tblCartOrder ON tblCartPaymentMethod.nPayMthdKey = tblCartOrder.nPayMthdId INNER JOIN tblAudit ON tblCartPaymentMethod.nAuditId = tblAudit.nAuditKey " &
                " WHERE (tblCartPaymentMethod.nPayMthdKey = " & nPaymentMethodID & ") " &
                " ORDER BY tblCartOrder.nCartOrderKey"
                Dim oDS As DataSet = myWeb.moDbHelper.GetDataSet(cSQL, "Payments")
                Dim oRow As DataRow = oDS.Tables("Payments").Rows(0)

                Dim oRepXML As New XmlDocument
                oRepXML.InnerXml = oRow("cPayMthdDetailXml")
                Dim oRepElmt As XmlElement = oRepXML.DocumentElement.SelectSingleNode("ProTx")
                Dim cRelatedVPSTxId As String = oRepElmt.GetAttribute("VPSTxId") ' - Returned
                Dim orderPrefix As String = ""

                Dim cRelatedVendorTxCode As String = oRow("nCartOrderKey") ' - Original Cart
                Dim cRelatedSecurityKey As String = oRepElmt.GetAttribute("SecurityKey") ' - Returned
                Dim cRelatedTxAuthNo As String = oRepElmt.GetAttribute("TxAuthNo") ' - Returned

                Dim oRequest As HttpWebRequest
                Dim oResponse As HttpWebResponse
                Dim oStream As System.IO.Stream
                Dim oStreamReader As StreamReader
                Dim nResult As Long

                Dim cResponse As String
                Dim cRequest As String
                Dim oEncoding As New ASCIIEncoding
                Dim byRequest As Byte()

                Dim cMessage As String

                Dim bIsValid As Boolean = False
                Dim err_msg As String = ""

                Dim oDictOpt As New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3dSecure As Boolean = False
                Dim oResponseDict As Hashtable = Nothing

                Dim b3dAuthorised As Boolean = False

                Dim oElmt As XmlElement

                Dim oProTxCfg As XmlNode
                Dim cIPAddress As String = goRequest.ServerVariables("REMOTE_ADDR")

                Dim sAPIVer As String = ""
                Dim sVSPUrl As String = ""
                Dim sVSP3DSUrl As String = ""


                Try

                    'Get the payment options into a hashtable
                    oProTxCfg = moPaymentCfg.SelectSingleNode("provider[@name='ProTx']")
                    For Each oElmt In oProTxCfg.SelectNodes("*")
                        If Not oElmt.GetAttribute("value") Is Nothing Then
                            oDictOpt.Add(oElmt.Name, oElmt.GetAttribute("value"))
                        End If
                    Next

                    If oDictOpt("sendPrefix") = "true" Then
                        orderPrefix = IIf(nTransactionMode = TransactionMode.Test, "D-", "") & moCartConfig("OrderNoPrefix")
                        cRelatedVendorTxCode = orderPrefix & cRelatedVendorTxCode
                    End If

                    If oDictOpt("validateCV2") = "on" Then bCv2 = True
                    If oDictOpt("secure3d") = "on" Then
                        b3dSecure = True
                        ' Check the IP Addresses for a block
                        If Not (oDictOpt("secure3dIpBlock") Is Nothing) Then
                            Dim oRE As Regex = New Regex("(,|^)" & Replace(cIPAddress, ".", "\.") & "(,|$)")
                            If oRE.IsMatch(oDictOpt("secure3dIpBlock")) Then b3dSecure = False
                        End If
                    End If


                    sAPIVer = "2.22"
                    Select Case oDictOpt("opperationMode")
                        Case "simulator"
                            'sVSPUrl = "https://ukvpstest.protx.com/VSPSimulator/VSPDirectGateway.asp"
                            sVSPUrl = "https://ukvpstest.protx.com/VSPSimulator/VSPServerGateway.asp?Service=VendorRepeatTx"
                            sVSP3DSUrl = "https://ukvpstest.protx.com/VSPSimulator/VSPDirectCallback.asp"
                        Case "test"
                            'sVSPUrl = "https://ukvpstest.protx.com/vspgateway/service/vspdirect-register.vsp"
                            sVSPUrl = "https://ukvpstest.protx.com/vspgateway/service/repeat.vsp"
                            sVSP3DSUrl = "https://ukvpstest.protx.com/vspgateway/service/direct3dcallback.vsp"
                        Case "live"
                            'sVSPUrl = "https://ukvps.protx.com/vspgateway/service/vspdirect-register.vsp"
                            sVSPUrl = "https://ukvps.protx.com/vspgateway/service/repeat.vsp"
                            sVSP3DSUrl = "https://ukvps.protx.com/vspgateway/service/direct3dcallback.vsp"
                    End Select



                    If b3dSecure Then
                        'check for return from aquiring bank
                        If goRequest("PARes") <> "" Then
                            b3dAuthorised = True
                        End If
                    End If

                    If b3dAuthorised Then
                        '3D Secure Resume
                        cRequest = "MD=" & goRequest("MD") & "&"
                        cRequest = cRequest & "PARes=" & goRequest("PARes") & "&"
                    Else
                        'standard card validation request

                        cRequest = "VPSProtocol=" & sAPIVer & "&"
                        cRequest = cRequest & "TxType=REPEAT&" '& sTXType & "&" ' 0=omited 1=full auth 2=pre-auth only
                        cRequest = cRequest & "Vendor=" & oDictOpt("accountId") & "&" ' 0=omited 1=full auth 2=pre-auth only
                        cRequest = cRequest & "VendorTXCode=" & goServer.UrlEncode(CStr(mnCartId)) & "&"
                        cRequest = cRequest & "Amount=" & goServer.UrlEncode(CStr(FullMoneyString(mnPaymentAmount))) & "&"
                        cRequest = cRequest & "Currency=" & goServer.UrlEncode(oDictOpt("currency")) & "&"
                        cRequest = cRequest & "Description=" & Left(goServer.UrlEncode(mcPaymentOrderDescription), 100) & "&"
                        cRequest = cRequest & "RelatedVPSTxId=" & goServer.UrlEncode(cRelatedVPSTxId) & "&"
                        cRequest = cRequest & "RelatedVendorTxCode=" & goServer.UrlEncode(cRelatedVendorTxCode) & "&"
                        cRequest = cRequest & "RelatedSecurityKey=" & goServer.UrlEncode(cRelatedSecurityKey) & "&"
                        cRequest = cRequest & "RelatedTxAuthNo=" & goServer.UrlEncode(cRelatedTxAuthNo)

                        ' Convert the request to bytes

                        byRequest = oEncoding.GetBytes(cRequest)

                        If b3dAuthorised Then
                            oRequest = HttpWebRequest.Create(sVSP3DSUrl)
                        Else
                            oRequest = HttpWebRequest.Create(sVSPUrl)
                        End If

                        oRequest.ContentType = "application/x-www-form-urlencoded"
                        oRequest.ContentLength = byRequest.Length
                        oRequest.Method = "POST"
                        oStream = oRequest.GetRequestStream
                        oStream.Write(byRequest, 0, byRequest.Length)
                        oStream.Close()

                        oResponse = oRequest.GetResponse()
                        oStream = oResponse.GetResponseStream()
                        oStreamReader = New StreamReader(oStream, System.Text.Encoding.UTF8)
                        cResponse = oStreamReader.ReadToEnd

                        oStreamReader.Close()
                        oResponse.Close()

                        ' Validate the response.

                        If cResponse = "" Or InStr(cResponse, "=") = 0 Then
                            err_msg = "There was a communications error."
                        Else
                            ' lets take the response and put it in a hash table
                            oResponseDict = UrlResponseToHashTable(cResponse, vbCrLf, "=")

                            nResult = oResponseDict("intStatus")

                            Select Case oResponseDict("Status")

                                Case "OK", "AUTHENTICATED", "REGISTERED"
                                    ' Successful Authorisation
                                    err_msg = "Payment was successful. Transaction ref: " & oResponseDict("VPSTxId")
                                    bIsValid = True

                                Case "3DAUTH"

                                    'create an xform that automatically redirects to Aquiring Banks 3DS portal.
                                    'Save MD as paymentRef
                                    goSession("VPSTxId") = oResponseDict("VPSTxId")
                                    goSession("SecurityKey") = oResponseDict("SecurityKey")

                                    Dim sRedirectURL As String
                                    sRedirectURL = moCartConfig("SecureURL") & "?cartCmd=SubmitPaymentDetails" & "&"

                                    bIsValid = False

                                    err_msg = "This card has subscribed to 3D Secure. You will now be re-directed to your banks website for further verification."


                                Case "MALFORMED", "INVALID", "NOTAUTHED", "REJECTED", "ERROR"
                                    ' Failed / Error Authorisation

                                    cMessage = oResponseDict("StatusDetail")

                                    If InStr(cMessage, "card number") > 0 Then err_msg = "The card number given is not valid."
                                    If InStr(cMessage, "IssueNumber") > 0 Then err_msg = "The issue number is not valid - it may not be required for non-Switch/Solo cards."
                                    If InStr(cMessage, "StartDate") > 0 Or InStr(cMessage, "Start Date") > 0 Then err_msg = "The issue date is not valid - it may not be required for Switch or Solo cards."
                                    If InStr(cMessage, "ExpiryDate") > 0 Or InStr(cMessage, "Expiry Date") > 0 Then err_msg = "The expiry date is not valid."


                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg = "There was an error processing this payment.<br/>  No payment has been made.<br/>  Please check the details you entered and try again, or call for assistance.<br/><br/>  The error returned from the bank was :<br/><br/> " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If

                                Case Else
                                    'Response not recognised.
                                    cMessage = oResponseDict("StatusDetail")

                                    If gbDebug Then
                                        err_msg = "<br/>Full Request:" & goServer.HtmlEncode(goServer.UrlDecode(cRequest)) & "<br/>Full Response:" & goServer.HtmlEncode(goServer.UrlDecode(cResponse))
                                    Else
                                        err_msg = "There was an error processing this payment.  No payment has been made.  Please check the details you entered and try again, or call for assistance.  The error detail was : " & goServer.HtmlEncode(goServer.UrlDecode(cMessage))
                                    End If
                            End Select
                        End If


                        'Update Seller Notes:
                        cSQL = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        oDS = New DataSet

                        oDS = modbHelper.getDataSetForUpdate(cSQL, "Order", "Cart")
                        For Each oRow In oDS.Tables("Order").Rows
                            If bIsValid Then
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Received) " & vbLf & "Transaction Ref:" & oResponseDict("VPSTxId") & vbLf & "comment: " & err_msg
                            Else
                                oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & Today & " " & TimeOfDay & ": changed to: (Payment Failed) " & vbLf & "comment: "
                            End If
                        Next
                        modbHelper.updateDataset(oDS, "Order")

                    End If

                    oRepXML.DocumentElement.SetAttribute("AmountPaid", mnPaymentAmount)
                    Dim oProTXElmt As XmlElement = oRepXML.DocumentElement.SelectSingleNode("ProTx")
                    oProTXElmt.SetAttribute("VPSTxId", oResponseDict.Item("VPSTxId"))
                    oProTXElmt.SetAttribute("SecurityKey", oResponseDict.Item("SecurityKey"))
                    oProTXElmt.SetAttribute("TxAuthNo", oResponseDict.Item("TxAuthNo"))

                    savedPaymentId = savePayment(myWeb.mnUserId, "ProTx", mnCartId, "ProTX", oRepXML.DocumentElement, Now, False, mnPaymentAmount)
                    If bIsValid Then
                        CartPaymentMethod(savedPaymentId)
                        'CartPaymentMethod(cRelatedVendorTxCode)
                        Return ""
                    Else
                        'err_msg = oResponseDict("Status") & "<br/>" & oResponseDict("StatusDetail")
                        Return err_msg
                    End If
                    ' Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payMetaCharge", ex, "", "", gbDebug)
                    Return "An Error Occured"
                End Try
            End Function

            Public Function savePayment(ByVal nUserId As Long, ByVal cProviderName As String, ByVal cProviderRef As String, ByVal cMethodName As String, ByVal oDetailXML As XmlElement, ByVal dExpire As Date, ByVal bUserSaved As Boolean, ByVal nAmountPaid As Double) As Integer
                Dim nPaymentId As Long
                Try
                    'TS - Moved to DBHelper
                    nPaymentId = myWeb.moDbHelper.savePayment(mnCartId, nUserId, cProviderName, cProviderRef, cMethodName, oDetailXML, dExpire, bUserSaved, nAmountPaid)
                    Return nPaymentId

                Catch ex As Exception
                    returnException(mcModuleName, "savePayment", ex, "", "", gbDebug)
                    Return 0
                End Try
            End Function

            Private Sub CartPaymentMethod(ByVal nPaymentId As Integer)
                Try
                    'TS - Moved to DBHelper
                    myWeb.moDbHelper.CartPaymentMethod(mnCartId, nPaymentId)

                Catch ex As Exception
                    returnException(mcModuleName, "CartPaymentMethod", ex, "", "", gbDebug)
                End Try
            End Sub

            Public Function ReturnRepeatPayments(ByVal cMethodName As String, ByRef oXForm As xForm, ByRef oSelectElmt As XmlElement) As Integer

                Dim nCount As Integer = 0

                Try

                    ' Don't return payments for non-users
                    If myWeb.mnUserId > 0 Then
                        Dim cSQL As String = "SELECT tblCartPaymentMethod.nPayMthdKey, tblCartPaymentMethod.cPayMthdProviderName, tblCartPaymentMethod.cPayMthdAcctName,  tblAudit.dExpireDate, tblCartPaymentMethod.cPayMthdDetailXml " &
                        " FROM tblCartPaymentMethod INNER JOIN tblAudit ON tblCartPaymentMethod.nAuditId = tblAudit.nAuditKey" &
                        " WHERE (tblCartPaymentMethod.nPayMthdUserId = " & myWeb.mnUserId & ") AND (tblCartPaymentMethod.cPayMthdProviderName = N'" & cMethodName & "') AND (tblAudit.dExpireDate > " & Protean.Tools.Database.SqlDate(Now) & ") AND (tblAudit.nStatus = 1)"
                        Dim oDS As DataSet = myWeb.moDbHelper.GetDataSet(cSQL, "PaymentMethods")
                        Dim oRow As DataRow

                        If oDS.Tables("PaymentMethods").Rows.Count = 0 Then Return 0

                        For Each oRow In oDS.Tables("PaymentMethods").Rows
                            Dim cDisplay As String = oRow("cPayMthdAcctName")
                            Dim oElmt As XmlElement = oXForm.Instance.OwnerDocument.CreateElement("Details")
                            oElmt.InnerXml = Replace(Replace(oRow("cPayMthdDetailXml"), "&gt;", ">"), "&lt;", "<")
                            If Not oElmt.FirstChild.Attributes("Display") Is Nothing Then cDisplay = oElmt.FirstChild.Attributes("Display").Value
                            oXForm.addOption(oSelectElmt, cDisplay, "Repeat_" & oRow("nPayMthdKey"))
                        Next

                        nCount = oDS.Tables("PaymentMethods").Rows.Count
                    End If


                    Return nCount

                Catch ex As Exception
                    returnException(mcModuleName, "ReturnRepeatPayments", ex, "", "", gbDebug)
                End Try
            End Function

            Public Function HasRepeatPayments() As Integer

                Try
                    If myWeb.mnUserId > 0 Then
                        Dim cSQL As String = "SELECT tblCartPaymentMethod.nPayMthdKey, tblCartPaymentMethod.cPayMthdProviderName, tblCartPaymentMethod.cPayMthdAcctName, " &
                        " tblAudit.dExpireDate, tblCartPaymentMethod.cPayMthdDetailXml " &
                        " FROM tblCartPaymentMethod INNER JOIN " &
                        " tblAudit ON tblCartPaymentMethod.nAuditId = tblAudit.nAuditKey" &
                        " WHERE (tblCartPaymentMethod.nPayMthdUserId = " & myWeb.mnUserId & ") AND (tblAudit.nStatus = 1) AND (tblAudit.dExpireDate > " & Protean.Tools.Database.SqlDate(Now) & ")"
                        Dim oDS As DataSet = myWeb.moDbHelper.GetDataSet(cSQL, "PaymentMethods")
                        Return oDS.Tables("PaymentMethods").Rows.Count
                    Else
                        Return 0
                    End If
                Catch ex As Exception
                    returnException(mcModuleName, "HasRepeatPayments", ex, "", "", gbDebug)
                End Try
            End Function

            Public Function payRepeat(ByVal nPaymentMethodID As Integer, ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As String

                Try
                    Dim cSQL As String = "SELECT cPayMthdProviderName FROM tblCartPaymentMethod WHERE nPayMthdKey = " & nPaymentMethodID
                    Dim cResult As String = myWeb.moDbHelper.ExeProcessSqlScalar(cSQL)
                    Select Case cResult
                        Case "SecPay"
                            Return repeatSecPay(nPaymentMethodID, oRoot, sSubmitPath)
                        Case "ProTx"
                            Return repeatProTx(nPaymentMethodID, oRoot, sSubmitPath)
                        Case Else
                            Return False
                    End Select
                Catch ex As Exception
                    returnException(mcModuleName, "payRepeat", ex, "", "", gbDebug)
                    Return False
                End Try
            End Function

            Function RepeatConfirmation(ByVal nPaymentId As Integer, ByRef oRoot As XmlElement, ByVal cAction As String, ByRef cRepeatPaymentError As String) As xForm

                PerfMon.Log("PaymentProviders", "RepeatConfirmation")
                Dim oXform As xForm = New xForm(myWeb)
                Dim bReValidate As Boolean = False

                Try
                    If moCartConfig("reValidateUserOnRepeat") = "on" Then bReValidate = True

                    oXform.moPageXML = Me.moPageXml
                    'First Define the xform
                    oXform.NewFrm("PayForm")
                    oXform.submission("PayForm", cAction, "POST", "return form_check(this);")
                    'create the instance
                    Dim oFrmInstance As XmlElement = oXform.moPageXML.CreateElement("creditCard")
                    oXform.Instance.AppendChild(oFrmInstance)
                    If bReValidate Then
                        oXform.addBind("cPassword", "Password", "true()", "reValidateUser")
                    End If
                    Dim oGrpElmt As XmlElement = oXform.addGroup(oXform.moXformElmt, "RepeatPayment", , "Confirm Payment Using:")
                    Dim cSQL As String = "SELECT cPayMthdAcctName FROM tblCartPaymentMethod WHERE nPayMthdKey = " & nPaymentId
                    Dim oDS As DataSet = myWeb.moDbHelper.GetDataSet(cSQL, "PaymentMethods")
                    Dim oRow As DataRow = oDS.Tables("PaymentMethods").Rows(0)
                    If bReValidate Then
                        oXform.addSecret(oGrpElmt, "cPassword", True, "Please re-enter your password", "required")
                    End If

                    oXform.addInput(oGrpElmt, "RepeatPayments/Repeat_" & nPaymentId, False, "", "hidden")
                    oXform.addInput(oGrpElmt, "RepeatPayments/Payment", False, "Payment Method", "readonly")

                    Select Case nTransactionMode
                        Case TransactionMode.Test
                            oXform.addNote(oGrpElmt, noteTypes.Alert, "This payment method is in TEST mode, no actual payment will be collected")
                        Case TransactionMode.Fail
                            oXform.addNote(oGrpElmt, noteTypes.Alert, "This payment method is in FAIL mode, the transaction will always fail")
                    End Select

                    oXform.addSubmit(oGrpElmt, "Cancel", "Cancel", "Cancel", "")
                    oXform.addSubmit(oGrpElmt, "Proceed", "Proceed", "Proceed")

                    oXform.Instance.InnerXml = "<RepeatPayments><Repeat_" & nPaymentId & ">" & nPaymentId & "</Repeat_" & nPaymentId & "><Payment>" & oRow("cPayMthdAcctName") & "</Payment></RepeatPayments><Password/>"
                    oXform.addValues()

                    If oXform.isSubmitted Then
                        'Debug.WriteLine("'" & oXform.getSubmitted & "'")
                        oXform.updateInstanceFromRequest()
                        oXform.validate()
                        If oXform.valid Then
                            If oXform.getSubmitted = "Cancel" Then
                                oXform.valid = False
                            ElseIf oXform.getSubmitted = "Proceed" Then
                                'we can proceed
                                Dim cResult As String = payRepeat(nPaymentId, oRoot, mcPagePath & "?cartCmd=SubmitPaymentDetails")
                                If cResult = "" Then
                                    oXform.valid = True
                                Else
                                    oXform.valid = False
                                    cRepeatPaymentError = cResult
                                    oXform.addNote(oGrpElmt, noteTypes.Alert, cRepeatPaymentError, True)
                                End If
                            Else
                                Me.valid = False
                            End If
                        End If
                    Else
                        Me.valid = False
                    End If
                    Return oXform

                Catch ex As Exception
                    returnException(mcModuleName, "creditCardXform", ex, "", "", gbDebug)
                    Return Nothing
                End Try

            End Function

            Public Sub ValidatePaymentByCart(ByVal nCartId As Integer, ByVal bValid As Boolean)
                Try
                    'sets the validity of the payment
                    'get the audit id 
                    Dim cSQL As String = "SELECT tblAudit.nAuditKey FROM tblCartOrder INNER JOIN tblCartPaymentMethod ON tblCartOrder.nPayMthdId = tblCartPaymentMethod.nPayMthdKey INNER JOIN tblAudit ON tblCartPaymentMethod.nAuditId = tblAudit.nAuditKey WHERE tblCartOrder.nCartOrderKey = " & nCartId
                    Dim nAuditId As String = myWeb.moDbHelper.ExeProcessSqlScalar(cSQL)
                    If IsNumeric(nAuditId) Then

                        Dim oXml As XmlDocument = New XmlDocument
                        Dim oInstance As XmlElement = oXml.CreateElement("Instance")
                        Dim oElmt As XmlElement = oXml.CreateElement("tblAudit")
                        addNewTextNode("nAuditKey", oElmt, nAuditId)
                        addNewTextNode("nStatus", oElmt, IIf(bValid, 1, 0))
                        oInstance.AppendChild(oElmt)

                        myWeb.moDbHelper.setObjectInstance(dbHelper.objectTypes.Audit, oInstance, nAuditId)

                    End If
                Catch ex As Exception
                    returnException(mcModuleName, "ValidatePaymentByCart", ex, "", "", gbDebug)
                End Try
            End Sub

            Public Function FullMoneyString(ByVal amount As String) As String
                Try
                    If Not amount.Contains(".") Then Return Replace(amount, ",", "")
                    amount = Replace(amount, ",", "")
                    Dim cAmounts() As String = Split(amount, ".")
                    If UBound(cAmounts) > 2 Then Return amount
                    amount = cAmounts(0) & "."
                    If cAmounts(1).Length < 2 Then
                        amount &= cAmounts(1) & "0"
                    Else
                        amount &= cAmounts(1)
                    End If
                    Return amount
                Catch ex As Exception
                    returnException(mcModuleName, "FullMoneyString", ex, "", "", gbDebug)
                    Return amount
                End Try

            End Function


            Function payPremiumCredit(ByRef oRoot As XmlElement, ByVal sSubmitPath As String) As xForm
                PerfMon.Log("PaymentProviders", "payPremiumCredit")
                Dim sSql As String

                Dim ccXform As xForm = New xForm

                Dim err_msg As String = ""
                Dim err_msg_log As String = ""
                Dim sProcessInfo As String = ""

                Dim oDictOpt As Hashtable = New Hashtable

                Dim bCv2 As Boolean = False
                Dim b3DSecure As Boolean = False
                Dim b3DAuthorised As Boolean = False
                Dim sRedirectURL As String = ""
                Dim sPaymentRef As String = ""
                Dim sTransactionReport As String = ""

                Dim cProcessInfo As String = "payPremiumCredit"

                'Get the payment options into a hashtable
                Dim oPclCfg As XmlNode
                Dim bSavePayment As Boolean = False

                Try

                    'Reference together the root Xml from objects
                    ccXform.moPageXML = Me.moPageXml

                    ' Get the payment options
                    oPclCfg = moPaymentCfg.SelectSingleNode("provider[@name='PremiumCredit']")
                    oDictOpt = xmlTools.xmlToHashTable(oPclCfg, "value")

                    Dim bTestMode As Boolean = IIf(oDictOpt("OpperationMode") = "test", True, False)


                    ' override the currency
                    If oDictOpt.ContainsKey("currency") Then oDictOpt.Remove("currency")
                    oDictOpt.Add("currency", mcCurrency)

                    'Load the Xform

                    If Not ccXform.load("/xforms/cart/payment/PremiumCredit.xml", myWeb.maCommonFolders) Then
                        ccXform.NewFrm("errorForm")
                        ccXform.addGroup(ccXform.moXformElmt, "notes", , "Missing File: /ewcommon/xforms/cart/payment/PremiumCredit.xml")
                    End If

                    'update submit path
                    ccXform.submission("payment", sSubmitPath, "POST", "return form_check(this);")

                    Dim oBusiness As XmlElement = ccXform.Instance.SelectSingleNode("CreateNewBusiness/Business")



                    'populate from Cart Billing Contact
                    Dim aGivenName() As String = Split(moBillingContact.SelectSingleNode("GivenName").InnerText, " ")

                    oBusiness.SelectSingleNode("PolicyClientReference").InnerText = mcOrderRef
                    oBusiness.SelectSingleNode("CustTitle").InnerText = aGivenName(0)
                    oBusiness.SelectSingleNode("CustForeNames").InnerText = aGivenName(1)
                    oBusiness.SelectSingleNode("CustSurname").InnerText = aGivenName(2)
                    oBusiness.SelectSingleNode("CustAddress1").InnerText = moBillingContact.SelectSingleNode("Street").InnerText
                    oBusiness.SelectSingleNode("CustAddress2").InnerText = ""
                    oBusiness.SelectSingleNode("CustAddress3").InnerText = ""
                    oBusiness.SelectSingleNode("CustAddress4").InnerText = moBillingContact.SelectSingleNode("City").InnerText
                    oBusiness.SelectSingleNode("CustAddress5").InnerText = moBillingContact.SelectSingleNode("State").InnerText
                    oBusiness.SelectSingleNode("CustPostCode").InnerText = moBillingContact.SelectSingleNode("PostalCode").InnerText
                    oBusiness.SelectSingleNode("CustWorkTel").InnerText = moBillingContact.SelectSingleNode("Telephone").InnerText
                    oBusiness.SelectSingleNode("CustHomeTel").InnerText = IIf(moBillingContact.SelectSingleNode("Fax").InnerText = "", moBillingContact.SelectSingleNode("Telephone").InnerText, moBillingContact.SelectSingleNode("Fax").InnerText)

                    If bTestMode Then
                        'Case for TEST
                        Dim oFormGroup As XmlElement
                        oFormGroup = ccXform.moXformElmt.SelectSingleNode("descendant-or-self::group")
                        If Not oFormGroup Is Nothing Then
                            ccXform.addNote(oFormGroup, noteTypes.Alert, "!!! THIS TRANSACTION IS IN TEST MODE, NO FUNDS WILL BE TAKEN")
                        End If

                        ''Do the stuff here...
                        Dim oPclTrans As New Protean.com.pclplstest.www.XMLTransferEngine 'Object 'com.pclpls.www.XMLTransferEngine
                        'Lets go and get some quotes from PCL for payment options

                        Dim bOverrideRate As Boolean = IIf(oDictOpt("OverrideRate") = "true" Or oDictOpt("OverrideRate") = "True" Or oDictOpt("OverrideRate") = "on", True, False)
                        ' Dim oSchemeCodeInput As XmlElement = ccXform.moXformElmt.SelectSingleNode("descendant-or-self::select1[@bind='SchemeCode']")

                        Dim oPclSchemeQuoteSelected As Protean.com.pclplstest.www.SchemeQuote = Nothing
                        Dim nSchemeOptCount As Integer = 0

                        Dim oPclQuotation As Protean.com.pclplstest.www.Quotation
                        Dim oPclSchemeQuote As Protean.com.pclplstest.www.SchemeQuote

                        oPclQuotation = oPclTrans.GetQuote(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness, mnPaymentAmount * 100, oDictOpt("PPICode"), oDictOpt("ChargePercentage"), bOverrideRate)

                        For Each oPclSchemeQuote In oPclQuotation.SchemeQuotes
                            If oPclSchemeQuote.SchemeCode = oDictOpt("SchemeCode") Then
                                oPclSchemeQuoteSelected = oPclSchemeQuote
                            End If
                        Next

                        oBusiness.SelectSingleNode("ClientPremium").InnerText = oPclSchemeQuoteSelected.Premium
                        oBusiness.SelectSingleNode("ChargePercentage").InnerText = oPclSchemeQuoteSelected.APR
                        oBusiness.SelectSingleNode("NumInstalments").InnerText = oPclSchemeQuoteSelected.NumInstalments
                        oBusiness.SelectSingleNode("InstalmentAmt").InnerText = oPclSchemeQuoteSelected.Instalment
                        oBusiness.SelectSingleNode("DepositAmt").InnerText = oPclSchemeQuoteSelected.Instalment

                        If goRequest("cPaymentMethod") <> "" Then
                            oBusiness.SelectSingleNode("SchemeCode").InnerText = goRequest("cPaymentMethod")
                        End If



                        '  nSchemeOptCount = getPremiumCreditPaymentMethods(ccXform, oSchemeCodeInput, nClientPremium, cPaymentMethod)

                        'First we update the instance from the cart.

                        'Customer Contact Details

                        If goRequest("confirmPaymentDetails") <> "" Then
                            ccXform.updateInstanceFromRequest()
                            ccXform.validate()
                            If ccXform.valid Then

                                Dim oPclNewBusiness As New Protean.com.pclplstest.www.NewBusiness

                                oPclNewBusiness.AddCoverCode = oBusiness.SelectSingleNode("AddCoverCode").InnerText
                                oPclNewBusiness.BankAccountName = oBusiness.SelectSingleNode("BankAccountName").InnerText
                                oPclNewBusiness.BankAccountNumber = oBusiness.SelectSingleNode("BankAccountNumber").InnerText
                                oPclNewBusiness.BankSortCode = Replace(oBusiness.SelectSingleNode("BankSortCode").InnerText, "-", "")
                                oPclNewBusiness.BusinessType = "N" '(N)ew or (R)enewal
                                oPclNewBusiness.ChargePercentage = -1 'oPclSchemeQuoteSelected.ServiceChargePercentage
                                oPclNewBusiness.ClientPremium = oPclSchemeQuoteSelected.Premium
                                oPclNewBusiness.ContractDate = mdFulfillmentDate
                                oPclNewBusiness.CreditAgreementDate = mdFulfillmentDate
                                oPclNewBusiness.CreditRenewalDate = DateAdd(DateInterval.Year, 1, mdFulfillmentDate)
                                oPclNewBusiness.CustAddress1 = oBusiness.SelectSingleNode("CustAddress1").InnerText
                                oPclNewBusiness.CustAddress2 = oBusiness.SelectSingleNode("CustAddress2").InnerText
                                oPclNewBusiness.CustAddress3 = oBusiness.SelectSingleNode("CustAddress3").InnerText
                                oPclNewBusiness.CustAddress4 = oBusiness.SelectSingleNode("CustAddress4").InnerText
                                oPclNewBusiness.CustAddress5 = oBusiness.SelectSingleNode("CustAddress5").InnerText
                                oPclNewBusiness.CustForeNames = oBusiness.SelectSingleNode("CustForeNames").InnerText
                                oPclNewBusiness.CustHomeTel = oBusiness.SelectSingleNode("CustHomeTel").InnerText
                                oPclNewBusiness.CustPostCode = oBusiness.SelectSingleNode("CustPostCode").InnerText
                                oPclNewBusiness.CustSurname = oBusiness.SelectSingleNode("CustSurname").InnerText
                                oPclNewBusiness.CustTitle = oBusiness.SelectSingleNode("CustTitle").InnerText
                                oPclNewBusiness.CustWorkTel = oBusiness.SelectSingleNode("CustWorkTel").InnerText
                                oPclNewBusiness.DepositAmt = oPclSchemeQuoteSelected.Instalment
                                oPclNewBusiness.EntryType = oBusiness.SelectSingleNode("EntryType").InnerText
                                oPclNewBusiness.InstalmentAmt = oPclSchemeQuoteSelected.Instalment
                                oPclNewBusiness.NumInstalments = oPclSchemeQuoteSelected.NumInstalments
                                oPclNewBusiness.PolicyClientReference = oBusiness.SelectSingleNode("PolicyClientReference").InnerText
                                oPclNewBusiness.PrefPaymentDate = oBusiness.SelectSingleNode("PrefPaymentDate").InnerText
                                oPclNewBusiness.SchemeBranch = oDictOpt("SchemeBrokerNo")
                                oPclNewBusiness.SchemeBrokerNo = oDictOpt("SchemeBrokerNo")
                                oPclNewBusiness.SchemeCode = oBusiness.SelectSingleNode("SchemeCode").InnerText
                                oPclNewBusiness.TransID = oPclTrans.GetNextTransactionID(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness)

                                Dim oPclTransResult As Protean.com.pclplstest.www.TransactionResult

                                oPclTransResult = oPclTrans.CreateNewBusiness(oDictOpt("UserName"), oDictOpt("Password"), oPclNewBusiness)

                                If oPclTransResult.Success Then

                                    Dim cMethodName As String = "Direct Debit"

                                    Dim oSecPayElmt As XmlElement = ccXform.Instance.OwnerDocument.CreateElement("PremiumCredit")
                                    ' oSecPayElmt.SetAttribute("AuthCode", cAuthCode)
                                    ccXform.Instance.FirstChild.AppendChild(oSecPayElmt)

                                    savePayment(myWeb.mnUserId, "PremiumCredit", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, True, mnPaymentAmount)

                                    ccXform.addNote(ccXform.moXformElmt, xForm.noteTypes.Alert, err_msg)

                                    'Update Seller Notes:
                                    sTransactionReport = vbLf & Today & " " & TimeOfDay & ": changed to: (PremiumCredit Payment Successfull) "
                                Else
                                    'We'll sniff for error codes in an overloaded xslt
                                    sTransactionReport = vbLf & Today & " " & TimeOfDay & ": changed to: (PremiumCredit Payment Failed) " & vbLf & "comment: " & oPclTransResult.ErrorCode.ToString & " " & oPclTransResult.Message

                                    ccXform.addNote("payDetails", noteTypes.Alert, oPclTransResult.ErrorCode.ToString & " " & oPclTransResult.Message, True)
                                    ccXform.valid = False

                                End If
                            End If
                        End If

                        'Update Seller Notes:

                        ccXform.addValues()
                    Else
                        'Case for LIVE
                        ''Do the stuff here...
                        Dim oPclTrans As New Protean.com.pclpls.www.XMLTransferEngine 'Object 'com.pclpls.www.XMLTransferEngine
                        'Lets go and get some quotes from PCL for payment options


                        Dim bOverrideRate As Boolean = IIf(oDictOpt("OverrideRate") = "true" Or oDictOpt("OverrideRate") = "True" Or oDictOpt("OverrideRate") = "on", True, False)
                        ' Dim oSchemeCodeInput As XmlElement = ccXform.moXformElmt.SelectSingleNode("descendant-or-self::select1[@bind='SchemeCode']")

                        Dim oPclSchemeQuoteSelected As Protean.com.pclpls.www.SchemeQuote = Nothing
                        Dim nSchemeOptCount As Integer = 0

                        Dim oPclQuotation As Protean.com.pclpls.www.Quotation
                        Dim oPclSchemeQuote As Protean.com.pclpls.www.SchemeQuote

                        oPclQuotation = oPclTrans.GetQuote(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness, mnPaymentAmount * 100, oDictOpt("PPICode"), oDictOpt("ChargePercentage"), bOverrideRate)

                        For Each oPclSchemeQuote In oPclQuotation.SchemeQuotes
                            If oPclSchemeQuote.SchemeCode = oDictOpt("SchemeCode") Then
                                oPclSchemeQuoteSelected = oPclSchemeQuote
                            End If
                        Next

                        oBusiness.SelectSingleNode("ClientPremium").InnerText = oPclSchemeQuoteSelected.Premium
                        oBusiness.SelectSingleNode("ChargePercentage").InnerText = oPclSchemeQuoteSelected.APR
                        oBusiness.SelectSingleNode("NumInstalments").InnerText = oPclSchemeQuoteSelected.NumInstalments
                        oBusiness.SelectSingleNode("InstalmentAmt").InnerText = oPclSchemeQuoteSelected.Instalment
                        oBusiness.SelectSingleNode("DepositAmt").InnerText = oPclSchemeQuoteSelected.Instalment

                        If goRequest("cPaymentMethod") <> "" Then
                            oBusiness.SelectSingleNode("SchemeCode").InnerText = goRequest("cPaymentMethod")
                        End If



                        '  nSchemeOptCount = getPremiumCreditPaymentMethods(ccXform, oSchemeCodeInput, nClientPremium, cPaymentMethod)

                        'First we update the instance from the cart.

                        'Customer Contact Details

                        If goRequest("confirmPaymentDetails") <> "" Then
                            ccXform.updateInstanceFromRequest()
                            ccXform.validate()
                            If ccXform.valid Then

                                Dim oPclNewBusiness As New Protean.com.pclpls.www.NewBusiness

                                oPclNewBusiness.AddCoverCode = oBusiness.SelectSingleNode("AddCoverCode").InnerText
                                oPclNewBusiness.BankAccountName = oBusiness.SelectSingleNode("BankAccountName").InnerText
                                oPclNewBusiness.BankAccountNumber = oBusiness.SelectSingleNode("BankAccountNumber").InnerText
                                oPclNewBusiness.BankSortCode = Replace(oBusiness.SelectSingleNode("BankSortCode").InnerText, "-", "")
                                oPclNewBusiness.BusinessType = "N" '(N)ew or (R)enewal
                                oPclNewBusiness.ChargePercentage = -1 'oPclSchemeQuoteSelected.ServiceChargePercentage
                                oPclNewBusiness.ClientPremium = oPclSchemeQuoteSelected.Premium
                                oPclNewBusiness.ContractDate = mdFulfillmentDate
                                oPclNewBusiness.CreditAgreementDate = mdFulfillmentDate
                                oPclNewBusiness.CreditRenewalDate = DateAdd(DateInterval.Year, 1, mdFulfillmentDate)
                                oPclNewBusiness.CustAddress1 = oBusiness.SelectSingleNode("CustAddress1").InnerText
                                oPclNewBusiness.CustAddress2 = oBusiness.SelectSingleNode("CustAddress2").InnerText
                                oPclNewBusiness.CustAddress3 = oBusiness.SelectSingleNode("CustAddress3").InnerText
                                oPclNewBusiness.CustAddress4 = oBusiness.SelectSingleNode("CustAddress4").InnerText
                                oPclNewBusiness.CustAddress5 = oBusiness.SelectSingleNode("CustAddress5").InnerText
                                oPclNewBusiness.CustForeNames = oBusiness.SelectSingleNode("CustForeNames").InnerText
                                oPclNewBusiness.CustHomeTel = oBusiness.SelectSingleNode("CustHomeTel").InnerText
                                oPclNewBusiness.CustPostCode = oBusiness.SelectSingleNode("CustPostCode").InnerText
                                oPclNewBusiness.CustSurname = oBusiness.SelectSingleNode("CustSurname").InnerText
                                oPclNewBusiness.CustTitle = oBusiness.SelectSingleNode("CustTitle").InnerText
                                oPclNewBusiness.CustWorkTel = oBusiness.SelectSingleNode("CustWorkTel").InnerText
                                ' oPclNewBusiness.DepositAmt = oPclSchemeQuoteSelected.Instalment
                                oPclNewBusiness.EntryType = oBusiness.SelectSingleNode("EntryType").InnerText
                                oPclNewBusiness.InstalmentAmt = oPclSchemeQuoteSelected.Instalment
                                oPclNewBusiness.NumInstalments = oPclSchemeQuoteSelected.NumInstalments
                                oPclNewBusiness.PolicyClientReference = oBusiness.SelectSingleNode("PolicyClientReference").InnerText
                                oPclNewBusiness.PrefPaymentDate = oBusiness.SelectSingleNode("PrefPaymentDate").InnerText
                                oPclNewBusiness.SchemeBranch = oDictOpt("SchemeBrokerNo")
                                oPclNewBusiness.SchemeBrokerNo = oDictOpt("SchemeBrokerNo")
                                oPclNewBusiness.SchemeCode = oBusiness.SelectSingleNode("SchemeCode").InnerText
                                oPclNewBusiness.TransID = oPclTrans.GetNextTransactionID(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness)

                                Dim oPclTransResult As Protean.com.pclpls.www.TransactionResult

                                oPclTransResult = oPclTrans.CreateNewBusiness(oDictOpt("UserName"), oDictOpt("Password"), oPclNewBusiness)

                                If oPclTransResult.Success Then

                                    Dim cMethodName As String = "Direct Debit"

                                    Dim oSecPayElmt As XmlElement = ccXform.Instance.OwnerDocument.CreateElement("PremiumCredit")
                                    ' oSecPayElmt.SetAttribute("AuthCode", cAuthCode)
                                    ccXform.Instance.FirstChild.AppendChild(oSecPayElmt)

                                    savePayment(myWeb.mnUserId, "PremiumCredit", mnCartId, cMethodName, ccXform.Instance.FirstChild, Now, True, mnPaymentAmount)

                                    ccXform.addNote(ccXform.moXformElmt, xForm.noteTypes.Alert, err_msg)

                                    'Update Seller Notes:
                                    sTransactionReport = vbLf & Today & " " & TimeOfDay & ": changed to: (PremiumCredit Payment Successfull) "
                                Else
                                    'We'll sniff for error codes in an overloaded xslt
                                    sTransactionReport = vbLf & Today & " " & TimeOfDay & ": changed to: (PremiumCredit Payment Failed) " & vbLf & "comment: " & oPclTransResult.ErrorCode.ToString & " " & oPclTransResult.Message
                                    ccXform.addNote("payDetails", noteTypes.Alert, oPclTransResult.ErrorCode.ToString & " " & oPclTransResult.Message, True)
                                    ccXform.valid = False
                                End If
                            End If
                        End If

                        ccXform.addValues()

                    End If

                    If sTransactionReport <> "" Then
                        sSql = "select * from tblCartOrder where nCartOrderKey = " & mnCartId
                        Dim oDs As DataSet
                        Dim oRow As DataRow
                        oDs = modbHelper.getDataSetForUpdate(sSql, "Order", "Cart")
                        For Each oRow In oDs.Tables("Order").Rows
                            oRow("cSellerNotes") = oRow("cSellerNotes") & vbLf & sTransactionReport
                        Next
                        modbHelper.updateDataset(oDs, "Order")
                    End If


                    Return ccXform

                Catch ex As Exception
                    returnException(mcModuleName, "payPremiumCredit", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

            Function getPremiumCreditPaymentMethods(ByRef oOptXform As xForm, ByRef oSelectElmt As XmlElement, ByVal nClientPremium As Double, ByRef cPaymentMethod As String) As Integer
                PerfMon.Log("PaymentProviders", "getPremiumCreditPaymentMethods")
                Dim cProcessInfo As String = "getPremiumCreditPaymentMethods"
                Dim bFirstRow As Boolean = True
                Dim nOptCount As Integer = 0
                Dim oPclCfg As XmlNode

                Dim oDictOpt As Hashtable = New Hashtable
                Try

                    oPclCfg = moPaymentCfg.SelectSingleNode("provider[@name='PremiumCredit']")
                    oDictOpt = xmlTools.xmlToHashTable(oPclCfg, "value")

                    Dim bTestMode As Boolean = IIf(oDictOpt("OpperationMode") = "test", True, False)

                    If bTestMode Then

                        Dim oPclTrans As New Protean.com.pclplstest.www.XMLTransferEngine
                        Dim oPclQuotation As Protean.com.pclplstest.www.Quotation
                        Dim oPclSchemeQuote As Protean.com.pclplstest.www.SchemeQuote

                        Dim bOverrideRate As Boolean = IIf(oDictOpt("OverrideRate") = "true" Or oDictOpt("OverrideRate") = "True" Or oDictOpt("OverrideRate") = "on", True, False)

                        oPclQuotation = oPclTrans.GetQuote(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness, nClientPremium * 100, oDictOpt("PPICode"), oDictOpt("ChargePercentage"), bOverrideRate)

                        For Each oPclSchemeQuote In oPclQuotation.SchemeQuotes
                            If oPclSchemeQuote.SchemeCode = oDictOpt("SchemeCode") Then
                                Dim oQuoteXml As XmlElement = moPageXml.CreateElement("Quote")
                                Protean.Tools.Xml.addNewTextNode("APR", oQuoteXml, oPclSchemeQuote.APR)
                                Protean.Tools.Xml.addNewTextNode("APRNoMSC", oQuoteXml, oPclSchemeQuote.APRNoMSC)
                                Protean.Tools.Xml.addNewTextNode("BasicServiceChargePercentage", oQuoteXml, oPclSchemeQuote.BasicServiceChargePercentage)
                                Protean.Tools.Xml.addNewTextNode("CCAScheme", oQuoteXml, oPclSchemeQuote.CCAScheme)
                                Protean.Tools.Xml.addNewTextNode("DefaultPeriod", oQuoteXml, oPclSchemeQuote.DefaultPeriod)
                                Protean.Tools.Xml.addNewTextNode("Instalment", oQuoteXml, oPclSchemeQuote.Instalment / 100)
                                Protean.Tools.Xml.addNewTextNode("InstalmentGap", oQuoteXml, oPclSchemeQuote.InstalmentGap)
                                Protean.Tools.Xml.addNewTextNode("InstalmentHoliday", oQuoteXml, oPclSchemeQuote.InstalmentHoliday)
                                Protean.Tools.Xml.addNewTextNode("InstalmentNoMSC", oQuoteXml, oPclSchemeQuote.InstalmentNoMSC)
                                Protean.Tools.Xml.addNewTextNode("InstalmentUnit", oQuoteXml, oPclSchemeQuote.InstalmentUnit)
                                Protean.Tools.Xml.addNewTextNode("InstalmentWithPPI", oQuoteXml, oPclSchemeQuote.InstalmentWithPPI)
                                Protean.Tools.Xml.addNewTextNode("InterestFree", oQuoteXml, oPclSchemeQuote.InterestFree)
                                Protean.Tools.Xml.addNewTextNode("MinimumServiceCharge", oQuoteXml, oPclSchemeQuote.MinimumServiceCharge)
                                Protean.Tools.Xml.addNewTextNode("NumInstalments", oQuoteXml, oPclSchemeQuote.NumInstalments)
                                Protean.Tools.Xml.addNewTextNode("OverrideRate", oQuoteXml, oPclSchemeQuote.OverrideRate)
                                Protean.Tools.Xml.addNewTextNode("PlasmaMessages", oQuoteXml, oPclSchemeQuote.PlasmaMessages)
                                Protean.Tools.Xml.addNewTextNode("PPICode", oQuoteXml, oPclSchemeQuote.PPICode)
                                Protean.Tools.Xml.addNewTextNode("Premium", oQuoteXml, oPclSchemeQuote.Premium / 100)
                                Protean.Tools.Xml.addNewTextNode("RequiredRate", oQuoteXml, oPclSchemeQuote.RequiredRate)
                                Protean.Tools.Xml.addNewTextNode("SchemeCode", oQuoteXml, oPclSchemeQuote.SchemeCode)
                                Protean.Tools.Xml.addNewTextNode("SchemeDefaultDeposit", oQuoteXml, oPclSchemeQuote.SchemeDefaultDeposit)
                                Protean.Tools.Xml.addNewTextNode("SchemeMinimumServiceCharge", oQuoteXml, oPclSchemeQuote.SchemeMinimumServiceCharge)
                                Protean.Tools.Xml.addNewTextNode("SchemeName", oQuoteXml, oPclSchemeQuote.SchemeName)
                                Protean.Tools.Xml.addNewTextNode("SchemeType", oQuoteXml, oPclSchemeQuote.SchemeType)
                                Protean.Tools.Xml.addNewTextNode("ServiceChargePercentage", oQuoteXml, oPclSchemeQuote.ServiceChargePercentage)
                                Protean.Tools.Xml.addNewTextNode("ServiceChargePercentageNoMSC", oQuoteXml, oPclSchemeQuote.ServiceChargePercentageNoMSC)
                                Protean.Tools.Xml.addNewTextNode("TotalPayable", oQuoteXml, oPclSchemeQuote.TotalPayable / 100)
                                Protean.Tools.Xml.addNewTextNode("TotalPayableNoMSC", oQuoteXml, oPclSchemeQuote.TotalPayableNoMSC / 100)
                                Protean.Tools.Xml.addNewTextNode("TotalPayableWithPPI", oQuoteXml, oPclSchemeQuote.TotalPayableWithPPI / 100)
                                Protean.Tools.Xml.addNewTextNode("TransactionType", oQuoteXml, oPclSchemeQuote.TransactionType)

                                oOptXform.addOption(oSelectElmt, oQuoteXml.OuterXml, oPclSchemeQuote.SchemeCode, True)

                                'set the paymentMethod in cart to Premium credit
                                If goRequest("cPaymentMethod") = oPclSchemeQuote.SchemeCode Then
                                    cPaymentMethod = "PremiumCredit"
                                End If

                            End If

                        Next
                    Else

                        Dim oPclTrans As New Protean.com.pclpls.www.XMLTransferEngine
                        Dim oPclQuotation As Protean.com.pclpls.www.Quotation
                        Dim oPclSchemeQuote As Protean.com.pclpls.www.SchemeQuote

                        Dim bOverrideRate As Boolean = IIf(oDictOpt("OverrideRate") = "true" Or oDictOpt("OverrideRate") = "True" Or oDictOpt("OverrideRate") = "on", True, False)

                        oPclQuotation = oPclTrans.GetQuote(oDictOpt("UserName"), oDictOpt("Password"), Protean.com.pclpls.www.eTransactionType.NewBusiness, nClientPremium, oDictOpt("PPICode"), oDictOpt("ChargePercentage"), bOverrideRate)

                        For Each oPclSchemeQuote In oPclQuotation.SchemeQuotes
                            If oPclSchemeQuote.SchemeCode = oDictOpt("SchemeCode") Then
                                Dim oQuoteXml As XmlElement = moPageXml.CreateElement("Quote")
                                Protean.Tools.Xml.addNewTextNode("APR", oQuoteXml, oPclSchemeQuote.APR)
                                Protean.Tools.Xml.addNewTextNode("APRNoMSC", oQuoteXml, oPclSchemeQuote.APRNoMSC)
                                Protean.Tools.Xml.addNewTextNode("BasicServiceChargePercentage", oQuoteXml, oPclSchemeQuote.BasicServiceChargePercentage)
                                Protean.Tools.Xml.addNewTextNode("CCAScheme", oQuoteXml, oPclSchemeQuote.CCAScheme)
                                Protean.Tools.Xml.addNewTextNode("DefaultPeriod", oQuoteXml, oPclSchemeQuote.DefaultPeriod)
                                Protean.Tools.Xml.addNewTextNode("Instalment", oQuoteXml, oPclSchemeQuote.Instalment)
                                Protean.Tools.Xml.addNewTextNode("InstalmentGap", oQuoteXml, oPclSchemeQuote.InstalmentGap)
                                Protean.Tools.Xml.addNewTextNode("InstalmentHoliday", oQuoteXml, oPclSchemeQuote.InstalmentHoliday)
                                Protean.Tools.Xml.addNewTextNode("InstalmentNoMSC", oQuoteXml, oPclSchemeQuote.InstalmentNoMSC)
                                Protean.Tools.Xml.addNewTextNode("InstalmentUnit", oQuoteXml, oPclSchemeQuote.InstalmentUnit)
                                Protean.Tools.Xml.addNewTextNode("InstalmentWithPPI", oQuoteXml, oPclSchemeQuote.InstalmentWithPPI)
                                Protean.Tools.Xml.addNewTextNode("InterestFree", oQuoteXml, oPclSchemeQuote.InterestFree)
                                Protean.Tools.Xml.addNewTextNode("MinimumServiceCharge", oQuoteXml, oPclSchemeQuote.MinimumServiceCharge)
                                Protean.Tools.Xml.addNewTextNode("NumInstalments", oQuoteXml, oPclSchemeQuote.NumInstalments)
                                Protean.Tools.Xml.addNewTextNode("OverrideRate", oQuoteXml, oPclSchemeQuote.OverrideRate)
                                Protean.Tools.Xml.addNewTextNode("PlasmaMessages", oQuoteXml, oPclSchemeQuote.PlasmaMessages)
                                Protean.Tools.Xml.addNewTextNode("PPICode", oQuoteXml, oPclSchemeQuote.PPICode)
                                Protean.Tools.Xml.addNewTextNode("Premium", oQuoteXml, oPclSchemeQuote.Premium)
                                Protean.Tools.Xml.addNewTextNode("RequiredRate", oQuoteXml, oPclSchemeQuote.RequiredRate)
                                Protean.Tools.Xml.addNewTextNode("SchemeCode", oQuoteXml, oPclSchemeQuote.SchemeCode)
                                Protean.Tools.Xml.addNewTextNode("SchemeDefaultDeposit", oQuoteXml, oPclSchemeQuote.SchemeDefaultDeposit)
                                Protean.Tools.Xml.addNewTextNode("SchemeMinimumServiceCharge", oQuoteXml, oPclSchemeQuote.SchemeMinimumServiceCharge)
                                Protean.Tools.Xml.addNewTextNode("SchemeName", oQuoteXml, oPclSchemeQuote.SchemeName)
                                Protean.Tools.Xml.addNewTextNode("SchemeType", oQuoteXml, oPclSchemeQuote.SchemeType)
                                Protean.Tools.Xml.addNewTextNode("ServiceChargePercentage", oQuoteXml, oPclSchemeQuote.ServiceChargePercentage)
                                Protean.Tools.Xml.addNewTextNode("ServiceChargePercentageNoMSC", oQuoteXml, oPclSchemeQuote.ServiceChargePercentageNoMSC)
                                Protean.Tools.Xml.addNewTextNode("TotalPayable", oQuoteXml, oPclSchemeQuote.TotalPayable)
                                Protean.Tools.Xml.addNewTextNode("TotalPayableNoMSC", oQuoteXml, oPclSchemeQuote.TotalPayableNoMSC)
                                Protean.Tools.Xml.addNewTextNode("TotalPayableWithPPI", oQuoteXml, oPclSchemeQuote.TotalPayableWithPPI)
                                Protean.Tools.Xml.addNewTextNode("TransactionType", oQuoteXml, oPclSchemeQuote.TransactionType)

                                oOptXform.addOption(oSelectElmt, oQuoteXml.OuterXml, oPclSchemeQuote.SchemeCode, True)

                                'set the paymentMethod in cart to Premium credit
                                If goRequest("cPaymentMethod") = oPclSchemeQuote.SchemeCode Then
                                    cPaymentMethod = "PremiumCredit"
                                End If

                            End If

                        Next

                    End If

                    Return nOptCount

                Catch ex As Exception
                    returnException(mcModuleName, "getPremiumCreditPaymentMethods", ex, "", cProcessInfo, gbDebug)
                    Return Nothing
                End Try
            End Function

        End Class

    End Class
End Class
